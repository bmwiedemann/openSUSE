From 27eb171c805eedcd121d174c5d89d5eb2f15a045 Mon Sep 17 00:00:00 2001
From: Jonathan Kang <jonathankang@gnome.org>
Date: Tue, 2 Aug 2022 09:23:18 +0800
Subject: [PATCH] zypp: build the pool before calling is_tumbleweed()

This makes sure that is_tumbleweed() returns the correct result.
---
 backends/zypp/pk-backend-zypp.cpp | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index ecdfc9c89..62adbb8be 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -3563,6 +3563,10 @@ pk_backend_upgrade_system_thread (PkBackendJob *job,
 		return;
 	}
 
+	ResPool pool = zypp_build_pool (zypp, TRUE);
+	PkRestartEnum restart = PK_RESTART_ENUM_NONE;
+	PoolStatusSaver saver;
+
 	if (is_tumbleweed ()) {
 		pk_backend_job_error_code (job, PK_ERROR_ENUM_NOT_SUPPORTED,
 					   "upgrade-system is not supported in Tumbleweed, use \"pkcon update\" instead.");
@@ -3579,10 +3583,6 @@ pk_backend_upgrade_system_thread (PkBackendJob *job,
 		return;
     }
 
-	ResPool pool = zypp_build_pool (zypp, TRUE);
-	PkRestartEnum restart = PK_RESTART_ENUM_NONE;
-	PoolStatusSaver saver;
-
 	/* Set environment variable ZYPP_REPO_RELEASEVER to target version. */
 	g_setenv ("ZYPP_REPO_RELEASEVER", release_ver, TRUE);
 
-- 
2.37.1

