Index: fcitx-libpinyin-0.5.3/CMakeLists.txt
===================================================================
--- fcitx-libpinyin-0.5.3.orig/CMakeLists.txt
+++ fcitx-libpinyin-0.5.3/CMakeLists.txt
@@ -11,6 +11,15 @@ find_package(GLIB2 REQUIRED)
 find_package(Libpinyin REQUIRED)
 find_package(DBus REQUIRED)
 
+set(LIBZHUYIN_DATABASE_FORMAT "KyotoCabinet" CACHE STRING "When can't detect dbformat fallback to this option")
+if (EXISTS ${LibZhuyin_LIBDIR}/libpinyin/data/table.conf)
+	file(STRINGS ${LibZhuyin_LIBDIR}/libpinyin/data/table.conf LIBPINYIN_DATABASE_FORMAT REGEX "database format")
+	set(DATABASE_FORMAT "${LIBPINYIN_DATABASE_FORMAT}")
+else()
+	message(WARNING "Could not detect database format for libpinyin, fallback to ${LIBZHUYIN_DATABASE_FORMAT}")
+	set(DATABASE_FORMAT "database format:${LIBZHUYIN_DATABASE_FORMAT}")
+endif()
+
 _fcitx_add_uninstall_target()
 
 set(CMAKE_C_FLAGS "-Wall -Wextra -Wno-sign-compare -Wno-unused-parameter -fvisibility=hidden ${CMAKE_C_FLAGS}")
Index: fcitx-libpinyin-0.5.3/data/CMakeLists.txt
===================================================================
--- fcitx-libpinyin-0.5.3.orig/data/CMakeLists.txt
+++ fcitx-libpinyin-0.5.3/data/CMakeLists.txt
@@ -23,7 +23,7 @@ set(ZHUYIN_ORGDATA ${_LIBPINYIN_TABLE_FI
 set(ZHUYIN_DATA bigram.db ${_LIBPINYIN_BIN_FILES}  phrase_index.bin
                 pinyin_index.bin addon_phrase_index.bin addon_pinyin_index.bin)
 
-configure_file(${CMAKE_CURRENT_SOURCE_DIR}/table.conf ${CMAKE_CURRENT_BINARY_DIR}/table.conf COPYONLY)
+configure_file(${CMAKE_CURRENT_SOURCE_DIR}/table.conf.in ${CMAKE_CURRENT_BINARY_DIR}/table.conf @ONLY)
 
 fcitx_download(zhuyin_data_tar "${ZHUYIN_URL}" "${ZHUYIN_DATA_FILE_NAME}"
   MD5SUM f657ea2e9091e35021037ef4ce796e1d)
@@ -47,7 +47,7 @@ install(FILES ${CMAKE_CURRENT_BINARY_DIR
               ${CMAKE_CURRENT_BINARY_DIR}/pinyin_index.bin
               ${CMAKE_CURRENT_BINARY_DIR}/addon_phrase_index.bin
               ${CMAKE_CURRENT_BINARY_DIR}/addon_pinyin_index.bin
-              table.conf
+	      ${CMAKE_CURRENT_BINARY_DIR}/table.conf
         DESTINATION ${FCITX_LIBPINYIN_ZHUYIN_DATADIR})
 
 endif()
Index: fcitx-libpinyin-0.5.3/data/table.conf
===================================================================
--- fcitx-libpinyin-0.5.3.orig/data/table.conf
+++ /dev/null
@@ -1,25 +0,0 @@
-binary format version:5
-model data version:10
-lambda parameter:0.347121
-
-source table format:pinyin
-
-default RESERVED NULL NULL NULL NOT_USED
-default GB_DICTIONARY gb_char.table gb_char.bin gb_char.dbin SYSTEM_FILE
-default GBK_DICTIONARY gbk_char.table gbk_char.bin gbk_char.dbin SYSTEM_FILE
-default MERGED_DICTIONARY merged.table merged.bin merged.dbin SYSTEM_FILE
-default ADDON_DICTIONARY NULL NULL addon.bin USER_FILE
-default NETWORK_DICTIONARY NULL NULL network.bin USER_FILE
-default USER_DICTIONARY NULL NULL user.bin USER_FILE
-
-addon 4 art.table art.bin NULL DICTIONARY
-addon 5 culture.table culture.bin NULL DICTIONARY
-addon 6 economy.table economy.bin NULL DICTIONARY
-addon 7 geology.table geology.bin NULL DICTIONARY
-addon 8 history.table history.bin NULL DICTIONARY
-
-addon 9 life.table life.bin NULL DICTIONARY
-addon 10 nature.table nature.bin NULL DICTIONARY
-addon 11 scitech.table scitech.bin NULL DICTIONARY
-addon 12 society.table society.bin NULL DICTIONARY
-addon 13 sport.table sport.bin NULL DICTIONARY
Index: fcitx-libpinyin-0.5.3/data/table.conf.in
===================================================================
--- /dev/null
+++ fcitx-libpinyin-0.5.3/data/table.conf.in
@@ -0,0 +1,25 @@
+binary format version:5
+model data version:10
+lambda parameter:0.347121
+
+source table format:pinyin
+@DATABASE_FORMAT@
+default RESERVED NULL NULL NULL NOT_USED
+default GB_DICTIONARY gb_char.table gb_char.bin gb_char.dbin SYSTEM_FILE
+default GBK_DICTIONARY gbk_char.table gbk_char.bin gbk_char.dbin SYSTEM_FILE
+default MERGED_DICTIONARY merged.table merged.bin merged.dbin SYSTEM_FILE
+default ADDON_DICTIONARY NULL NULL addon.bin USER_FILE
+default NETWORK_DICTIONARY NULL NULL network.bin USER_FILE
+default USER_DICTIONARY NULL NULL user.bin USER_FILE
+
+addon 4 art.table art.bin NULL DICTIONARY
+addon 5 culture.table culture.bin NULL DICTIONARY
+addon 6 economy.table economy.bin NULL DICTIONARY
+addon 7 geology.table geology.bin NULL DICTIONARY
+addon 8 history.table history.bin NULL DICTIONARY
+
+addon 9 life.table life.bin NULL DICTIONARY
+addon 10 nature.table nature.bin NULL DICTIONARY
+addon 11 scitech.table scitech.bin NULL DICTIONARY
+addon 12 society.table society.bin NULL DICTIONARY
+addon 13 sport.table sport.bin NULL DICTIONARY
