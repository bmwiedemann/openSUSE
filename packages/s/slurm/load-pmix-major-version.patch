From dfc32b8dd2e5899b191cf680105a52748d8ea359 Mon Sep 17 00:00:00 2001
From: Christian Goll <cgoll@suse.de>
Date: Tue, 23 Feb 2021 13:45:11 +0100
Subject: [PATCH] load pmix major version

---
 src/plugins/mpi/pmix/mpi_pmix.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/plugins/mpi/pmix/mpi_pmix.c b/src/plugins/mpi/pmix/mpi_pmix.c
index 69c5191112..bdbf011162 100644
--- a/src/plugins/mpi/pmix/mpi_pmix.c
+++ b/src/plugins/mpi/pmix/mpi_pmix.c
@@ -112,10 +112,14 @@ static void *_libpmix_open(void)
 	xstrfmtcat(full_path, "%s/", PMIXP_V2_LIBPATH);
 #elif defined PMIXP_V3_LIBPATH
 	xstrfmtcat(full_path, "%s/", PMIXP_V3_LIBPATH);
+#define PMIX_SO_STRING ".2"
 #endif
 	xstrfmtcat(full_path, "libpmix.so");
-
-	lib_plug = dlopen(full_path, RTLD_LAZY | RTLD_GLOBAL);
+#ifdef PMIX_SO_STRING
+  lib_plug = dlopen("libpmix.so"PMIX_SO_STRING, RTLD_LAZY | RTLD_GLOBAL);
+  if(!lib_plug)
+#endif
+    lib_plug = dlopen(full_path, RTLD_LAZY | RTLD_GLOBAL);
 	xfree(full_path);
 
 	if (lib_plug && (HAVE_PMIX_VER != pmixp_lib_get_version())) {
-- 
2.26.2

