From fecffebc9a0f4e2309e9d8d561c0b0c4b6678b0b Mon Sep 17 00:00:00 2001
From: Franck Bui <fbui@suse.com>
Date: Thu, 31 Mar 2022 11:17:10 +0200
Subject: [PATCH 1/1] meson: build kernel-install man page when necessary

---
 man/rules/meson.build             | 2 +-
 meson.build                       | 5 ++++-
 shell-completion/bash/meson.build | 2 +-
 shell-completion/zsh/meson.build  | 2 +-
 src/kernel-install/meson.build    | 2 --
 5 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/man/rules/meson.build b/man/rules/meson.build
index aaa69d3038..f10abdaf0d 100644
--- a/man/rules/meson.build
+++ b/man/rules/meson.build
@@ -30,7 +30,7 @@ manpages = [
  ['journalctl', '1', [], ''],
  ['journald.conf', '5', ['journald.conf.d', 'journald@.conf'], ''],
  ['kernel-command-line', '7', [], ''],
- ['kernel-install', '8', [], ''],
+ ['kernel-install', '8', [], 'ENABLE_KERNEL_INSTALL'],
  ['libudev', '3', [], ''],
  ['loader.conf', '5', [], 'HAVE_GNU_EFI'],
  ['locale.conf', '5', [], ''],
diff --git a/meson.build b/meson.build
index e68791b8b4..311895db5e 100644
--- a/meson.build
+++ b/meson.build
@@ -1675,6 +1675,9 @@ else
 endif
 conf.set10('ENABLE_IMPORTD', have)
 
+want_kernel_install = get_option('kernel-install')
+conf.set10('ENABLE_KERNEL_INSTALL', want_kernel_install)
+
 want_homed = get_option('homed')
 if want_homed != 'false'
         have = (conf.get('HAVE_OPENSSL') == 1 and
@@ -4143,7 +4146,7 @@ foreach tuple : [
         ['hwdb'],
         ['importd'],
         ['initrd'],
-        ['kernel-install',        get_option('kernel-install')],
+        ['kernel-install'],
         ['localed'],
         ['logind'],
         ['machined'],
diff --git a/shell-completion/bash/meson.build b/shell-completion/bash/meson.build
index 963a11b6ce..ae6a61e555 100644
--- a/shell-completion/bash/meson.build
+++ b/shell-completion/bash/meson.build
@@ -31,7 +31,7 @@ items = [['busctl',              ''],
          ['systemd-path',        ''],
          ['systemd-run',         ''],
          ['udevadm',             ''],
-         ['kernel-install',      ''],
+         ['kernel-install',      'ENABLE_KERNEL_INSTALL'],
          ['bootctl',             'HAVE_GNU_EFI'],
          ['coredumpctl',         'ENABLE_COREDUMP'],
          ['homectl',             'ENABLE_HOMED'],
diff --git a/shell-completion/zsh/meson.build b/shell-completion/zsh/meson.build
index 6dca9dd595..bac531798c 100644
--- a/shell-completion/zsh/meson.build
+++ b/shell-completion/zsh/meson.build
@@ -22,7 +22,7 @@ items = [['_busctl',                   ''],
          ['_systemd-path',             ''],
          ['_systemd-run',              ''],
          ['_udevadm',                  ''],
-         ['_kernel-install',           ''],
+         ['_kernel-install',           'ENABLE_KERNEL_INSTALL'],
          ['_sd_hosts_or_user_at_host', ''],
          ['_sd_outputmodes',           ''],
          ['_sd_unit_files',            ''],
diff --git a/src/kernel-install/meson.build b/src/kernel-install/meson.build
index 508058f1cf..abc3520b62 100644
--- a/src/kernel-install/meson.build
+++ b/src/kernel-install/meson.build
@@ -1,7 +1,5 @@
 # SPDX-License-Identifier: LGPL-2.1-or-later
 
-want_kernel_install = get_option('kernel-install')
-
 if want_kernel_install
         install_data('kernel-install',
                      install_mode : 'rwxr-xr-x',
-- 
2.34.1

