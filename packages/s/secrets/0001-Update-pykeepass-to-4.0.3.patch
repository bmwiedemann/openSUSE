From 7ae6e1574343f46a6ed42b4c4625a07aeffd226c Mon Sep 17 00:00:00 2001
From: Maximiliano Sandoval R <msandova@protonmail.com>
Date: Mon, 4 Jul 2022 19:34:39 +0200
Subject: [PATCH] Update pykeepass to 4.0.3

---
 flatpak/python3-pykeepass.json | 4 ++--
 gsecrets/safe_element.py       | 8 ++++----
 meson.build                    | 2 +-
 3 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/flatpak/python3-pykeepass.json b/flatpak/python3-pykeepass.json
index 3d8ffda..6531f77 100644
--- a/flatpak/python3-pykeepass.json
+++ b/flatpak/python3-pykeepass.json
@@ -7,8 +7,8 @@
     "sources": [
         {
             "type": "file",
-            "url": "https://files.pythonhosted.org/packages/f1/08/b4b8f7bce23190ed4f34f4d9cf4f75f8a255f4f4c378296daf4b7027d2cb/pykeepass-4.0.1.tar.gz",
-            "sha256": "eaa2a016c15a81beb6e253a8cb1fe64738b5fb4a28389dcdba621ea538dd814b"
+            "url": "https://files.pythonhosted.org/packages/76/02/e29e09741cfe63ce6dbb55394024b8df7f4ffb8d9ad4a53a935feb58b28f/pykeepass-4.0.3.tar.gz",
+            "sha256": "677095f700e7f1445dd31fa43863462979e7d360aee2529e72cc216003fd7ab5"
         }
     ],
     "modules": [
diff --git a/gsecrets/safe_element.py b/gsecrets/safe_element.py
index 3ab22ac..b4c6f89 100644
--- a/gsecrets/safe_element.py
+++ b/gsecrets/safe_element.py
@@ -327,8 +327,7 @@ class SafeEntry(SafeElement):
         self._url: str = entry.url or ""
         self._username: str = entry.username or ""
 
-        otp_uri = entry.get_custom_property("otp")
-        if otp_uri:
+        if (otp_uri := entry.otp):
             try:
                 self._otp = parse_uri(otp_uri)
             except ValueError as err:
@@ -536,7 +535,8 @@ class SafeEntry(SafeElement):
         if not otp and self._otp:
             # Delete existing
             self._otp = None
-            self._element.delete_custom_property("otp")
+            # NOTE the opt property doesn't accept None.
+            self._element.otp = ""
             self.updated()
         elif self._otp and self._otp.secret != otp:
             # Changing an existing OTP
@@ -548,7 +548,7 @@ class SafeEntry(SafeElement):
             updated = True
 
         if updated:
-            self._element.set_custom_property("otp", self._otp.provisioning_uri())
+            self._element.otp = self._otp.provisioning_uri()
             self.updated()
 
     def otp_interval(self) -> int:
diff --git a/meson.build b/meson.build
index 77073a1..6249a1a 100644
--- a/meson.build
+++ b/meson.build
@@ -26,7 +26,7 @@ artists = '\n'.join([
                    ])
 
 message('Looking for dependencies')
-# We need pykeepass>=4.0.1 and pyotp>=2.4.0.
+# We need pykeepass>=4.0.3 and pyotp>=2.4.0.
 python_bin = python.find_installation('python3', modules:['pykeepass', 'pyotp'])
 if not python_bin.found()
   error('No valid python3 binary found')
-- 
2.37.1

