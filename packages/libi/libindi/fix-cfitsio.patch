From 0fbc934a362f77a4d89f7147a04cb97671dae57f Mon Sep 17 00:00:00 2001
From: Ludovic P <pludov@nnx.com>
Date: Mon, 15 Aug 2022 00:41:05 +0200
Subject: [PATCH 1/2] Don't tell cfitsio about preallocated buffers

---
 libs/indibase/indiccdchip.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/libs/indibase/indiccdchip.cpp b/libs/indibase/indiccdchip.cpp
index 6c001a6d8f..03e9b9aa0a 100644
--- a/libs/indibase/indiccdchip.cpp
+++ b/libs/indibase/indiccdchip.cpp
@@ -39,8 +39,8 @@ CCDChip::~CCDChip()
 
 bool CCDChip::openFITSFile(uint32_t size, int &status)
 {
-    m_FITSMemorySize = size;
-    m_FITSMemoryBlock = IDSharedBlobAlloc(m_FITSMemorySize);
+    m_FITSMemorySize = size > 2880 ? 2880 : size;
+    m_FITSMemoryBlock = IDSharedBlobAlloc(size);
     if (m_FITSMemoryBlock == nullptr)
     {
         IDLog("Failed to allocate memory for FITS file.");

From 7dcac52aa5a5c27fcfb001ee8ab162a2506e703e Mon Sep 17 00:00:00 2001
From: Ludovic P <pludov@nnx.com>
Date: Mon, 15 Aug 2022 01:27:01 +0200
Subject: [PATCH 2/2] Workaround for cfitsio doing realloc memory after
 flush...

---
 libs/indibase/indiccd.cpp     |  3 +--
 libs/indibase/indiccdchip.cpp | 20 ++++++++++++++++----
 libs/indibase/indiccdchip.h   | 10 ++++++++--
 3 files changed, 25 insertions(+), 8 deletions(-)

diff --git a/libs/indibase/indiccd.cpp b/libs/indibase/indiccd.cpp
index 06c26cd86d..39c82b9575 100644
--- a/libs/indibase/indiccd.cpp
+++ b/libs/indibase/indiccd.cpp
@@ -2282,8 +2282,7 @@ bool CCD::ExposureCompletePrivate(CCDChip * targetChip)
             addFITSKeywords(targetChip);
 
             fits_write_img(fptr, byte_type, 1, nelements, targetChip->getFrameBuffer(), &status);
-            fits_flush_file(fptr, &status);
-
+            targetChip->finishFITSFile(status);
             if (status)
             {
                 fits_report_error(stderr, status); /* print out any error messages */
diff --git a/libs/indibase/indiccdchip.cpp b/libs/indibase/indiccdchip.cpp
index 03e9b9aa0a..fd90926cfb 100644
--- a/libs/indibase/indiccdchip.cpp
+++ b/libs/indibase/indiccdchip.cpp
@@ -58,14 +58,26 @@ bool CCDChip::openFITSFile(uint32_t size, int &status)
     return (status == 0);
 }
 
-bool CCDChip::closeFITSFile()
+bool CCDChip::finishFITSFile(int &status)
 {
-    int status = 0;
+    fits_flush_file(m_FITSFilePointer, &status);
     fits_close_file(m_FITSFilePointer, &status);
-    m_FITSFilePointer = nullptr;
+    if (status == 0) {
+        m_FITSFilePointer = nullptr;
+    }
+    return (status == 0);
+}
+
+void CCDChip::closeFITSFile()
+{
+    if (m_FITSFilePointer != nullptr) {
+        int status = 0;
+        // Discard error here, the caller can't expect a valid file anymore at that point
+        fits_close_file(m_FITSFilePointer, &status);
+        m_FITSFilePointer = nullptr;
+    }
     IDSharedBlobFree(m_FITSMemoryBlock);
     m_FITSMemoryBlock = nullptr;
-    return (status == 0);
 }
 
 void CCDChip::setFrameType(CCD_FRAME type)
diff --git a/libs/indibase/indiccdchip.h b/libs/indibase/indiccdchip.h
index f4a79fe974..8a39e5753d 100644
--- a/libs/indibase/indiccdchip.h
+++ b/libs/indibase/indiccdchip.h
@@ -57,11 +57,17 @@ class CCDChip
          */
         bool openFITSFile(uint32_t size, int &status);
 
+
         /**
-         * @brief closeFITSFile Close the in-memory FITS File.
+         * @brief Finish any pending write to fits file.
          * @return True if successful, false otherwise.
          */
-        bool closeFITSFile();
+        bool finishFITSFile(int &status);
+
+        /**
+         * @brief closeFITSFile Close the in-memory FITS File.
+         */
+        void closeFITSFile();
 
         /**
          * @brief getXRes Get the horizontal resolution in pixels of the CCD Chip.
