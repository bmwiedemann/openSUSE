From 6ebb4b4d397d29f8cf2bc2f2c4c2e81fcd060253 Mon Sep 17 00:00:00 2001
From: Bruno Pitrus <brunopitrus@hotmail.com>
Date: Sat, 17 Sep 2022 20:43:39 +0000
Subject: [PATCH] Add missing libraries to Abseil shim

This is needed to build Chromium 102 or newer with system Abseil.

Change-Id: I724367416b59637a77c7bb6d24a201fa83057dc7
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/3902464
Reviewed-by: Thomas Anderson <thomasanderson@chromium.org>
Commit-Queue: Thomas Anderson <thomasanderson@chromium.org>
Auto-Submit: Bruno Pitrus <brunopitrus@hotmail.com>
Cr-Commit-Position: refs/heads/main@{#1048414}
---
 build/linux/unbundle/absl_functional.gn  | 15 +++++++++++++++
 build/linux/unbundle/absl_utility.gn     | 17 +++++++++++++++++
 build/linux/unbundle/replace_gn_files.py |  3 ++-
 3 files changed, 34 insertions(+), 1 deletion(-)
 create mode 100644 build/linux/unbundle/absl_utility.gn

diff --git a/build/linux/unbundle/absl_utility.gn b/build/linux/unbundle/absl_utility.gn
new file mode 100644
index 0000000000000..8dda6ed01afa1
--- /dev/null
+++ b/build/linux/unbundle/absl_utility.gn
@@ -0,0 +1,17 @@
+import("//build/config/linux/pkg_config.gni")
+import("//build/shim_headers.gni")
+
+pkg_config("system_absl_utility") {
+  packages = [ "absl_utility" ]
+}
+
+shim_headers("utility_shim") {
+  root_path = "."
+  prefix = "absl/utility/"
+  headers = [ "utility.h" ]
+}
+
+source_set("utility") {
+  deps = [ ":utility_shim" ]
+  public_configs = [ ":system_absl_utility" ]
+}
diff --git a/build/linux/unbundle/replace_gn_files.py b/build/linux/unbundle/replace_gn_files.py
index e921ec57f9c1d..6b57c1955e60b 100755
--- a/build/linux/unbundle/replace_gn_files.py
+++ b/build/linux/unbundle/replace_gn_files.py
@@ -15,7 +15,7 @@
 
 
 REPLACEMENTS = {
-  # Use system libabsl_2xxx. These 17 shims MUST be used together.
+  # Use system libabsl_2xxx. These 18 shims MUST be used together.
   'absl_algorithm': 'third_party/abseil-cpp/absl/algorithm/BUILD.gn',
   'absl_base': 'third_party/abseil-cpp/absl/base/BUILD.gn',
   'absl_cleanup': 'third_party/abseil-cpp/absl/cleanup/BUILD.gn',
@@ -33,6 +33,7 @@
   'absl_synchronization': 'third_party/abseil-cpp/absl/synchronization/BUILD.gn',
   'absl_time': 'third_party/abseil-cpp/absl/time/BUILD.gn',
   'absl_types': 'third_party/abseil-cpp/absl/types/BUILD.gn',
+  'absl_utility': 'third_party/abseil-cpp/absl/utility/BUILD.gn',
   #
   'brotli': 'third_party/brotli/BUILD.gn',
   'crc32c': 'third_party/crc32c/BUILD.gn',
--- src/build/linux/unbundle/absl_base.gn.old	2022-09-27 10:37:01.546436600 +0200
+++ src/build/linux/unbundle/absl_base.gn	2022-09-27 18:15:13.664636500 +0200
@@ -62,3 +62,6 @@
 
 source_set("config_test") {
 }
+
+source_set("prefetch_test") {
+}
--- src/build/linux/unbundle/absl_functional.gn.old	2022-09-27 10:37:01.546436600 +0200
+++ src/build/linux/unbundle/absl_functional.gn	2022-09-27 18:17:20.334173300 +0200
@@ -15,3 +15,36 @@
   deps = [ ":bind_front_shim" ]
   public_configs = [ ":system_absl_bind_front" ]
 }
+
+pkg_config("system_absl_function_ref") {
+  packages = [ "absl_function_ref" ]
+}
+
+shim_headers("function_ref_shim") {
+  root_path = "."
+  prefix = "absl/functional/"
+  headers = [ "function_ref.h" ]
+}
+
+source_set("function_ref") {
+  deps = [ ":function_ref_shim" ]
+  public_configs = [ ":system_absl_function_ref" ]
+}
+
+pkg_config("system_absl_any_invocable") {
+  packages = [ "absl_any_invocable" ]
+}
+
+shim_headers("any_invocable_shim") {
+  root_path = "."
+  prefix = "absl/functional/"
+  headers = [ "any_invocable.h" ]
+}
+
+source_set("any_invocable") {
+  deps = [ ":any_invocable_shim" ]
+  public_configs = [ ":system_absl_any_invocable" ]
+}
+
+source_set("any_invocable_test") {
+}
--- src/build/linux/unbundle/absl_strings.gn.old	2022-09-27 10:37:01.546436600 +0200
+++ src/build/linux/unbundle/absl_strings.gn	2022-09-27 18:17:44.553539300 +0200
@@ -61,6 +61,8 @@
 
 source_set("ascii_test") {
 }
+source_set("cord_buffer_test") {
+}
 source_set("cord_data_edge_test") {
 }
 source_set("cord_rep_btree_navigator_test") {
