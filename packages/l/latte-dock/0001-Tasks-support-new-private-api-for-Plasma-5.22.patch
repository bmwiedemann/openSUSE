From be510fdfe0e14eeb52bebdd31c21680849f6f013 Mon Sep 17 00:00:00 2001
From: Fabian Vogt <fabian@ritter-vogt.de>
Date: Mon, 17 May 2021 09:48:01 +0200
Subject: [PATCH] Tasks:support new private api for Plasma 5.22

Backport of 5e1758337cf0231ad53782f8fa92a1bb781a08d1.
---
 plasmoid/package/contents/ui/main.qml          | 7 ++++++-
 plasmoid/package/contents/ui/task/TaskItem.qml | 3 ++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/plasmoid/package/contents/ui/main.qml b/plasmoid/package/contents/ui/main.qml
index b430d558..78e93eda 100644
--- a/plasmoid/package/contents/ui/main.qml
+++ b/plasmoid/package/contents/ui/main.qml
@@ -67,6 +67,7 @@ Item {
 
     property bool plasma515: latteView ? latteView.plasma515 : Latte.WindowSystem.plasmaDesktopVersion >= Latte.WindowSystem.makeVersion(5,15,0)
     property bool plasma518: latteView ? latteView.plasma518 : Latte.WindowSystem.plasmaDesktopVersion >= Latte.WindowSystem.makeVersion(5,18,0)
+    property bool plasmaGreaterThan522: Latte.WindowSystem.plasmaDesktopVersion >= Latte.WindowSystem.makeVersion(5,21,75)
 
     property bool editMode: latteView ? latteView.editMode : plasmoid.userConfiguring
     property bool inConfigureAppletsMode: latteView ? latteView.inConfigureAppletsMode : true
@@ -823,7 +824,6 @@ Item {
         id: backend
 
         taskManagerItem: root
-        toolTipItem: toolTipDelegate
         highlightWindows: root.highlightWindows
 
         onAddLauncher: {
@@ -840,6 +840,11 @@ Item {
             if (Latte.WindowSystem.frameworksVersion >= 335104 || (groupDialog !== undefined)) {
                 groupDialog = groupDialogGhost;
             }
+
+            //! In Plasma 5.22 toolTipItem was dropped
+            if (!root.plasmaGreaterThan522) {
+                toolTipItem = toolTipDelegate;
+            }
         }
     }
 
diff --git a/plasmoid/package/contents/ui/task/TaskItem.qml b/plasmoid/package/contents/ui/task/TaskItem.qml
index 39c0b2de..45927aca 100644
--- a/plasmoid/package/contents/ui/task/TaskItem.qml
+++ b/plasmoid/package/contents/ui/task/TaskItem.qml
@@ -1016,7 +1016,8 @@ MouseArea{
         }
         else{
             if (model.IsGroupParent) {
-                if (Latte.WindowSystem.compositingActive && backend.canPresentWindows()) {
+                var canPresentWindowsIsSupported = Latte.WindowSystem.compositingActive && (root.plasmaGreaterThan522 ? backend.canPresentWindows : backend.canPresentWindows());
+                if (canPresentWindowsIsSupported) {
                     root.presentWindows(root.plasma515 ? model.WinIdList: model.LegacyWinIdList );
                 }
             } else {
-- 
2.25.1

