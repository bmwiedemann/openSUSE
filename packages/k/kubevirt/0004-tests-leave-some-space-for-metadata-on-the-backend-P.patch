From 7eeb9001226bde307420ab6e92a45520ff508ef6 Mon Sep 17 00:00:00 2001
From: Alice Frosi <afrosi@redhat.com>
Date: Mon, 19 Jun 2023 12:41:49 +0200
Subject: [PATCH 1/2] tests: fix error print on Expect

Signed-off-by: Alice Frosi <afrosi@redhat.com>
---
 tests/storage/reservation.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/tests/storage/reservation.go b/tests/storage/reservation.go
index a09853060..527f6f42e 100644
--- a/tests/storage/reservation.go
+++ b/tests/storage/reservation.go
@@ -70,7 +70,7 @@ var _ = SIGDescribe("[Serial]SCSI persistent reservation", Serial, func() {
 		Expect(err).ToNot(HaveOccurred())
 
 		stdout, stderr, err := exec.ExecuteCommandOnPodWithResults(virtClient, pod, "targetcli", cmd)
-		Expect(err).ToNot(HaveOccurred(), stdout, stderr)
+		Expect(err).ToNot(HaveOccurred(), fmt.Sprintf("command='targetcli %v' stdout='%s' stderr='%s'", args, stdout, stderr))
 	}
 
 	// createSCSIDisk creates a SCSI using targetcli utility and LinuxIO (see
-- 
2.41.0


From 56b50ec639a6870616d3bc09a21a7c6c3993ec6d Mon Sep 17 00:00:00 2001
From: Alice Frosi <afrosi@redhat.com>
Date: Tue, 20 Jun 2023 12:21:08 +0200
Subject: [PATCH 2/2] tests: leave some space for metadata on the backend PVC

In certain case, the targetcli backstores/fileio create command fails
with:
 Could not expand file to 1073741824 bytes

We can try to avoid this issue by creating a smaller backend image. We
simply hardcoded 800M instead of 1G as in these tests the size of the
disk doesn't matter. This is used to test the SCSI persistent
reservation ioctls.

Signed-off-by: Alice Frosi <afrosi@redhat.com>
---
 tests/storage/reservation.go | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/tests/storage/reservation.go b/tests/storage/reservation.go
index 527f6f42e..6410f0d64 100644
--- a/tests/storage/reservation.go
+++ b/tests/storage/reservation.go
@@ -94,10 +94,13 @@ var _ = SIGDescribe("[Serial]SCSI persistent reservation", Serial, func() {
 		By(fmt.Sprintf("ldconfig: stdout: %v stderr: %v", stdout, stderr))
 		Expect(err).ToNot(HaveOccurred())
 
-		// Create backend file
+		// Create backend file. Let some room for metedata and create a
+		// slightly smaller backend image, we use 800M instead of 1G. In
+		// this case, the disk size doesn't matter as the disk is used
+		// mostly to test the SCSI persistent reservation ioctls.
 		executeTargetCli(podName, []string{
 			"backstores/fileio",
-			"create", backendDisk, "/disks/disk.img", "1G"})
+			"create", backendDisk, "/disks/disk.img", "800M"})
 		executeTargetCli(podName, []string{
 			"loopback/", "create", naa})
 		// Create LUN
-- 
2.41.0

