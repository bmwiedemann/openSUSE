From 77bd7c8a8b29dced5a06c232485ab6de1306c087 Mon Sep 17 00:00:00 2001
From: Weinong Wang <weinong@outlook.com>
Date: Tue, 31 Mar 2020 15:59:37 -0700
Subject: [PATCH] fix a bug where spn: prefix is unexpectedly added to
 kubeconfig apiserver-id setting

---
 .../plugin/pkg/client/auth/azure/azure.go     |   5 +-
 .../pkg/client/auth/azure/azure_test.go       | 142 ++++++++++++------
 2 files changed, 103 insertions(+), 44 deletions(-)

diff --git a/staging/src/k8s.io/client-go/plugin/pkg/client/auth/azure/azure.go b/staging/src/k8s.io/client-go/plugin/pkg/client/auth/azure/azure.go
index 2746536b2a6e5..fded604a3c7db 100644
--- a/staging/src/k8s.io/client-go/plugin/pkg/client/auth/azure/azure.go
+++ b/staging/src/k8s.io/client-go/plugin/pkg/client/auth/azure/azure.go
@@ -307,8 +307,9 @@ func (ts *azureTokenSource) retrieveTokenFromCfg() (*azureToken, error) {
 	if expiresOn == "" {
 		return nil, fmt.Errorf("no expiresOn in cfg: %s", cfgExpiresOn)
 	}
+	tokenAudience := resourceID
 	if ts.configMode == configModeDefault {
-		resourceID = fmt.Sprintf("spn:%s", resourceID)
+		tokenAudience = fmt.Sprintf("spn:%s", resourceID)
 	}
 
 	return &azureToken{
@@ -318,7 +319,7 @@ func (ts *azureTokenSource) retrieveTokenFromCfg() (*azureToken, error) {
 			ExpiresIn:    json.Number(expiresIn),
 			ExpiresOn:    json.Number(expiresOn),
 			NotBefore:    json.Number(expiresOn),
-			Resource:     resourceID,
+			Resource:     tokenAudience,
 			Type:         tokenType,
 		},
 		environment: environment,
