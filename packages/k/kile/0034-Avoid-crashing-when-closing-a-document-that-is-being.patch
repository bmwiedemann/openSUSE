From 62232952aa222189db39b6024bd8bbb0ccebe211 Mon Sep 17 00:00:00 2001
From: Michel Ludwig <michel.ludwig@kdemail.net>
Date: Sun, 24 Feb 2019 20:46:02 +0100
Subject: [PATCH 34/35] Avoid crashing when closing a document that is being
 parsed

BUG: 404164
---
 src/parser/latexparser.cpp | 4 +++-
 src/parser/latexparser.h   | 4 ++--
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/parser/latexparser.cpp b/src/parser/latexparser.cpp
index 8390aba1..685f2742 100644
--- a/src/parser/latexparser.cpp
+++ b/src/parser/latexparser.cpp
@@ -1,7 +1,7 @@
 /**********************************************************************************
 *   Copyright (C) 2003 by Jeroen Wijnhout (Jeroen.Wijnhout@kdemail.net)           *
 *                 2005-2007 by Holger Danielsson (holger.danielsson@versanet.de)  *
-*                 2006-2017 by Michel Ludwig (michel.ludwig@kdemail.net)          *
+*                 2006-2019 by Michel Ludwig (michel.ludwig@kdemail.net)          *
 ***********************************************************************************/
 
 /***************************************************************************
@@ -33,6 +33,8 @@ LaTeXParserInput::LaTeXParserInput(const QUrl &url, QStringList textLines,
     : ParserInput(url),
       textLines(textLines),
       extensions(extensions),
+      // make a copy here as otherwise the parsing of a document that is being closed
+      // can lead to a crash:
       dictStructLevel(dictStructLevel),
       showSectioningLabels(showSectioningLabels),
       showStructureTodo(showStructureTodo)
diff --git a/src/parser/latexparser.h b/src/parser/latexparser.h
index d12a72bc..c5730491 100644
--- a/src/parser/latexparser.h
+++ b/src/parser/latexparser.h
@@ -1,5 +1,5 @@
 /**************************************************************************
-*   Copyright (C) 2011 by Michel Ludwig (michel.ludwig@kdemail.net)       *
+*   Copyright (C) 2011-2019 by Michel Ludwig (michel.ludwig@kdemail.net)       *
 ***************************************************************************/
 
 /***************************************************************************
@@ -41,7 +41,7 @@ public:
 
     QStringList textLines;
     KileDocument::Extensions *extensions;
-    const QMap<QString, KileStructData>& dictStructLevel;
+    const QMap<QString, KileStructData> dictStructLevel;
     bool showSectioningLabels;
     bool showStructureTodo;
 };
-- 
2.20.1

