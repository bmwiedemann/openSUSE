From 1dbdae3e9082b76be49b9644b5d6669465b03c95 Mon Sep 17 00:00:00 2001
From: Jasem Mutlaq <mutlaqja@ikarustech.com>
Date: Sun, 5 Feb 2023 11:08:18 +0300
Subject: [PATCH] Use indi_timestamp from INDI GIT

---
 kstars/ekos/align/remoteastrometryparser.cpp |  2 +-
 kstars/indi/indiproperty.cpp                 | 36 ++------------------
 2 files changed, 3 insertions(+), 35 deletions(-)

diff --git a/kstars/ekos/align/remoteastrometryparser.cpp b/kstars/ekos/align/remoteastrometryparser.cpp
index 8da379886..0d347db72 100644
--- a/kstars/ekos/align/remoteastrometryparser.cpp
+++ b/kstars/ekos/align/remoteastrometryparser.cpp
@@ -93,7 +93,7 @@ bool RemoteAstrometryParser::startSolver(const QString &filename, const QStringL
     solverRunning = true;
 
     m_RemoteAstrometry->getDriverInfo()->getClientManager()->startBlob(solverBLOB->getDeviceName(), solverBLOB->getName(),
-            timestamp());
+            indi_timestamp());
 
     m_RemoteAstrometry->getDriverInfo()->getClientManager()->sendOneBlob(bp);
 
diff --git a/kstars/indi/indiproperty.cpp b/kstars/indi/indiproperty.cpp
index 1a5f839b7..230d44493 100644
--- a/kstars/indi/indiproperty.cpp
+++ b/kstars/indi/indiproperty.cpp
@@ -552,8 +552,6 @@ void INDI_P::processSetButton()
 
 void INDI_P::sendBlob()
 {
-    //int index=0;
-    //bool openingTag=false;
     auto bvp = dataProp.getBLOB();
 
     if (!bvp)
@@ -561,44 +559,14 @@ void INDI_P::sendBlob()
 
     bvp->setState(IPS_BUSY);
 
-    pg->getDevice()->getClientManager()->startBlob(bvp->getDeviceName(), bvp->getName(), timestamp());
+    pg->getDevice()->getClientManager()->startBlob(bvp->getDeviceName(), bvp->getName(), indi_timestamp());
 
     for (int i = 0; i < elementList.count(); i++)
     {
-        INDI::WidgetView<IBLOB> *bp = bvp->at(i);
-#if (INDI_VERSION_MINOR >= 4 && INDI_VERSION_RELEASE >= 2)
+        auto bp = bvp->at(i);
         pg->getDevice()->getClientManager()->sendOneBlob(bp);
-#else
-        pg->getDevice()->getClientManager()->sendOneBlob(bp->getName(), bp->getSize(), bp->getFormat(),
-                const_cast<void *>(bp->getBlob()));
-#endif
     }
 
-    // JM: Why we need dirty here? We should be able to upload multiple time
-    /*foreach(INDI_E *ep, elementList)
-    {
-        if (ep->getBLOBDirty() == true)
-        {
-
-            if (openingTag == false)
-            {
-                pg->getDevice()->getClientManager()->startBlob(bvp->device, bvp->name, timestamp());
-                openingTag = true;
-            }
-
-            IBLOB *bp = &(bvp->bp[index]);
-            ep->setBLOBDirty(false);
-
-            //qDebug() << Q_FUNC_INFO << "SENDING BLOB " << bp->name << " has size of " << bp->size << " and bloblen of " << bp->bloblen << Qt::endl;
-            pg->getDevice()->getClientManager()->sendOneBlob(bp->name, bp->size, bp->format, bp->blob);
-
-        }
-
-        index++;
-
-    }*/
-
-    //if (openingTag)
     pg->getDevice()->getClientManager()->finishBlob();
 
     updateStateLED();
-- 
GitLab


