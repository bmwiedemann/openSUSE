From 486b233c6a6c682ca5d1b691d2ff0d939618c9c7 Mon Sep 17 00:00:00 2001
From: Alok Kumar Singh <alok.singh@practo.com>
Date: Thu, 12 Mar 2020 10:33:38 +0530
Subject: [PATCH 1/3] Fixed the label for weave net selector

---
 jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet b/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
index 2f6f99a7..42928f6b 100644
--- a/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
+++ b/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
@@ -5,7 +5,7 @@ local servicePort = k.core.v1.service.mixin.spec.portsType;
 {
   prometheus+: {
     serviceWeaveNet:
-      service.new('weave-net', { 'k8s-app': 'weave-net' }, servicePort.newNamed('weave-net-metrics', 6782, 6782)) +
+      service.new('weave-net', { 'name': 'weave-net' }, servicePort.newNamed('weave-net-metrics', 6782, 6782)) +
       service.mixin.metadata.withNamespace('kube-system') +
       service.mixin.metadata.withLabels({ 'k8s-app': 'weave-net' }) +
       service.mixin.spec.withClusterIp('None'),

From 4ebc37e47b680f96b29a92acd4e6cdae33259843 Mon Sep 17 00:00:00 2001
From: Alok Kumar Singh <alok.singh@practo.com>
Date: Thu, 12 Mar 2020 10:40:06 +0530
Subject: [PATCH 2/3] Fixed the port name for weave-net metrics endpoint

---
 jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet b/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
index 42928f6b..c75587ab 100644
--- a/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
+++ b/jsonnet/kube-prometheus/kube-prometheus-weave-net.libsonnet
@@ -23,7 +23,7 @@ local servicePort = k.core.v1.service.mixin.spec.portsType;
         jobLabel: 'k8s-app',
         endpoints: [
           {
-            port: 'weave-metrics',
+            port: 'weave-net-metrics',
             path: '/metrics',
             interval: '15s',
           },

From 50ff549b5201242a7843227cea21b9da40697bb9 Mon Sep 17 00:00:00 2001
From: Alok Kumar Singh <alok.singh@practo.com>
Date: Thu, 12 Mar 2020 11:53:55 +0530
Subject: [PATCH 3/3] Updated the doc as grafana deployment needs modifications

Grafana deployment needs to modified for weave-net for mounting the
weave-net config maps volumes
---
 docs/weave-net-support.md | 1 +
 1 file changed, 1 insertion(+)

diff --git a/docs/weave-net-support.md b/docs/weave-net-support.md
index 8ba122a4..e7d87961 100644
--- a/docs/weave-net-support.md
+++ b/docs/weave-net-support.md
@@ -64,4 +64,5 @@ kubectl create -f prometheus-serviceWeaveNet.yaml
 kubectl create -f prometheus-serviceMonitorWeaveNet.yaml
 kubectl apply -f  prometheus-rules.yaml
 kubectl apply -f grafana-dashboardDefinitions.yaml
+kubectl apply -f grafana-deployment.yaml
 ```
