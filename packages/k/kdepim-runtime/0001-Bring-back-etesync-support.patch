From 6f4914ac93e939e0f83b32a2eefe5d7f012a029f Mon Sep 17 00:00:00 2001
From: Carl Schwan <carl@carlschwan.eu>
Date: Tue, 12 Mar 2024 10:30:40 +0100
Subject: [PATCH] Bring back etesync support

BUG: 482600
---
 CMakeLists.txt                         | 4 ++--
 resources/etesync/CMakeLists.txt       | 1 +
 resources/etesync/entriesfetchjob.cpp  | 5 +++--
 resources/etesync/journalsfetchjob.cpp | 5 +++--
 resources/etesync/loginjob.cpp         | 5 +++--
 5 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4f9d3c275..316bcceaf 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -66,7 +66,7 @@ set_package_properties(Qca-qt6 PROPERTIES DESCRIPTION "Qt Cryptographic Architec
                    URL "https://invent.kde.org/libraries/qca" TYPE REQUIRED
                    PURPOSE "Needed for ews resource.")
 option(KDEPIM_RUN_AKONADI_TEST "Enable autotest based on Akonadi." TRUE)
-# QT5 package
+# QT package
 find_package(Qt6TextToSpeech ${QT_REQUIRED_VERSION} CONFIG)
 set_package_properties(Qt6TextToSpeech PROPERTIES DESCRIPTION
     "Add support for texttospeech"
@@ -75,7 +75,7 @@ set_package_properties(Qt6TextToSpeech PROPERTIES DESCRIPTION
 if(Qt6TextToSpeech_FOUND)
 set(HAVE_TEXT_TO_SPEECH_SUPPORT TRUE)
 endif()
-find_package(Qt6 ${QT_REQUIRED_VERSION} CONFIG REQUIRED Network Widgets Test DBus NetworkAuth)
+find_package(Qt6 ${QT_REQUIRED_VERSION} CONFIG REQUIRED Network Widgets Test DBus NetworkAuth Concurrent)
 find_package(Qt6WebEngineWidgets ${QT_REQUIRED_VERSION} CONFIG)
 
 # KF6 package
diff --git a/resources/etesync/CMakeLists.txt b/resources/etesync/CMakeLists.txt
index 6a233f09b..2c16ff071 100644
--- a/resources/etesync/CMakeLists.txt
+++ b/resources/etesync/CMakeLists.txt
@@ -52,6 +52,7 @@ endif()
 target_link_libraries(akonadi_etesync_resource
     ${ETEBASE_LIBRARIES}
     Qt::DBus
+    Qt::Concurrent
     KPim6::AkonadiAgentBase
     KF6::ConfigCore
     KF6::Contacts
diff --git a/resources/etesync/entriesfetchjob.cpp b/resources/etesync/entriesfetchjob.cpp
index cab76cefc..e2081292e 100644
--- a/resources/etesync/entriesfetchjob.cpp
+++ b/resources/etesync/entriesfetchjob.cpp
@@ -10,7 +10,8 @@
 #include <KCalendarCore/Event>
 #include <KCalendarCore/Todo>
 #include <KContacts/Addressee>
-#include <QtConcurrent>
+#include <QFutureWatcher>
+#include <QtConcurrentRun>
 
 #include "etesync_debug.h"
 #include "settings.h"
@@ -39,7 +40,7 @@ void EntriesFetchJob::start()
         qCDebug(ETESYNC_LOG) << "emitResult from EntriesFetchJob";
         emitResult();
     });
-    QFuture<void> fetchEntriesFuture = QtConcurrent::run(this, &EntriesFetchJob::fetchEntries);
+    QFuture<void> fetchEntriesFuture = QtConcurrent::run(&EntriesFetchJob::fetchEntries, this);
     watcher->setFuture(fetchEntriesFuture);
 }
 
diff --git a/resources/etesync/journalsfetchjob.cpp b/resources/etesync/journalsfetchjob.cpp
index eab727c33..eef070771 100644
--- a/resources/etesync/journalsfetchjob.cpp
+++ b/resources/etesync/journalsfetchjob.cpp
@@ -12,7 +12,8 @@
 #include <KCalendarCore/Todo>
 #include <KContacts/Addressee>
 #include <KContacts/ContactGroup>
-#include <QtConcurrent>
+#include <QFutureWatcher>
+#include <QtConcurrentRun>
 
 #include "etesync_debug.h"
 
@@ -36,7 +37,7 @@ void JournalsFetchJob::start()
         qCDebug(ETESYNC_LOG) << "emitResult from JournalsFetchJob";
         emitResult();
     });
-    QFuture<void> fetchJournalsFuture = QtConcurrent::run(this, &JournalsFetchJob::fetchJournals);
+    QFuture<void> fetchJournalsFuture = QtConcurrent::run(&JournalsFetchJob::fetchJournals, this);
     watcher->setFuture(fetchJournalsFuture);
 }
 
diff --git a/resources/etesync/loginjob.cpp b/resources/etesync/loginjob.cpp
index 8dd533a61..7d65408dd 100644
--- a/resources/etesync/loginjob.cpp
+++ b/resources/etesync/loginjob.cpp
@@ -6,7 +6,8 @@
 
 #include "loginjob.h"
 
-#include <QtConcurrent>
+#include <QFutureWatcher>
+#include <QtConcurrentRun>
 
 #include "etesync_debug.h"
 
@@ -32,7 +33,7 @@ void LoginJob::start()
         qCDebug(ETESYNC_LOG) << "emitResult from LoginJob";
         emitResult();
     });
-    QFuture<void> loginFuture = QtConcurrent::run(this, &LoginJob::login);
+    QFuture<void> loginFuture = QtConcurrent::run(&LoginJob::login, this);
     watcher->setFuture(loginFuture);
 }
 
-- 
2.44.0

