From 49bdb6310194cd899641b7d9cf8463d4fba6baea Mon Sep 17 00:00:00 2001
From: Christoph Cullmann <cullmann@kde.org>
Date: Thu, 18 Mar 2021 10:18:17 +0100
Subject: [PATCH] ensure qrc + QDir::searchPaths work for icons

before we had some optimization to check which paths
are absolute, but that one is wrong, applications
might rely on set search paths

BUG: 434451
---
 src/kiconloader.cpp | 19 ++++---------------
 1 file changed, 4 insertions(+), 15 deletions(-)

diff --git a/src/kiconloader.cpp b/src/kiconloader.cpp
index 011a292..2411af1 100644
--- a/src/kiconloader.cpp
+++ b/src/kiconloader.cpp
@@ -92,19 +92,6 @@ color:%7;\
 }
 }
 
-/**
- * Checks for relative paths quickly on UNIX-alikes, slowly on everything else.
- */
-static bool pathIsRelative(const QString &path)
-{
-#ifdef Q_OS_UNIX
-    // catch both /xxx/yyy and :/xxx/yyy for resources
-    return (!path.isEmpty() && path[0] != QLatin1Char('/') && path[0] != QLatin1Char(':'));
-#else
-    return QDir::isRelativePath(path);
-#endif
-}
-
 /**
  * Holds a QPixmap for this process, along with its associated path on disk.
  */
@@ -1214,7 +1201,8 @@ QString KIconLoader::iconPath(const QString &_name, int group_or_size, bool canR
         return QString();
     }
 
-    if (_name.isEmpty() || !pathIsRelative(_name)) {
+    // we need to honor resource :/ paths and QDir::searchPaths => use QDir::isRelativePath, see bug 434451
+    if (_name.isEmpty() || !QDir::isRelativePath(_name)) {
         // we have either an absolute path or nothing to work with
         return _name;
     }
@@ -1352,7 +1340,8 @@ QPixmap KIconLoader::loadScaledIcon(const QString &_name,
         name = QStandardPaths::writableLocation(QStandardPaths::GenericCacheLocation) + QLatin1Char('/') + name + QStringLiteral(".png");
     }
 
-    bool absolutePath = !pathIsRelative(name);
+    // we need to honor resource :/ paths and QDir::searchPaths => use QDir::isRelativePath, see bug 434451
+    bool absolutePath = !QDir::isRelativePath(name);
     if (!absolutePath) {
         name = d->removeIconExtension(name);
     }
-- 
2.25.1

