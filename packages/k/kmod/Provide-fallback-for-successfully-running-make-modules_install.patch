From e15c268ba92d53dbb97fa0211696226656780713 Mon Sep 17 00:00:00 2001
From: Jan Engelhardt <jengelh@inai.de>
Date: Sun, 16 Jul 2023 15:55:38 +0000
Subject: [PATCH 6/7] Provide fallback for successfully running `make
 modules_install` in pristine tarballs.

---
 tools/depmod.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/tools/depmod.c b/tools/depmod.c
index 5ef490473186..70cfefb81005 100644
--- a/tools/depmod.c
+++ b/tools/depmod.c
@@ -3030,6 +3030,15 @@ static int do_depmod(int argc, char *argv[])
 	cfg.outdirnamelen = snprintf(cfg.outdirname, PATH_MAX,
 				     "%s" MODULE_DIRECTORY "/%s",
 				     out_root ?: (root ?: ""), cfg.kversion);
+	struct stat sb;
+	if (stat(cfg.dirname, &sb) != 0) {
+	cfg.dirnamelen = snprintf(cfg.dirname, PATH_MAX,
+				  "%s/lib/modules/%s",
+				  root ?: "", cfg.kversion);
+	cfg.outdirnamelen = snprintf(cfg.outdirname, PATH_MAX,
+				     "%s/lib/modules/%s",
+				     out_root ?: (root ?: ""), cfg.kversion);
+	}
 
 	if (optind == argc)
 		all = 1;
-- 
2.41.0

