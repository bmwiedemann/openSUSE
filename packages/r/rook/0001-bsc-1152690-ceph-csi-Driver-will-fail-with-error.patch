From 90f8e99adca70716b91491d736fa6417cc9ba8cd Mon Sep 17 00:00:00 2001
From: Stefan Haas <shaas@suse.com>
Date: Tue, 5 Nov 2019 19:32:45 +0000
Subject: [PATCH] bsc#1152690 - ceph-csi: Driver will fail with error

---
 .../ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-dep.yaml      | 2 ++
 .../ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-sts.yaml      | 2 ++
 .../examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin.yaml  | 2 ++
 .../kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-dep.yaml | 2 ++
 .../kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-sts.yaml | 2 ++
 cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin.yaml    | 2 ++
 6 files changed, 12 insertions(+)

diff --git a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-dep.yaml b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-dep.yaml
index 27988be9..a27f0fec 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-dep.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-dep.yaml
@@ -67,6 +67,7 @@ spec:
             - "--metricsport={{ .CephFSGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -106,6 +107,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi-provisioner.sock
diff --git a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-sts.yaml b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-sts.yaml
index 374835e7..9d7de9c5 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-sts.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin-provisioner-sts.yaml
@@ -62,6 +62,7 @@ spec:
             - "--metricsport={{ .CephFSGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -101,6 +102,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi-provisioner.sock
diff --git a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin.yaml b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin.yaml
index 114ed0d5..b8927ccd 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/cephfs/csi-cephfsplugin.yaml
@@ -59,6 +59,7 @@ spec:
             - "--metricsport={{ .CephFSGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -106,6 +107,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi.sock
diff --git a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-dep.yaml b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-dep.yaml
index e48c6b22..e1a47530 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-dep.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-dep.yaml
@@ -83,6 +83,7 @@ spec:
             - "--metricsport={{ .RBDGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -122,6 +123,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi-provisioner.sock
diff --git a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-sts.yaml b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-sts.yaml
index 5079eae2..a571a9b3 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-sts.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin-provisioner-sts.yaml
@@ -76,6 +76,7 @@ spec:
             - "--metricsport={{ .RBDGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -115,6 +116,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi-provisioner.sock
diff --git a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin.yaml b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin.yaml
index 8f7b7aed..44867370 100644
--- a/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin.yaml
+++ b/cluster/examples/kubernetes/ceph/csi/template/rbd/csi-rbdplugin.yaml
@@ -59,6 +59,7 @@ spec:
             - "--metricsport={{ .RBDGRPCMetricsPort }}"
             - "--metricspath=/metrics"
             - "--enablegrpcmetrics={{ .EnableCSIGRPCMetrics }}"
+            - "--forcecephkernelclient=true"
           env:
             - name: POD_IP
               valueFrom:
@@ -104,6 +105,7 @@ spec:
             - "--metricspath=/metrics"
             - "--polltime=60s"
             - "--timeout=3s"
+            - "--forcecephkernelclient=true"
           env:
             - name: CSI_ENDPOINT
               value: unix:///csi/csi.sock
-- 
2.16.4

