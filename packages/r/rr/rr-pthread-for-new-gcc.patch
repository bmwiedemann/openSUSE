From 48f1d60f6eaf15137b426b1275cf285becb97258 Mon Sep 17 00:00:00 2001
From: Kyle Huey <khuey@kylehuey.com>
Date: Sun, 28 Nov 2021 08:55:26 -0800
Subject: [PATCH] Work around glibc stupidity (fixes #2987).

---
 src/test/at_threadexit.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/test/at_threadexit.c b/src/test/at_threadexit.c
index 9d287719d..88eb479a7 100644
--- a/src/test/at_threadexit.c
+++ b/src/test/at_threadexit.c
@@ -3,6 +3,7 @@
 #include "util.h"
 
 static pthread_key_t exit_key;
+static uint64_t exit_key_value;
 
 static void thread_exit(__attribute__((unused)) void* data) {
   atomic_puts("thread exit");
@@ -10,7 +11,7 @@ static void thread_exit(__attribute__((unused)) void* data) {
 
 static void* thread(__attribute__((unused)) void* unused) {
   pthread_key_create(&exit_key, thread_exit);
-  pthread_setspecific(exit_key, (void*)0x1);
+  pthread_setspecific(exit_key, (void*)&exit_key_value);
   pthread_exit(NULL);
 }
 
