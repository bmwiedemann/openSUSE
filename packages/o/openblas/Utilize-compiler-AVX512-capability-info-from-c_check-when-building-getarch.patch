From: Martin Kroeker <martin@ruby.chemie.uni-freiburg.de>
Date: Wed Mar 23 15:19:55 2022 +0100
Subject: Utilize compiler AVX512 capability info from c_check when building getarch
Patch-mainline: Not yet
Git-repo: https://github.com/xianyi/OpenBLAS
Git-commit: 9fbeb88fb87dcc418c9ef01c5f24c85029dfbbef
References: 


Signed-off-by: Egbert Eich <eich@suse.de>
---
 Makefile.prebuild | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/Makefile.prebuild b/Makefile.prebuild
index 399db956..4dad74d6 100644
--- a/Makefile.prebuild
+++ b/Makefile.prebuild
@@ -71,7 +71,8 @@ endif
 
 
 getarch : getarch.c cpuid.S dummy $(CPUIDEMU)
-	$(HOSTCC) $(HOST_CFLAGS) $(EXFLAGS) -o $(@F) getarch.c cpuid.S $(CPUIDEMU)
+	avx512=$$(perl c_check - - gcc | grep NO_AVX512); \
+	$(HOSTCC) $(HOST_CFLAGS) $(EXFLAGS) $${avx512:+-D$${avx512}} -o $(@F) getarch.c cpuid.S $(CPUIDEMU)
 
 getarch_2nd : getarch_2nd.c config.h dummy
 ifndef TARGET_CORE
