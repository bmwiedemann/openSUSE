From e9ea08b2298ea4bbfae42df81b8895d4165efec6 Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Fri, 1 Jul 2022 11:52:31 +0200
Subject: [PATCH 1/2] fix: scaling of background PDF during export

---
 src/adaptors/UBExportFullPDF.cpp | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/src/adaptors/UBExportFullPDF.cpp b/src/adaptors/UBExportFullPDF.cpp
index 6e98859ae..c61a66645 100644
--- a/src/adaptors/UBExportFullPDF.cpp
+++ b/src/adaptors/UBExportFullPDF.cpp
@@ -199,6 +199,11 @@ bool UBExportFullPDF::persistsDocument(UBDocumentProxy* pDocumentProxy, const QS
 
             MergeDescription mergeInfo;
 
+            // If the PDF was scaled when added to the scene (e.g if it was loaded from a document with a different DPI
+            // than the current one), it should also be scaled here.
+            qreal currentDpi = UBApplication::displayManager->logicalDpi(ScreenRole::Control);
+            qreal pdfScale = qreal(pDocumentProxy->pageDpi())/currentDpi;
+
             int existingPageCount = pDocumentProxy->pageCount();
 
             for(int pageIndex = 0 ; pageIndex < existingPageCount; pageIndex++)
@@ -238,10 +243,6 @@ bool UBExportFullPDF::persistsDocument(UBDocumentProxy* pDocumentProxy, const QS
                     xPdfOffset += (xPdf - xAnnotation) * scaleFactor * mScaleFactor;
                     yPdfOffset -= (yPdf - yAnnotation) * scaleFactor * mScaleFactor;
 
-                    // If the PDF was scaled when added to the scene (e.g if it was loaded from a document with a different DPI
-                    // than the current one), it should also be scaled here.
-                    qreal pdfScale = pdfItem->scale();
-
                     TransformationDescription pdfTransform(xPdfOffset, yPdfOffset, scaleFactor * pdfScale, 0);
                     TransformationDescription annotationTransform(xAnnotationsOffset, yAnnotationsOffset, 1, 0);
 

From 5e4100bbaf38931268e040cb2b6bea24b0fbda46 Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Fri, 19 Aug 2022 10:24:06 +0200
Subject: [PATCH 2/2] refactor: make compatibile with 1.6.x and 1.7.x

- use preprocessor to choose version dependent solutions
---
 src/adaptors/UBExportFullPDF.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/adaptors/UBExportFullPDF.cpp b/src/adaptors/UBExportFullPDF.cpp
index c61a66645..a2bd2e065 100644
--- a/src/adaptors/UBExportFullPDF.cpp
+++ b/src/adaptors/UBExportFullPDF.cpp
@@ -201,7 +201,20 @@ bool UBExportFullPDF::persistsDocument(UBDocumentProxy* pDocumentProxy, const QS
 
             // If the PDF was scaled when added to the scene (e.g if it was loaded from a document with a different DPI
             // than the current one), it should also be scaled here.
+#define UB_MINOR(version) EXTRACT_UB_MINOR(version)
+#define EXTRACT_UB_MINOR(major,minor,patch,type,build) minor
+#define UB_MAJOR(version) EXTRACT_UB_MAJOR(version)
+#define EXTRACT_UB_MAJOR(major,minor,patch,type,build) major
+
+#if UB_MAJOR(UBVERSION_RC) == 1 && UB_MINOR(UBVERSION_RC) == 6
+            QDesktopWidget* desktop = UBApplication::desktop();
+            qreal currentDpi = (desktop->physicalDpiX() + desktop->physicalDpiY()) / 2;
+#elif UB_MAJOR(UBVERSION_RC) == 1 && UB_MINOR(UBVERSION_RC) >= 7
             qreal currentDpi = UBApplication::displayManager->logicalDpi(ScreenRole::Control);
+#else
+#error Version UBVERSION_RC not supported by this code
+#endif
+
             qreal pdfScale = qreal(pDocumentProxy->pageDpi())/currentDpi;
 
             int existingPageCount = pDocumentProxy->pageCount();
