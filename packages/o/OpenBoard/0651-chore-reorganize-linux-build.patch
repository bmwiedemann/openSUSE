From 1597594ddd7ce1a933624df87f058172d3cbe71b Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Mon, 4 Jul 2022 14:06:06 +0200
Subject: [PATCH 1/3] chore: reorganize Linux build system

- use lowercase openboard for executable file name
- remove unnecessary Qt module dependencies
- remove obsolete and unused UB_THIRDPARTY_INTERACTIVE
- use linux instead of linux-g++* for conditionals
  - allows to use other compiles than g++
- use pkgconfig for quazip, libpoppler, ffmpeg
- install fonts, icons, desktop file, mimetype specification
- add and use an OpenBoard.svg application icon
- add namespace prefix to system files and icons
- separate APP_PREFIX and SYS_PREFIX
  - install application related files to APP_PREFIX
  - install system files and binary to SYS_PREFIX
- locate OpenBoardImporter using APP_PREFIX
---
 OpenBoard.pro                                 | 98 ++++++++++++++-----
 resources/images/ch.openboard.OpenBoard.svg   |  4 +
 .../linux/ch.openboard.OpenBoard.desktop      | 11 +++
 ...z.svg => ch.openboard.application-ubz.svg} |  0
 ...ubz.xml => ch.openboard.openboard-ubz.xml} |  2 +
 src/core/UBOpenSankoreImporter.cpp            |  3 +-
 src/frameworks/UBPlatformUtils_linux.cpp      |  2 +-
 src/podcast/podcast.pri                       | 21 +---
 8 files changed, 93 insertions(+), 48 deletions(-)
 create mode 100644 resources/images/ch.openboard.OpenBoard.svg
 create mode 100644 resources/linux/ch.openboard.OpenBoard.desktop
 rename resources/linux/{application-ubz.svg => ch.openboard.application-ubz.svg} (100%)
 rename resources/linux/{openboard-ubz.xml => ch.openboard.openboard-ubz.xml} (73%)

diff --git a/OpenBoard.pro b/OpenBoard.pro
index 17d6ccc81..56f199d17 100644
--- a/OpenBoard.pro
+++ b/OpenBoard.pro
@@ -1,4 +1,5 @@
 TARGET = "OpenBoard"
+linux:TARGET = "openboard"
 TEMPLATE = app
 
 CONFIG += c++17
@@ -22,7 +23,6 @@ equals(VERSION_TYPE, r) {
     VERSION = "$${VERSION_MAJ}.$${VERSION_MIN}.$${VERSION_PATCH}"
 }
 
-
 LONG_VERSION = "$${VERSION}.$${SVN_VERSION}"
 macx:OSX_VERSION = "$${VERSION} (r$${SVN_VERSION})"
 
@@ -35,11 +35,9 @@ VERSION_RC = $$replace(VERSION_RC, "r", "240") # 0xF0
 QT += svg
 QT += network
 QT += xml
-QT += xmlpatterns
 QT += uitools
 QT += multimedia
 QT += multimediawidgets
-QT += webengine
 QT += webenginewidgets
 QT += printsupport
 QT += core
@@ -62,6 +60,7 @@ include(src/tools/tools.pri)
 include(src/desktop/desktop.pri)
 include(src/web/web.pri)
 include(src/singleapplication/singleapplication.pri)
+
 DEFINES += QAPPLICATION_CLASS=QApplication
 
 DEPENDPATH += src/pdf-merger
@@ -86,7 +85,7 @@ UB_ETC.files = resources/etc
 UB_I18N.files = resources/i18n/*.qm
 UB_LIBRARY.files = resources/library
 UB_FONTS.files = resources/fonts
-UB_THIRDPARTY_INTERACTIVE.files = thirdparty/interactive
+UB_CUSTOM_FONTS.files = resources/customizations/fonts
 
 DEFINES += NO_THIRD_PARTY_WARNINGS
 DEFINES += UBVERSION=\"\\\"$${LONG_VERSION}\"\\\" \
@@ -97,7 +96,7 @@ BUILD_DIR = build
 
 macx:BUILD_DIR = $$BUILD_DIR/macx
 win32:BUILD_DIR = $$BUILD_DIR/win32
-linux-g++*:BUILD_DIR = $$BUILD_DIR/linux
+linux:BUILD_DIR = $$BUILD_DIR/linux
 
 CONFIG(debug, debug|release):BUILD_DIR = $$BUILD_DIR/debug
 CONFIG(release, debug|release) {
@@ -140,7 +139,6 @@ win32 {
    UB_LIBRARY.path = $$DESTDIR
    UB_I18N.path = $$DESTDIR/i18n
    UB_ETC.path = $$DESTDIR
-   UB_THIRDPARTY_INTERACTIVE.path = $$DESTDIR/library
    system(md $$replace(BUILD_DIR, /, \\))
    system(echo "$$VERSION" > $$BUILD_DIR/version)
    system(echo "$$LONG_VERSION" > $$BUILD_DIR/longversion)
@@ -229,8 +227,6 @@ macx {
    UB_LIBRARY.path = "$$RESOURCES_DIR"
    UB_FONTS.files = "resources/fonts"
    UB_FONTS.path = "$$RESOURCES_DIR"
-   UB_THIRDPARTY_INTERACTIVE.files = $$files($$THIRD_PARTY_PATH/interactive/*)
-   UB_THIRDPARTY_INTERACTIVE.path = "$$RESOURCES_DIR/library/interactive"
    UB_MACX_ICNS.files = $$files(resources/macx/*.icns)
    UB_MACX_ICNS.path = "$$RESOURCES_DIR"
    UB_MACX_EXTRAS.files = "resources/macx/Save PDF to OpenBoard.workflow"
@@ -433,7 +429,6 @@ macx {
    QMAKE_BUNDLE_DATA += UB_ETC \
        UB_LIBRARY \
        UB_FONTS \
-       UB_THIRDPARTY_INTERACTIVE \
        UB_MACX_ICNS \
        UB_MACX_EXTRAS \
        SPARKLE_KEY \
@@ -449,28 +444,83 @@ macx {
   # system(printf "%02x%02x%02x%02x" `printf $$VERSION_RC | cut -d ',' -f 1` `printf $$VERSION_RC | cut -d ',' -f 2` `printf $$VERSION_RC | cut -d ',' -f 3` `printf $$VERSION_RC | cut -d ',' -f 4` | xxd -r -p > "$$VERSION_RC_PATH")
 }
 
-linux-g++* {
+linux {
+    # Installation prefixes
+    PREFIX = $$(PREFIX)
+    APP_PREFIX = $$(APP_PREFIX)
+    SYS_PREFIX = $$(SYS_PREFIX)
+
+    isEmpty(PREFIX): PREFIX = /usr
+    isEmpty(APP_PREFIX): APP_PREFIX = $$PREFIX/share/openboard
+    isEmpty(SYS_PREFIX): SYS_PREFIX = $$PREFIX
+
+    DEFINES += APP_PREFIX=\"\\\"$$APP_PREFIX\"\\\"
+
+    UB_BINARY.files     = $$DESTDIR/openboard
+    UB_ICON.files       = resources/images/ch.openboard.OpenBoard.svg
+    UB_DESKTOP.files    = resources/linux/ch.openboard.OpenBoard.desktop
+    UB_MIMETYPE.files   = resources/linux/ch.openboard.openboard-ubz.xml
+    UB_MIMEICON.files   = resources/linux/ch.openboard.application-ubz.svg
+
     CONFIG += link_prl
     LIBS += -lcrypto
     #LIBS += -lprofiler
     LIBS += -lX11
-    LIBS += -lquazip5
-    INCLUDEPATH += "/usr/include/quazip5"
-
-    LIBS += -lpoppler
-    INCLUDEPATH += "/usr/include/poppler"
+    CONFIG += link_pkgconfig
+    PKGCONFIG += poppler
+
+    # search and configure quazip
+    QUAZIP_PKG = quazip1-qt5 libquazip5-1 quazip-qt5 quazip5
+
+    for(pkg, QUAZIP_PKG):isEmpty(QUAZIP_PKG_FOUND) {
+        # using this workaround as packagesExists did not work for me when invoked from qtcreator
+        # see https://forum.qt.io/topic/136725/
+        PKG_EXISTS = $$system(pkg-config --exists $${pkg} && echo exists)
+        count(PKG_EXISTS, 1) {
+            message("using" $${pkg} "version" $$system(pkg-config --modversion $${pkg}))
+            PKGCONFIG += $${pkg}
+            QUAZIP_PKG_FOUND = true
+        }
+    }
+
+    isEmpty(QUAZIP_PKG_FOUND) {
+        exists(/usr/include/$$last(QUAZIP_PKG/*)) {
+            message(Using quazip in /usr/include/$$last(QUAZIP_PKG))
+            LIBS += -l$$last(QUAZIP_PKG)
+            INCLUDEPATH += "/usr/include/$$last(QUAZIP_PKG)"
+        } else {
+            error(quazip not found)
+        }
+    }
 
     QMAKE_CFLAGS += -fopenmp
     QMAKE_CXXFLAGS += -fopenmp
     QMAKE_LFLAGS += -fopenmp
-    UB_LIBRARY.path = $$DESTDIR
-    UB_I18N.path = $$DESTDIR/i18n
-    UB_ETC.path = $$DESTDIR
-    UB_THIRDPARTY_INTERACTIVE.path = $$DESTDIR/library
+
+    UB_BINARY.path       = $$SYS_PREFIX/bin
+    UB_LIBRARY.path      = $$APP_PREFIX
+    UB_I18N.path         = $$APP_PREFIX/i18n/
+    UB_ETC.path          = $$APP_PREFIX
+    UB_FONTS.path        = $$APP_PREFIX
+    UB_CUSTOM_FONTS.path = $$APP_PREFIX/customizations
+    UB_ICON.path         = $$SYS_PREFIX/share/icons/hicolor/scalable/apps/
+    UB_DESKTOP.path      = $$SYS_PREFIX/share/applications/
+    UB_MIMETYPE.path     = $$SYS_PREFIX/share/mime/packages/
+    UB_MIMEICON.path     = $$SYS_PREFIX/share/icons/hicolor/scalable/mimetypes
+
     system(mkdir -p $$BUILD_DIR)
     system(echo "$$VERSION" > $$BUILD_DIR/version)
     system(echo "$$LONG_VERSION" > $$BUILD_DIR/longversion)
     system(echo "$$SVN_VERSION" > $$BUILD_DIR/svnversion)
+
+# for Linux-type installs only
+    INSTALLS = UB_BINARY \
+        UB_FONTS \
+        UB_CUSTOM_FONTS \
+        UB_ICON \
+        UB_DESKTOP \
+        UB_MIMETYPE \
+        UB_MIMEICON
 }
 
 RESOURCES += resources/OpenBoard.qrc
@@ -509,12 +559,6 @@ TRANSLATIONS = resources/i18n/OpenBoard_en.ts \
    resources/i18n/OpenBoard_hu.ts \
    resources/i18n/OpenBoard_mg.ts
 
-INSTALLS = UB_ETC \
+INSTALLS += UB_ETC \
    UB_I18N \
-   UB_LIBRARY \
-   UB_THIRDPARTY_INTERACTIVE
-
-DISTFILES += \
-    resources/images/moveDown.svg \
-    resources/images/moveDownDisabled.svg
-
+   UB_LIBRARY
diff --git a/resources/images/ch.openboard.OpenBoard.svg b/resources/images/ch.openboard.OpenBoard.svg
new file mode 100644
index 000000000..4eecaaa2b
--- /dev/null
+++ b/resources/images/ch.openboard.OpenBoard.svg
@@ -0,0 +1,4 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" version="1">
+  <path fill="#505556" d="M451 89c10 0 28 13 34 25l5 14 1 111c-1 105-1 105-3 111-5 14-15 24-30 30l-6 2h-70l-71 1-59 59-61 60v-59l-1-59-65-2c-64 0-64 0-70-2-16-6-29-20-32-36V126c4-15 15-29 30-35l6-2 169-1 169 1m-18 26H222c-149 0-156 0-160 2-5 2-10 8-12 13l-1 106v102l3 6c2 4 4 6 8 8l5 3h74l75 1v42l1 43c1 1 21-19 45-42l44-43 72-1c81 0 75 1 82-7l5-8V131c-3-10-11-16-21-16"/>
+  <path fill="#f48c4f" d="M433 116l-20 35-27 45c-15 23-56 75-65 84-4 5-11 7-15 6-7-1-11-10-8-17a570 570 0 0 1 65-128l62-92c27-40 27-40 38-40 5 0 7 0 11 3s8 9 8 14-2 9-17 35l-14 26"/>
+</svg>
diff --git a/resources/linux/ch.openboard.OpenBoard.desktop b/resources/linux/ch.openboard.OpenBoard.desktop
new file mode 100644
index 000000000..f7da8c44d
--- /dev/null
+++ b/resources/linux/ch.openboard.OpenBoard.desktop
@@ -0,0 +1,11 @@
+[Desktop Entry]
+Encoding=UTF-8
+Name=OpenBoard
+Comment=OpenBoard, an interactive white board application
+Exec=openboard %f
+Icon=ch.openboard.OpenBoard
+StartupNotify=true
+Terminal=false
+Type=Application
+MimeType=application/ubz
+Categories=Education;
diff --git a/resources/linux/application-ubz.svg b/resources/linux/ch.openboard.application-ubz.svg
similarity index 100%
rename from resources/linux/application-ubz.svg
rename to resources/linux/ch.openboard.application-ubz.svg
diff --git a/resources/linux/openboard-ubz.xml b/resources/linux/ch.openboard.openboard-ubz.xml
similarity index 73%
rename from resources/linux/openboard-ubz.xml
rename to resources/linux/ch.openboard.openboard-ubz.xml
index cda36e1dc..aaa7feaf8 100644
--- a/resources/linux/openboard-ubz.xml
+++ b/resources/linux/ch.openboard.openboard-ubz.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0"?>
 <mime-info xmlns='http://www.freedesktop.org/standards/shared-mime-info'>
   <mime-type type="application/ubz">
+    <icon name="ch.openboard.application-ubz"/>
     <comment>OpenBoard document file</comment>
     <comment xml:lang="fr">Document OpenBoard</comment>
+    <comment xml:lang="de">OpenBoard Dokument</comment>
     <glob pattern="*.ubz"/>
   </mime-type>
 </mime-info>
diff --git a/src/core/UBOpenSankoreImporter.cpp b/src/core/UBOpenSankoreImporter.cpp
index 217a85543..af245cde0 100644
--- a/src/core/UBOpenSankoreImporter.cpp
+++ b/src/core/UBOpenSankoreImporter.cpp
@@ -32,6 +32,7 @@
 #include "UBSettings.h"
 
 #include "core/UBApplication.h"
+#include "frameworks/UBPlatformUtils.h"
 #include "gui/UBMainWindow.h"
 #include "gui/UBOpenSankoreImporterWidget.h"
 
@@ -53,7 +54,7 @@ void UBOpenSankoreImporter::onProceedClicked()
 {
     QProcess newProcess;
 #ifdef Q_OS_LINUX
-    newProcess.startDetached(qApp->applicationDirPath()+"/importer/OpenBoardImporter");
+    newProcess.startDetached(UBPlatformUtils::applicationResourcesDirectory()+"/importer/OpenBoardImporter");
 #elif defined Q_OS_OSX
     newProcess.startDetached(qApp->applicationDirPath()+"/../Resources/OpenBoardImporter.app/Contents/MacOS/OpenBoardImporter");
 #elif defined Q_OS_WIN
diff --git a/src/frameworks/UBPlatformUtils_linux.cpp b/src/frameworks/UBPlatformUtils_linux.cpp
index 8864d52c3..cc4fae020 100644
--- a/src/frameworks/UBPlatformUtils_linux.cpp
+++ b/src/frameworks/UBPlatformUtils_linux.cpp
@@ -46,7 +46,7 @@ void UBPlatformUtils::init()
 
 QString UBPlatformUtils::applicationResourcesDirectory()
 {
-    return QApplication::applicationDirPath();
+    return APP_PREFIX;
 }
 
 void UBPlatformUtils::hideFile(const QString &filePath)
diff --git a/src/podcast/podcast.pri b/src/podcast/podcast.pri
index 873658c9f..e6716893a 100644
--- a/src/podcast/podcast.pri
+++ b/src/podcast/podcast.pri
@@ -50,29 +50,12 @@ macx {
     LIBS += -L/usr/local/opt/libass/lib
 }
 
-linux-g++* {
+linux {
     HEADERS  += src/podcast/ffmpeg/UBFFmpegVideoEncoder.h \
                 src/podcast/ffmpeg/UBMicrophoneInput.h
 
     SOURCES  += src/podcast/ffmpeg/UBFFmpegVideoEncoder.cpp \
                 src/podcast/ffmpeg/UBMicrophoneInput.cpp
 
-
-    DEPENDPATH += /usr/lib/x86_64-linux-gnu
-
-    LIBS += -lavformat -lavcodec -lswscale -lavutil \
-            -lva-x11 \
-            -lva \
-            -lxcb-shm \
-            -lxcb-xfixes \
-            -lxcb-render -lxcb-shape -lxcb -lX11 -lasound -lSDL -lx264 -lpthread -lvpx -lvorbisenc -lvorbis -ltheoraenc -ltheoradec -logg -lopus -lmp3lame -lfreetype -lfdk-aac -lass -llzma -lbz2 -lz -ldl -lswresample -lswscale -lavutil -lm
-
-    FFMPEG_VERSION = $$system(ffmpeg --version|& grep -oP "version.*?\K[0-9]\.[0-9]")
-    equals(FFMPEG_VERSION, 2.8) {
-        LIBS -= -lswresample
-        LIBS += -lavresample
-    }
-
-
-    QMAKE_CXXFLAGS += -std=c++11 # move this to OpenBoard.pro when we can use C++11 on all platforms
+    PKGCONFIG += libavformat libavcodec libavutil libswresample libswscale
 }

From fca1abddf41d0a2a764fb71cd1b9a726b844e485 Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Thu, 7 Jul 2022 11:56:33 +0200
Subject: [PATCH 2/3] chore: adapt build and packaging scripts

- adapt to new installation layout
- avoid having to run as root
- replace run.sh by a script in /usr/local/bin
---
 release_scripts/linux/build.sh                |   9 +-
 .../linux/debian_package_files/prerm          |  19 --
 release_scripts/linux/package.sh              | 162 ++++++------------
 resources/linux/run.sh                        |  28 ---
 4 files changed, 59 insertions(+), 159 deletions(-)
 delete mode 100644 release_scripts/linux/debian_package_files/prerm
 delete mode 100644 resources/linux/run.sh

diff --git a/release_scripts/linux/build.sh b/release_scripts/linux/build.sh
index e882f622f..c71f31158 100755
--- a/release_scripts/linux/build.sh
+++ b/release_scripts/linux/build.sh
@@ -17,7 +17,9 @@
 initializeVariables()
 {
   APPLICATION_NAME="OpenBoard"
+  BINARY_NAME=openboard
   STANDARD_QT_USED=true
+  export APP_PREFIX=/opt/openboard
 
   # Root directory
   SCRIPT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
@@ -167,9 +169,12 @@ else
 fi
 
 
-make -j4 release-install
+INSTALL_ROOT=$PRODUCT_PATH make -j4 release-install
 
-if [ ! -e "$PRODUCT_PATH/${APPLICATION_NAME}" ]; then
+# remove target, binary used from installed location
+rm $PRODUCT_PATH/${BINARY_NAME}
+
+if [ ! -e "$PRODUCT_PATH/usr/bin/${BINARY_NAME}" ]; then
     notifyError "${APPLICATION_NAME} build failed"
 else
     notifyProgress "Finished building OpenBoard. You may now run the packaging script."
diff --git a/release_scripts/linux/debian_package_files/prerm b/release_scripts/linux/debian_package_files/prerm
deleted file mode 100644
index 5b1612c1b..000000000
--- a/release_scripts/linux/debian_package_files/prerm
+++ /dev/null
@@ -1,19 +0,0 @@
-#!/bin/bash
-# --------------------------------------------------------------------
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-# ---------------------------------------------------------------------
-
-xdg-desktop-menu uninstall /usr/share/applications/openboard.desktop
-rm -f /usr/bin/openboard
-exit 0
diff --git a/release_scripts/linux/package.sh b/release_scripts/linux/package.sh
index cd8b27cd3..254ef4e42 100755
--- a/release_scripts/linux/package.sh
+++ b/release_scripts/linux/package.sh
@@ -24,24 +24,31 @@
 #    DEBIAN/
 #    | control
 #    | md5sums
-#    | prerm
-#    | postinst
 #    usr/
 #    | bin/
-#    | | openboard <-- actually a symlink to run.sh or OpenBoard
+#    | | openboard
 #    | share/
 #    | | applications/
-#    | | | openboard.desktop
+#    | | | ch.openboard.OpenBoard.desktop
+#    | | icons/
+#    | | | hicolor/
+#    | | | | scalable/
+#    | | | | | apps/
+#    | | | | | | ch.openboard.OpenBoard.svg
+#    | | | | | mimetypes/
+#    | | | | | | ch.openboard.application-ubz.svg
+#    | | mime/
+#    | | | packages/
+#    | | | | ch.openboard.openboard-ubz.xml
 #    opt/
 #    | openboard/
+#    | | customizations/
+#    | | | fonts/
+#    | | etc/
+#    | | fonts/
+#    | | i18n/
 #    | | importer/
 #    | | library/
-#    | | etc/
-#    | | qtlib/ (*)
-#    | | plugins/ (*)
-#    | | OpenBoard
-#    | | OpenBoard.png
-#    | | run.sh (*)
 #
 # (*) Only included if Qt libs and plugins are bundled. It is necessary to
 # bundle these if the target system doesn't provide Qt 5.5.1, for example.
@@ -67,11 +74,13 @@ initializeVariables()
   # package
   BASE_WORKING_DIR="debianPackage"
 
-  APPLICATION_NAME="OpenBoard"
+  APPLICATION_NAME="openboard"
   APPLICATION_CODE="openboard"
   APPLICATION_PATH="opt"
+  SYSTEM_PATH="usr"
 
   PACKAGE_DIRECTORY=$BASE_WORKING_DIR/$APPLICATION_PATH/$APPLICATION_CODE
+  BINARY_DIRECTORY=$BASE_WORKING_DIR/usr/bin
   PACKAGE_QT_DIRECTORY="$PACKAGE_DIRECTORY/qt"
   QT_LIBRARY_DEST_PATH="$PACKAGE_QT_DIRECTORY/lib"
   QT_LIBRARY_EXECUTABLES_DEST_PATH="$PACKAGE_QT_DIRECTORY/libexec"
@@ -104,14 +113,6 @@ initializeVariables()
   ZIP_PATH=`which zip`
 }
 
-checkUser()
-{
-  if [ `id -u` -ne 0 ]; then
-    echo "Please run the script as root" 
-    exit 1
-  fi
-}
-
 checkBuild() 
 {
   if [ -z "$ARCHITECTURE" ]; then
@@ -140,6 +141,8 @@ copyQtLibrary(){
     if ls "$QT_LIBRARY_SOURCE_PATH/$1.so" &> /dev/null; then
         cp -P $QT_LIBRARY_SOURCE_PATH/$1.so "$QT_LIBRARY_DEST_PATH/"
         cp -P $QT_LIBRARY_SOURCE_PATH/$1.so.* "$QT_LIBRARY_DEST_PATH/"
+        # do not package debug libraries
+        rm $QT_LIBRARY_DEST_PATH/$1.so.*.debug
 
         strip $QT_LIBRARY_DEST_PATH/$1.so
         chmod 644 $QT_LIBRARY_DEST_PATH/$1.so.* # 644 = rw-r-r
@@ -152,6 +155,8 @@ copyQtPlugin(){
     echo -e "\t $1"
     if ls "$QT_PLUGINS_SOURCE_PATH/$1" &> /dev/null; then
         cp -r $QT_PLUGINS_SOURCE_PATH/$1 $QT_PLUGINS_DEST_PATH/
+        # do not package debug libraries
+        rm $QT_PLUGINS_DEST_PATH/$1/*.debug
 
         strip $QT_PLUGINS_DEST_PATH/$1/*
         chmod 644 $QT_PLUGINS_DEST_PATH/$1/* # 644 = rw-r-r
@@ -171,7 +176,6 @@ copyQtPlugin(){
 initializeVariables
 
 checkBuild
-checkUser
 
 cd $PROJECT_ROOT
 
@@ -182,16 +186,15 @@ rm -rf $PACKAGE_BUILD_DIR
 
 
 notifyProgress "Copying product directory and resources"
-cp -R $PRODUCT_PATH/* $PACKAGE_DIRECTORY
-chown -R root:root $PACKAGE_DIRECTORY
-
-cp -R resources/customizations $PACKAGE_DIRECTORY/
-cp resources/linux/openboard-ubz.xml $PACKAGE_DIRECTORY/etc/
-cp resources/linux/application-ubz.png $PACKAGE_DIRECTORY/etc/
+cp -R $PRODUCT_PATH/* $BASE_WORKING_DIR
 
 if $BUNDLE_QT; then
-    cp -R resources/linux/run.sh $PACKAGE_DIRECTORY/
-    chmod a+x $PACKAGE_DIRECTORY/run.sh
+    STARTER=$BASE_WORKING_DIR/usr/local/bin/openboard
+    QT_INSTALL=/$APPLICATION_PATH/$APPLICATION_CODE/qt
+    mkdir -p $(dirname $STARTER)
+    echo "#!/bin/bash" > $STARTER
+    echo "env LD_LIBRARY_PATH=$QT_INSTALL/lib:\$LD_LIBRARY_PATH QT_PLUGIN_PATH=$QT_INSTALL/plugins /usr/bin/openboard \"\$@\"" >> $STARTER
+    chmod a+x $STARTER
 fi
 
 notifyProgress "Copying importer"
@@ -199,7 +202,7 @@ mkdir -p $PACKAGE_DIRECTORY/importer
 cp -R "$IMPORTER_DIR/$IMPORTER_NAME" "$PACKAGE_DIRECTORY/importer"
 
 notifyProgress "Stripping importer and main executable"
-strip $PACKAGE_DIRECTORY/$APPLICATION_NAME
+strip $BINARY_DIRECTORY/$APPLICATION_NAME
 strip $PACKAGE_DIRECTORY/importer/$IMPORTER_NAME
 
 if $BUNDLE_QT; then
@@ -246,28 +249,27 @@ if $BUNDLE_QT; then
     copyQtLibrary libQt5Widgets
     copyQtLibrary libQt5XcbQpa
     copyQtLibrary libQt5Xml
-    copyQtLibrary libQt5XmlPatterns
     copyQtLibrary libicuuc
     copyQtLibrary libicui18n
     copyQtLibrary libicudata
-fi
 
-notifyProgress "Copying Qt translations"
-mkdir -p $PACKAGE_DIRECTORY/i18n
-cp $GUI_TRANSLATIONS_DIRECTORY_PATH/qt_??.qm $PACKAGE_DIRECTORY/i18n/
+    notifyProgress "Copying Qt translations"
+    mkdir -p $PACKAGE_DIRECTORY/i18n
+    cp $GUI_TRANSLATIONS_DIRECTORY_PATH/qt_??.qm $PACKAGE_DIRECTORY/i18n/
 
-# ----------------------------------------------------------------------------
-# QT WebEngine
-# ----------------------------------------------------------------------------
-notifyProgress "Copying Qt WebEngine dependencies"
-mkdir -p "$QT_LIBRARY_EXECUTABLES_DEST_PATH"
-cp $QT_LIBRARY_EXECUTABLES_SOURCE_PATH/QtWebEngineProcess $QT_LIBRARY_EXECUTABLES_DEST_PATH
+    # ----------------------------------------------------------------------------
+    # QT WebEngine
+    # ----------------------------------------------------------------------------
+    notifyProgress "Copying Qt WebEngine dependencies"
+    mkdir -p "$QT_LIBRARY_EXECUTABLES_DEST_PATH"
+    cp $QT_LIBRARY_EXECUTABLES_SOURCE_PATH/QtWebEngineProcess $QT_LIBRARY_EXECUTABLES_DEST_PATH
 
-mkdir -p "$QT_RESOURCES_DEST_PATH"
-cp $QT_RESOURCES_SOURCE_PATH/* $QT_RESOURCES_DEST_PATH
+    mkdir -p "$QT_RESOURCES_DEST_PATH"
+    cp $QT_RESOURCES_SOURCE_PATH/* $QT_RESOURCES_DEST_PATH
 
-mkdir -p "$QT_TRANSLATIONS_DEST_PATH/qtwebengine_locales"
-cp $QT_TRANSLATIONS_SOURCE_PATH/qtwebengine_locales/* $QT_TRANSLATIONS_DEST_PATH/qtwebengine_locales
+    mkdir -p "$QT_TRANSLATIONS_DEST_PATH/qtwebengine_locales"
+    cp $QT_TRANSLATIONS_SOURCE_PATH/qtwebengine_locales/* $QT_TRANSLATIONS_DEST_PATH/qtwebengine_locales
+fi
 
 # ----------------------------------------------------------------------------
 # DEBIAN directory of package (control, md5sums, postinst etc)
@@ -276,52 +278,10 @@ notifyProgress "Generating control files for package"
 
 mkdir -p "$BASE_WORKING_DIR/DEBIAN"
 
-# Copy prerm script
-cp -r "$SCRIPT_PATH/debian_package_files/prerm" "$BASE_WORKING_DIR/DEBIAN/"
-chmod 755 "$BASE_WORKING_DIR/DEBIAN/prerm"
-
-# Generate postinst script (can't copy it like prerm because some paths vary depending on
-# the values of the variables in this script)
-
-SYMLINK_TARGET="/$APPLICATION_PATH/$APPLICATION_CODE/$APPLICATION_NAME"
-if $BUNDLE_QT ; then
-    SYMLINK_TARGET="/$APPLICATION_PATH/$APPLICATION_CODE/run.sh"
-fi
-
-cat > "$BASE_WORKING_DIR/DEBIAN/postinst" << EOF
-#!/bin/bash
-# --------------------------------------------------------------------
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-# ---------------------------------------------------------------------
-
-xdg-desktop-menu install --novendor /usr/share/applications/${APPLICATION_CODE}.desktop
-xdg-mime install --mode system /$APPLICATION_PATH/$APPLICATION_CODE/etc/openboard-ubz.xml
-xdg-mime default /usr/share/applications/${APPLICATION_CODE}.desktop application/ubz
-xdg-icon-resource install --context mimetypes --size 48 /$APPLICATION_PATH/$APPLICATION_CODE/etc/application-ubz.png application-ubz
-
-ln -s $SYMLINK_TARGET /usr/bin/$APPLICATION_CODE
-
-exit 0
-EOF
-
-chmod 755 "$BASE_WORKING_DIR/DEBIAN/postinst"
-
-
 # Generate md5 sums of everything in the application path (e.g /opt) and the desktop entry
 cd $BASE_WORKING_DIR
 find $APPLICATION_PATH/ -exec md5sum {} > DEBIAN/md5sums 2>/dev/null \;
-find $DESKTOP_FILE_PATH/ -exec md5sum {} >> DEBIAN/md5sums 2>/dev/null \;
+find $SYSTEM_PATH/ -exec md5sum {} >> DEBIAN/md5sums 2>/dev/null \;
 cd $PROJECT_ROOT
 
 # Generate control file
@@ -333,9 +293,9 @@ echo "Section: education" >> "$CONTROL_FILE"
 echo "Priority: optional" >> "$CONTROL_FILE"
 echo "Architecture: $ARCHITECTURE" >> "$CONTROL_FILE"
 echo "Essential: no" >> "$CONTROL_FILE"
-echo "Installed-Size: `du -s $PACKAGE_DIRECTORY | awk '{ print $1 }'`" >> "$CONTROL_FILE"
+echo "Installed-Size: `du -s --exclude="*/DEBIAN/*" $BASE_WORKING_DIR | awk '{ print $1 }'`" >> "$CONTROL_FILE"
 echo "Maintainer: ${APPLICATION_NAME} Developers team <dev@openboard.ch>" >> "$CONTROL_FILE"
-echo "Homepage: https://github.com/DIP-SEM/OpenBoard" >> "$CONTROL_FILE"
+echo "Homepage: https://github.com/Open-Board-org/OpenBoard" >> "$CONTROL_FILE"
 
 # Generate dependency list
 echo -n "Depends: " >> "$CONTROL_FILE"
@@ -345,7 +305,7 @@ declare -a tab
 let count=0
 
 if $BUNDLE_QT; then
-    for l in `objdump -p $PACKAGE_DIRECTORY/${APPLICATION_NAME} | grep NEEDED | awk '{ print $2 }'`; do
+    for l in `objdump -p $BINARY_DIRECTORY/${APPLICATION_NAME} | grep NEEDED | awk '{ print $2 }'`; do
         for lib in `dpkg -S  $l | grep -v "libqt5" | grep -v "qt55" | awk -F":" '{ print $1 }'`; do
             presence=`echo ${tab[*]} | grep -c "$lib"`;
             if [ "$presence" == "0" ]; then
@@ -358,7 +318,7 @@ if $BUNDLE_QT; then
         done;
     done;
 else
-    for l in `objdump -p $PACKAGE_DIRECTORY/${APPLICATION_NAME} | grep NEEDED | awk '{ print $2 }'`; do
+    for l in `objdump -p $BINARY_DIRECTORY/${APPLICATION_NAME} | grep NEEDED | awk '{ print $2 }'`; do
         for lib in `dpkg -S  $l | awk -F":" '{ print $1 }'`; do
             presence=`echo ${tab[*]} | grep -c "$lib"`;
             if [ "$presence" == "0" ]; then
@@ -404,24 +364,6 @@ fi
 echo "" >> "$CONTROL_FILE"
 echo "Description: $DESCRIPTION" >> "$CONTROL_FILE"
 
-# ----------------------------------------------------------------------------
-# .desktop file
-# ----------------------------------------------------------------------------
-mkdir -p $DESKTOP_FILE_PATH
-echo "[Desktop Entry]" > $APPLICATION_SHORTCUT
-echo "Version=$VERSION" >> $APPLICATION_SHORTCUT
-echo "Encoding=UTF-8" >> $APPLICATION_SHORTCUT
-echo "Name=${APPLICATION_NAME}" >> $APPLICATION_SHORTCUT
-echo "Comment=$DESCRIPTION" >> $APPLICATION_SHORTCUT
-echo "Exec=$APPLICATION_CODE %f" >> $APPLICATION_SHORTCUT
-echo "Icon=/$APPLICATION_PATH/$APPLICATION_CODE/${APPLICATION_NAME}.png" >> $APPLICATION_SHORTCUT
-echo "StartupNotify=true" >> $APPLICATION_SHORTCUT
-echo "Terminal=false" >> $APPLICATION_SHORTCUT
-echo "Type=Application" >> $APPLICATION_SHORTCUT
-echo "MimeType=application/ubz" >> $APPLICATION_SHORTCUT
-echo "Categories=Education;" >> $APPLICATION_SHORTCUT
-cp "resources/images/${APPLICATION_NAME}.png" "$PACKAGE_DIRECTORY/${APPLICATION_NAME}.png"
-
 # ----------------------------------------------------------------------------
 # Building the package
 # ----------------------------------------------------------------------------
@@ -430,7 +372,7 @@ mkdir -p "$PACKAGE_BUILD_DIR/linux"
 PACKAGE_NAME="${APPLICATION_NAME}_`lsb_release -is`_`lsb_release -rs`_${VERSION}_$ARCHITECTURE.deb"
 PACKAGE_NAME=`echo "$PACKAGE_NAME" | awk '{print tolower($0)}'`
 
-dpkg -b "$BASE_WORKING_DIR" "$PACKAGE_BUILD_DIR/linux/$PACKAGE_NAME"
+dpkg-deb --root-owner-group -b "$BASE_WORKING_DIR" "$PACKAGE_BUILD_DIR/linux/$PACKAGE_NAME"
 
 #clean up mess
 rm -rf $BASE_WORKING_DIR
diff --git a/resources/linux/run.sh b/resources/linux/run.sh
deleted file mode 100644
index 6dbf8d69d..000000000
--- a/resources/linux/run.sh
+++ /dev/null
@@ -1,28 +0,0 @@
-#!/bin/bash
-# --------------------------------------------------------------------
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-# ---------------------------------------------------------------------
-
-# Directory of the script
-SOURCE="${BASH_SOURCE[0]}"
-while [ -h "$SOURCE" ]; do
-  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
-  SOURCE="$(readlink "$SOURCE")"
-  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
-done
-DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
-
-# Add custom libraries to LD_LIBRARY_PATH
-# TODO: Remomve the need for this
-env LD_LIBRARY_PATH=$DIR/qt/lib:$LD_LIBRARY_PATH QT_PLUGIN_PATH=$DIR/qt/plugins $DIR/OpenBoard "$@"

From b300432d313dfe53e5ae221a354f4db09ee77a4a Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Mon, 4 Jul 2022 15:37:12 +0200
Subject: [PATCH 3/3] feat: improve on-screen keyboard handling

- add detection function in UBPlatformUtils
- on linux check for onboard binary
- disable system OSK if not installed
- use DBus to show/hide onboard
---
 OpenBoard.pro                            |  1 +
 src/core/UBSettings.cpp                  |  5 +++
 src/frameworks/UBPlatformUtils.h         |  1 +
 src/frameworks/UBPlatformUtils_linux.cpp | 44 ++++++++++++++++++++----
 src/frameworks/UBPlatformUtils_mac.mm    |  5 +++
 src/frameworks/UBPlatformUtils_win.cpp   |  5 +++
 6 files changed, 54 insertions(+), 7 deletions(-)

diff --git a/OpenBoard.pro b/OpenBoard.pro
index 56f199d17..3ee98dc7a 100644
--- a/OpenBoard.pro
+++ b/OpenBoard.pro
@@ -42,6 +42,7 @@ QT += webenginewidgets
 QT += printsupport
 QT += core
 QT += concurrent
+linux: QT += dbus
 
 INCLUDEPATH += src
 
diff --git a/src/core/UBSettings.cpp b/src/core/UBSettings.cpp
index 0e02d358b..611d34459 100644
--- a/src/core/UBSettings.cpp
+++ b/src/core/UBSettings.cpp
@@ -475,6 +475,11 @@ void UBSettings::init()
 
     useSystemOnScreenKeyboard = new UBSetting(this, "App", "UseSystemOnScreenKeyboard", true);
 
+    if (!UBPlatformUtils::hasSystemOnScreenKeyboard())
+    {
+        useSystemOnScreenKeyboard->set(false);
+    }
+
     showDateColumnOnAlphabeticalSort = new UBSetting(this, "Document", "ShowDateColumnOnAlphabeticalSort", false);
     emptyTrashForOlderDocuments = new UBSetting(this, "Document", "emptyTrashForOlderDocuments", false);
     emptyTrashDaysValue = new UBSetting(this, "Document", "emptyTrashDaysValue", 30);
diff --git a/src/frameworks/UBPlatformUtils.h b/src/frameworks/UBPlatformUtils.h
index 59995c9d2..da9fd1295 100644
--- a/src/frameworks/UBPlatformUtils.h
+++ b/src/frameworks/UBPlatformUtils.h
@@ -198,6 +198,7 @@ class UBPlatformUtils
         static QString translationPath(QString pFilePrefix, QString pLanguage);
         static QString systemLanguage();
         static bool hasVirtualKeyboard();
+        static bool hasSystemOnScreenKeyboard();
         static void bringPreviousProcessToFront();
         static QString osUserLoginName();
         static void setDesktopMode(bool desktop);
diff --git a/src/frameworks/UBPlatformUtils_linux.cpp b/src/frameworks/UBPlatformUtils_linux.cpp
index cc4fae020..dfc033f5a 100644
--- a/src/frameworks/UBPlatformUtils_linux.cpp
+++ b/src/frameworks/UBPlatformUtils_linux.cpp
@@ -31,6 +31,8 @@
 
 #include <QtGui>
 #include <QApplication>
+#include <QDBusConnectionInterface>
+#include <QDBusInterface>
 
 #include <unistd.h>
 #include <X11/keysym.h>
@@ -73,6 +75,16 @@ void UBPlatformUtils::fadeDisplayIn()
     // NOOP
 }
 
+bool UBPlatformUtils::hasSystemOnScreenKeyboard()
+{
+    QProcess oskTestProcess;
+    oskTestProcess.start("which", QStringList() << "onboard");
+
+    return oskTestProcess.waitForFinished() &&
+                    oskTestProcess.exitStatus() == QProcess::NormalExit &&
+                    oskTestProcess.readAll() != "";
+}
+
 QStringList UBPlatformUtils::availableTranslations()
 {
     QString translationsPath = applicationResourcesDirectory() + "/" + "i18n" + "/";
@@ -449,13 +461,31 @@ void UBPlatformUtils::showFullScreen(QWidget *pWidget)
 
 void UBPlatformUtils::showOSK(bool show)
 {
-    QProcess oskProcess;
-
     if (show)
-        oskProcess.startDetached("/usr/bin/env", {"onboard"});
-
+    {
+        QDBusInterface dbus("org.onboard.Onboard", "/org/onboard/Onboard/Keyboard");
+
+        if (dbus.isValid())
+        {
+            dbus.call("Show");
+        }
+        else
+        {
+            qDebug() << "onboard not registered/installed";
+        }
+    }
+    // avoid starting onboard just to hide it, so check first if it's running
+    else if (QDBusConnection::sessionBus().interface()->isServiceRegistered("org.onboard.Onboard"))
+    {
+        QDBusInterface dbus("org.onboard.Onboard", "/org/onboard/Onboard/Keyboard");
+
+        if (dbus.isValid())
+        {
+            dbus.call("Hide");
+        }
+    }
     else
-        /* Not exactly a great solution, but it isn't possible to just
-         * close onboard through wmctrl or xdotool */
-        oskProcess.startDetached("pkill", {"-3", "onboard"});
+    {
+        qDebug() << "onboard not registered/installed";
+    }
 }
diff --git a/src/frameworks/UBPlatformUtils_mac.mm b/src/frameworks/UBPlatformUtils_mac.mm
index 3138861fd..5b01a8a64 100644
--- a/src/frameworks/UBPlatformUtils_mac.mm
+++ b/src/frameworks/UBPlatformUtils_mac.mm
@@ -204,6 +204,11 @@ OSStatus emptySetSystemUIMode (
     }
 }
 
+bool UBPlatformUtils::hasSystemOnScreenKeyboard()
+{
+    return true;
+}
+
 QStringList UBPlatformUtils::availableTranslations()
 {
     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
diff --git a/src/frameworks/UBPlatformUtils_win.cpp b/src/frameworks/UBPlatformUtils_win.cpp
index 73d611e22..d4c00bd90 100644
--- a/src/frameworks/UBPlatformUtils_win.cpp
+++ b/src/frameworks/UBPlatformUtils_win.cpp
@@ -75,6 +75,11 @@ void UBPlatformUtils::fadeDisplayIn()
     // NOOP
 }
 
+bool UBPlatformUtils::hasSystemOnScreenKeyboard()
+{
+    return true;
+}
+
 QStringList UBPlatformUtils::availableTranslations()
 {
     QString translationsPath = applicationResourcesDirectory() + "/" + "i18n" + "/";
