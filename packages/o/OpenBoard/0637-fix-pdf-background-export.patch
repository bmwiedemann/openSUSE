From a9c28a03b02f8b9064300f9d198ba77f79bbfc6b Mon Sep 17 00:00:00 2001
From: letsfindaway <me@letsfindaway.de>
Date: Wed, 22 Jun 2022 09:30:31 +0200
Subject: [PATCH] fix: restore PDF background export

- was not enabled with UBExportFullPDF
- however do not draw background grid/color if a background PDF is used
---
 src/adaptors/UBExportFullPDF.cpp | 27 ++++++++++++++++-----------
 1 file changed, 16 insertions(+), 11 deletions(-)

diff --git a/src/adaptors/UBExportFullPDF.cpp b/src/adaptors/UBExportFullPDF.cpp
index a2bd2e065..3e058119a 100644
--- a/src/adaptors/UBExportFullPDF.cpp
+++ b/src/adaptors/UBExportFullPDF.cpp
@@ -108,21 +108,12 @@ void UBExportFullPDF::saveOverlayPdf(UBDocumentProxy* pDocumentProxy, const QStr
         for(int pageIndex = 0 ; pageIndex < pDocumentProxy->pageCount(); pageIndex++)
         {
             UBGraphicsScene* scene = UBPersistenceManager::persistenceManager()->loadDocumentScene(pDocumentProxy, pageIndex);
-            // set background to white, no grid for PDF output
+            // set background according to PDF export settings
             bool isDark = scene->isDarkBackground();
             UBPageBackground pageBackground = scene->pageBackground();
 
             bool exportDark = isDark && UBSettings::settings()->exportBackgroundColor->get().toBool();
 
-            if (UBSettings::settings()->exportBackgroundGrid->get().toBool())
-            {
-                scene->setBackground(exportDark, pageBackground);
-            }
-            else
-            {
-                scene->setBackground(exportDark, UBPageBackground::plain);
-            }
-
             // set high res rendering
             scene->setRenderingQuality(UBItem::RenderingQualityHigh, UBItem::CacheNotAllowed);
             scene->setRenderingContext(UBGraphicsScene::PdfExport);
@@ -141,8 +132,22 @@ void UBExportFullPDF::saveOverlayPdf(UBDocumentProxy* pDocumentProxy, const QStr
 
             if (pageIndex != 0) pdfPrinter.newPage();
 
+            // do not draw background color and grid if scene has PDF background
+            if (mHasPDFBackgrounds)
+            {
+                scene->setDrawingMode(true);
+                scene->setBackground(false, UBPageBackground::plain);
+            }
+            else if (UBSettings::settings()->exportBackgroundGrid->get().toBool())
+            {
+                scene->setBackground(exportDark, pageBackground);
+            }
+            else
+            {
+                scene->setBackground(exportDark, UBPageBackground::plain);
+            }
+
             //render to PDF
-            scene->setDrawingMode(true);
             scene->render(pdfPainter, QRectF(), scene->normalizedSceneRect());
 
             //restore screen rendering quality
