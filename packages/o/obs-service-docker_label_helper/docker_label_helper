#!/bin/bash
set -eu

if [ "${BUILD_DIST+x}" != "x" ]; then
	echo "Not running in an OBS build container"
	exit 1
fi

BUILD_DATA="${BUILD_DIST/.dist/.data}"
if [ -e "${BUILD_DATA}" ]; then
	. "${BUILD_DATA}"

	# The build script renames the recipe (to strip _service:foo:), but doesn't update .data
	RECIPEFILE="${RECIPEFILE##*:}"

	if [ "${RECIPEFILE}" != "Dockerfile" ]; then
		echo "Recipe is not a Dockerfile - exiting"
		exit 0
	fi
fi

gawk -i inplace '
    match($0, /^# labelprefix=(.*)$/, m) { labelprefix=m[1]; next }
    labelprefix != "" && match($0, /^(PREFIXED)?LABEL .*\.([^.]*)=(.*)$/, m) { printf "LABEL %s.%s=%s\n", labelprefix, m[2], m[3]; $1 = "LABEL" }
    match($0, /^# endlabelprefix/) { labelprefix=""; next }
    1' Dockerfile
