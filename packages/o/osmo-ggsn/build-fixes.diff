
* stuff is in the wrong directory, move to sbin
* CFLAGS is abused for preprocessor, move to CPPFLAGS
* add missing $(LIBGTPNL_CFLAGS)
* ggsn includes libmnl.h but fails to PKG_CHECK for it;
  turns out it only uses the header and no defs, so kill that.
* _DEPENDENCIES on files not generated by $this Makefile are pointless
* must use .la files in _LDADD/_LIBADD whenever they exist
* remove AC_PROG_CXX, the C++ is never used

---
 ggsn/Makefile.am      |   10 +++++-----
 gtp/Makefile.am       |    3 ++-
 lib/Makefile.am       |   10 ++++++----
 lib/gtp-kernel.c      |    5 +----
 sgsnemu/Makefile.am   |   10 +++++-----
 tests/gtp/Makefile.am |    2 +-
 tests/lib/Makefile.am |    4 ++--
 7 files changed, 22 insertions(+), 22 deletions(-)

Index: osmo-ggsn-1.6.0/ggsn/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/ggsn/Makefile.am
+++ osmo-ggsn-1.6.0/ggsn/Makefile.am
@@ -1,15 +1,15 @@
-bin_PROGRAMS = osmo-ggsn
+sbin_PROGRAMS = osmo-ggsn
 
 AM_LDFLAGS = @EXEC_LDFLAGS@
 
-AM_CFLAGS = -O2 -D_GNU_SOURCE -fno-builtin -Wall -DSBINDIR='"$(sbindir)"' -ggdb $(LIBOSMOCORE_CFLAGS) $(LIBOSMOCTRL_CFLAGS) $(LIBOSMOVTY_CFLAGS)
+AM_CPPFLAGS = -D_GNU_SOURCE -DSBINDIR='"$(sbindir)"' $(LIBOSMOCORE_CFLAGS) $(LIBOSMOCTRL_CFLAGS) $(LIBOSMOVTY_CFLAGS)
+AM_CFLAGS = -fno-builtin -Wall
 
-osmo_ggsn_LDADD = @EXEC_LDADD@ -lgtp -L../gtp ../lib/libmisc.a $(LIBOSMOCORE_LIBS) $(LIBOSMOCTRL_LIBS) $(LIBOSMOVTY_LIBS)
+osmo_ggsn_LDADD = @EXEC_LDADD@ ../gtp/libgtp.la ../lib/libmisc.la $(LIBOSMOCORE_LIBS) $(LIBOSMOCTRL_LIBS) $(LIBOSMOVTY_LIBS)
 
 if ENABLE_GTP_KERNEL
-AM_CFLAGS += -DGTP_KERNEL $(LIBGTPNL_CFLAGS)
+AM_CPPFLAGS += -DGTP_KERNEL $(LIBGTPNL_CFLAGS)
 osmo_ggsn_LDADD += $(LIBGTPNL_LIBS)
 endif
 
-osmo_ggsn_DEPENDENCIES = ../gtp/libgtp.la ../lib/libmisc.a
 osmo_ggsn_SOURCES = ggsn_main.c ggsn_vty.c ggsn.c ggsn.h sgsn.c sgsn.h pco.c pco.h
Index: osmo-ggsn-1.6.0/gtp/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/gtp/Makefile.am
+++ osmo-ggsn-1.6.0/gtp/Makefile.am
@@ -8,7 +8,8 @@ lib_LTLIBRARIES = libgtp.la
 
 include_HEADERS = gtp.h pdp.h gtpie.h
 
-AM_CFLAGS = -O2 -fno-builtin -Wall -DSBINDIR='"$(sbindir)"' -ggdb $(LIBOSMOCORE_CFLAGS)
+AM_CPPFLAGS = -DSBINDIR='"$(sbindir)"' $(LIBOSMOCORE_CFLAGS)
+AM_CFLAGS = -O2 -fno-builtin -Wall -ggdb
 
 libgtp_la_SOURCES = gtp.c gtp.h gtpie.c gtpie.h pdp.c pdp.h lookupa.c lookupa.h queue.c queue.h
 libgtp_la_LDFLAGS = -version-info $(LIBVERSION) -no-undefined
Index: osmo-ggsn-1.6.0/lib/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/lib/Makefile.am
+++ osmo-ggsn-1.6.0/lib/Makefile.am
@@ -1,12 +1,14 @@
-noinst_LIBRARIES = libmisc.a
+noinst_LTLIBRARIES = libmisc.la
 
 noinst_HEADERS = gnugetopt.h ippool.h lookup.h syserr.h tun.h in46_addr.h netdev.h gtp-kernel.h netns.h util.h icmpv6.h checksum.h
 
-AM_CFLAGS = -O2 -fno-builtin -Wall -DSBINDIR='"$(sbindir)"' -ggdb $(LIBOSMOCORE_CFLAGS)
+AM_CPPFLAGS = -DSBINDIR='"$(sbindir)"' -ggdb $(LIBOSMOCORE_CFLAGS)
+AM_CFLAGS = -O2 -fno-builtin -Wall
 
-libmisc_a_SOURCES = getopt1.c getopt.c ippool.c lookup.c tun.c debug.c in46_addr.c netdev.c netns.c util.c icmpv6.c checksum.c
+libmisc_la_LIBADD = ${LIBOSMOCORE_LIBS}
+libmisc_la_SOURCES = getopt1.c getopt.c ippool.c lookup.c tun.c debug.c in46_addr.c netdev.c netns.c util.c icmpv6.c checksum.c
 
 if ENABLE_GTP_KERNEL
 AM_CFLAGS += -DGTP_KERNEL $(LIBGTPNL_CFLAGS)
-libmisc_a_SOURCES += gtp-kernel.c
+libmisc_la_SOURCES += gtp-kernel.c
 endif
Index: osmo-ggsn-1.6.0/lib/gtp-kernel.c
===================================================================
--- osmo-ggsn-1.6.0.orig/lib/gtp-kernel.c
+++ osmo-ggsn-1.6.0/lib/gtp-kernel.c
@@ -18,8 +18,6 @@
 
 #include <libgtpnl/gtp.h>
 #include <libgtpnl/gtpnl.h>
-#include <libmnl/libmnl.h>
-
 #include <errno.h>
 
 #include <time.h>
@@ -33,8 +31,6 @@
 
 #include <libgtpnl/gtp.h>
 #include <libgtpnl/gtpnl.h>
-#include <libmnl/libmnl.h>
-
 #include "gtp-kernel.h"
 
 static void pdp_debug(const char *prefix, const char *devname, struct pdp_t *pdp)
@@ -58,6 +54,7 @@ static void pdp_debug(const char *prefix
 		buf4, buf6, inet_ntoa(ia));
 }
 
+struct mnl_socket;
 static struct {
 	int			genl_id;
 	struct mnl_socket	*nl;
Index: osmo-ggsn-1.6.0/sgsnemu/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/sgsnemu/Makefile.am
+++ osmo-ggsn-1.6.0/sgsnemu/Makefile.am
@@ -1,15 +1,15 @@
-bin_PROGRAMS = sgsnemu
+sbin_PROGRAMS = sgsnemu
 
 AM_LDFLAGS = @EXEC_LDFLAGS@
 
-AM_CFLAGS = -O2 -D_GNU_SOURCE -fno-builtin -Wall -DSBINDIR='"$(sbindir)"' -ggdb $(LIBOSMOCORE_CFLAGS)
+AM_CPPFLAGS = -D_GNU_SOURCE -DSBINDIR='"$(sbindir)"' $(LIBOSMOCORE_CFLAGS)
+AM_CFLAGS = -fno-builtin -Wall
 
-sgsnemu_LDADD = @EXEC_LDADD@ -lgtp -L../gtp ../lib/libmisc.a $(LIBOSMOCORE_LIBS)
+sgsnemu_LDADD = @EXEC_LDADD@ ../gtp/libgtp.la ../lib/libmisc.la $(LIBOSMOCORE_LIBS)
 
 if ENABLE_GTP_KERNEL
-AM_CFLAGS += -DGTP_KERNEL $(LIBGTPNL_CFLAGS)
+AM_CPPFLAGS += -DGTP_KERNEL $(LIBGTPNL_CFLAGS)
 sgsnemu_LDADD += $(LIBGTPNL_LIBS)
 endif
 
-sgsnemu_DEPENDENCIES = ../gtp/libgtp.la ../lib/libmisc.a
 sgsnemu_SOURCES = sgsnemu.c cmdline.c cmdline.h
Index: osmo-ggsn-1.6.0/tests/gtp/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/tests/gtp/Makefile.am
+++ osmo-ggsn-1.6.0/tests/gtp/Makefile.am
@@ -19,7 +19,7 @@ queue_test_SOURCES = \
 	$(NULL)
 
 gtpie_test_LDADD = \
-	$(top_builddir)/lib/debug.o \
+	$(top_builddir)/lib/debug.lo \
 	$(top_builddir)/gtp/libgtp.la \
 	$(LIBOSMOCORE_LIBS) \
 	$(NULL)
Index: osmo-ggsn-1.6.0/tests/lib/Makefile.am
===================================================================
--- osmo-ggsn-1.6.0.orig/tests/lib/Makefile.am
+++ osmo-ggsn-1.6.0/tests/lib/Makefile.am
@@ -14,7 +14,7 @@ ippool_test_SOURCES = \
 	$(NULL)
 
 ippool_test_LDADD = \
-	$(top_builddir)/lib/libmisc.a \
+	$(top_builddir)/lib/libmisc.la \
 	$(LIBOSMOCORE_LIBS) \
 	$(NULL)
 
@@ -23,6 +23,6 @@ in46a_test_SOURCES = \
 	$(NULL)
 
 in46a_test_LDADD = \
-	$(top_builddir)/lib/libmisc.a \
+	$(top_builddir)/lib/libmisc.la \
 	$(LIBOSMOCORE_LIBS) \
 	$(NULL)
