--- a/common/gdm-common.c
+++ b/common/gdm-common.c
@@ -619,6 +619,8 @@ gdm_get_script_environment (const char *
 
         if (display_hostname) {
                 g_hash_table_insert (hash, g_strdup ("REMOTE_HOST"), g_strdup (display_hostname));
+        } else {
+                g_hash_table_insert (hash, g_strdup ("XAUTHLOCALHOSTNAME"), gdm_gethostname ());
         }
 
         /* Runs as root */
@@ -1085,3 +1087,14 @@ gdm_load_env_d (GdmLoadEnvVarFunc load_e
         gdm_load_env_dir (dir, load_env_func, expand_func, user_data);
         g_object_unref (dir);
 }
+
+char *
+gdm_gethostname (void)
+{
+        char localhost[HOST_NAME_MAX + 1] = "";
+        if (gethostname (localhost, HOST_NAME_MAX) == 0) {
+                return g_strdup (localhost);
+        } else {
+                return g_strdup ("localhost");
+        }
+}
--- a/common/gdm-common.h
+++ b/common/gdm-common.h
@@ -70,6 +70,7 @@ char          *gdm_generate_random_bytes
 gboolean       gdm_get_login_window_session_id (const char  *seat_id,
                                                 char       **session_id);
 gboolean       gdm_goto_login_session    (GError **error);
+char          *gdm_gethostname           (void);
 
 GPtrArray     *gdm_get_script_environment (const char *username,
                                            const char *display_name,
--- a/daemon/gdm-display-access-file.c
+++ b/daemon/gdm-display-access-file.c
@@ -449,13 +449,10 @@ _get_auth_info_for_display (GdmDisplayAc
                  *
                  * https://bugs.freedesktop.org/show_bug.cgi?id=43425
                  */
-                char localhost[HOST_NAME_MAX + 1] = "";
                 *family = FamilyLocal;
-                if (gethostname (localhost, HOST_NAME_MAX) == 0) {
-                        *address = g_strdup (localhost);
-                } else {
-                        *address = g_strdup ("localhost");
-                }
+               /* using the new function we create in the patch, to detect
+		* changes here, in the original code */
+		*address = gdm_gethostname ();
         } else {
                 *family = FamilyWild;
                 gdm_display_get_remote_hostname (display, address, NULL);
--- a/daemon/gdm-launch-environment.c
+++ b/daemon/gdm-launch-environment.c
@@ -225,6 +225,11 @@ build_launch_environment (GdmLaunchEnvir
                 g_hash_table_insert (hash, g_strdup ("GDM_SEAT_ID"), g_strdup (seat_id));
         }
 
+        if (launch_environment->x11_display_is_local) {
+                g_hash_table_remove (hash, "XAUTHLOCALHOSTNAME");
+                g_hash_table_insert (hash, g_strdup ("XAUTHLOCALHOSTNAME"), gdm_gethostname ());
+        }
+
         g_hash_table_insert (hash, g_strdup ("RUNNING_UNDER_GDM"), g_strdup ("true"));
 
         /* Now populate XDG_DATA_DIRS from env.d if we're running initial setup; this allows
--- a/daemon/gdm-session.c
+++ b/daemon/gdm-session.c
@@ -2751,6 +2751,14 @@ set_up_session_environment (GdmSession *
                 }
         }
 
+        if (self->display_is_local) {
+                char *hostname = gdm_gethostname ();
+                gdm_session_set_environment_variable (self,
+                                                      "XAUTHLOCALHOSTNAME",
+                                                      hostname);
+                g_free (hostname);
+        }
+
         if (g_getenv ("WINDOWPATH") != NULL) {
                 gdm_session_set_environment_variable (self,
                                                       "WINDOWPATH",
