From aeccd4691acdba64bcb2622be45d80735b0c61be Mon Sep 17 00:00:00 2001
From: Michal Rostecki <mrostecki@opensuse.org>
Date: Tue, 5 Nov 2019 01:33:28 +0100
Subject: [PATCH] bazel: Replace boringssl with openssl

Signed-off-by: Michal Rostecki <mrostecki@opensuse.org>
---
 BUILD               |    8 ++------
 WORKSPACE           |   18 ++++++++++++++++++
 bazel/grpc_deps.bzl |   13 -------------
 3 files changed, 20 insertions(+), 19 deletions(-)

Index: grpc-1.25.0/BUILD
===================================================================
--- grpc-1.25.0.orig/BUILD
+++ grpc-1.25.0/BUILD
@@ -1915,15 +1915,13 @@ grpc_cc_library(
         "src/core/tsi/alts/zero_copy_frame_protector/alts_zero_copy_grpc_protector.h",
         "src/core/tsi/transport_security_grpc.h",
     ],
-    external_deps = [
-        "libssl",
-    ],
     language = "c++",
     deps = [
         "gpr",
         "grpc_base",
         "grpc_shadow_boringssl",
         "tsi_interface",
+        "@openssl//:openssl-lib",
     ],
 )
 
@@ -1982,9 +1980,6 @@ grpc_cc_library(
         "src/core/tsi/ssl_types.h",
         "src/core/tsi/transport_security_grpc.h",
     ],
-    external_deps = [
-        "libssl",
-    ],
     language = "c++",
     deps = [
         "alts_frame_protector",
@@ -1994,6 +1989,7 @@ grpc_cc_library(
         "grpc_shadow_boringssl",
         "grpc_transport_chttp2_client_insecure",
         "tsi_interface",
+        "@openssl//:openssl-lib",
     ],
 )
 
Index: grpc-1.25.0/WORKSPACE
===================================================================
--- grpc-1.25.0.orig/WORKSPACE
+++ grpc-1.25.0/WORKSPACE
@@ -4,6 +4,24 @@ load("@bazel_tools//tools/build_defs/rep
 load("//bazel:grpc_deps.bzl", "grpc_deps", "grpc_test_only_deps")
 load("@bazel_tools//tools/build_defs/repo:git.bzl", "git_repository")
 
+GRPC_BUILD_CONTENT = """
+cc_library(
+    name = "openssl-lib",
+    srcs = [
+        "libssl.so.1.1",
+        "libcrypto.so.1.1",
+    ],
+    visibility = ["//visibility:public"],
+    linkstatic = False,
+)
+"""
+
+new_local_repository(
+    name = "openssl",
+    path = "%LIBDIR%",
+    build_file_content = GRPC_BUILD_CONTENT,
+)
+
 grpc_deps()
 
 grpc_test_only_deps()
Index: grpc-1.25.0/bazel/grpc_deps.bzl
===================================================================
--- grpc-1.25.0.orig/bazel/grpc_deps.bzl
+++ grpc-1.25.0/bazel/grpc_deps.bzl
@@ -23,11 +23,6 @@ def grpc_deps():
     )
 
     native.bind(
-        name = "libssl",
-        actual = "@boringssl//:ssl",
-    )
-
-    native.bind(
         name = "madler_zlib",
         actual = "@zlib//:zlib",
     )
@@ -97,14 +92,6 @@ def grpc_deps():
         actual = "@io_opencensus_cpp//opencensus/stats:test_utils",
     )
 
-    if "boringssl" not in native.existing_rules():
-        http_archive(
-            name = "boringssl",
-            # NOTE: This URL generates a tarball containing dynamic date
-            # information, so the sha256 is not consistent.
-            url = "https://boringssl.googlesource.com/boringssl/+archive/83da28a68f32023fd3b95a8ae94991a07b1f6c62.tar.gz",
-        )
-
     if "zlib" not in native.existing_rules():
         http_archive(
             name = "zlib",
