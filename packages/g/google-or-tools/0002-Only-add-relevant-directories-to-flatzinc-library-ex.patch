From 283756dfec1c4ea8ac4d83403edf6b504eb8d43d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20Br=C3=BCns?= <stefan.bruens@rwth-aachen.de>
Date: Fri, 15 Jul 2022 17:02:31 +0200
Subject: [PATCH 2/3] Only add relevant directories to flatzinc
 library/executable RUNPATHs

The flatzinc library is installed to the same location (LIBDIR) as the
ortools library, so "$ORIGIN" suffices.
The executables should use the relative path between LIBDIR and BINDIR.
---
 cmake/flatzinc.cmake | 22 ++++++++++++++--------
 1 file changed, 14 insertions(+), 8 deletions(-)

diff --git a/cmake/flatzinc.cmake b/cmake/flatzinc.cmake
index 27cef073f7..c6ee1f879b 100644
--- a/cmake/flatzinc.cmake
+++ b/cmake/flatzinc.cmake
@@ -93,6 +93,9 @@ target_compile_options(flatzinc PUBLIC ${FLATZINC_COMPILE_OPTIONS})
 ## Properties
 if(NOT APPLE)
   set_target_properties(flatzinc PROPERTIES VERSION ${PROJECT_VERSION})
+  if(UNIX)
+    set_target_properties(flatzinc PROPERTIES INSTALL_RPATH "$ORIGIN")
+  endif()
 else()
   # Clang don't support version x.y.z with z > 255
   set_target_properties(flatzinc PROPERTIES
@@ -115,14 +118,6 @@ endif()
 add_library(${PROJECT_NAMESPACE}::flatzinc ALIAS flatzinc)
 
 
-if(APPLE)
-  set(CMAKE_INSTALL_RPATH
-    "@loader_path/../${CMAKE_INSTALL_LIBDIR};@loader_path")
-elseif(UNIX)
-  set(CMAKE_INSTALL_RPATH "$ORIGIN/../${CMAKE_INSTALL_LIBDIR}:$ORIGIN/../lib64:$ORIGIN/../lib:$ORIGIN")
-endif()
-
-
 # fzn-ortools Binary
 add_executable(fzn
   ortools/flatzinc/fz.cc
@@ -146,6 +141,17 @@ target_compile_options(fzn PUBLIC ${FLATZINC_COMPILE_OPTIONS})
 target_link_libraries(fzn PRIVATE ${PROJECT_NAMESPACE}::flatzinc)
 ## Alias
 add_executable(${PROJECT_NAME}::fzn ALIAS fzn)
+## INSTALL_RPATH
+if(APPLE)
+  set_target_properties(fzn PROPERTIES
+                        INSTALL_RPATH "@loader_path/../${CMAKE_INSTALL_LIBDIR};@loader_path")
+elseif(UNIX)
+  cmake_path(RELATIVE_PATH CMAKE_INSTALL_FULL_LIBDIR
+             BASE_DIRECTORY ${CMAKE_INSTALL_FULL_BINDIR}
+             OUTPUT_VARIABLE libdir_relative_path)
+  set_target_properties(fzn PROPERTIES
+                        INSTALL_RPATH "$ORIGIN/${libdir_relative_path}")
+endif()
 
 
 # Parser-main Binary
-- 
2.40.1

