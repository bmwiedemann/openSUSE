From 9817df63fb9eae342d5bf6f28f526aa09b17e8de Mon Sep 17 00:00:00 2001
From: Miikka Heikkinen <miikka.heikkinen@qt.io>
Date: Thu, 20 Apr 2023 15:26:09 +0300
Subject: [PATCH] QmlDesigner: Fix puppet build after quick3d private API
 changes

Change-Id: I3668853886306fe00d5da916aa458559964a9af0
Reviewed-by: Mahmoud Badri <mahmoud.badri@qt.io>
Reviewed-by: Qt CI Bot <qt_ci_bot@qt-project.org>
---
 .../qml2puppet/editor3d/generalhelper.cpp        | 16 ++++++++++++++--
 .../qml2puppet/editor3d/selectionboxgeometry.cpp | 10 ++++++++--
 2 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/src/tools/qml2puppet/qml2puppet/editor3d/generalhelper.cpp b/src/tools/qml2puppet/qml2puppet/editor3d/generalhelper.cpp
index 829a6f0edb..52a3f6d74a 100644
--- a/src/tools/qml2puppet/qml2puppet/editor3d/generalhelper.cpp
+++ b/src/tools/qml2puppet/qml2puppet/editor3d/generalhelper.cpp
@@ -215,6 +215,7 @@ QVector4D GeneralHelper::focusNodesToCamera(QQuick3DCamera *camera, float defaul
             if (auto renderModel = static_cast<QSSGRenderModel *>(targetPriv->spatialNode)) {
                 QWindow *window = static_cast<QWindow *>(viewPort->window());
                 if (window) {
+#if QT_VERSION < QT_VERSION_CHECK(6, 5, 1)
                     QSSGRef<QSSGRenderContextInterface> context;
 #if QT_VERSION < QT_VERSION_CHECK(6, 0, 0)
                     context = QSSGRenderContextInterface::getRenderContextInterface(quintptr(window));
@@ -222,12 +223,17 @@ QVector4D GeneralHelper::focusNodesToCamera(QQuick3DCamera *camera, float defaul
                     context = targetPriv->sceneManager->rci;
 #endif
                     if (!context.isNull()) {
+#else
+                    const auto &sm = targetPriv->sceneManager;
+                    auto context = sm->wattached ? sm->wattached->rci().get() : nullptr;
+                    if (context) {
+#endif
                         QSSGBounds3 bounds;
                         auto geometry = qobject_cast<SelectionBoxGeometry *>(model->geometry());
                         if (geometry) {
                             bounds = geometry->bounds();
                         } else {
-                            auto bufferManager = context->bufferManager();
+                            const auto &bufferManager(context->bufferManager());
 #if QT_VERSION < QT_VERSION_CHECK(6, 3, 0)
                             bounds = renderModel->getModelBounds(bufferManager);
 #else
@@ -889,6 +895,7 @@ bool GeneralHelper::getBounds(QQuick3DViewport *view3D, QQuick3DNode *node, QVec
         if (auto renderModel = static_cast<QSSGRenderModel *>(renderNode)) {
             QWindow *window = static_cast<QWindow *>(view3D->window());
             if (window) {
+#if QT_VERSION < QT_VERSION_CHECK(6, 5, 1)
                 QSSGRef<QSSGRenderContextInterface> context;
 #if QT_VERSION < QT_VERSION_CHECK(6, 0, 0)
                 context = QSSGRenderContextInterface::getRenderContextInterface(quintptr(window));
@@ -896,7 +903,12 @@ bool GeneralHelper::getBounds(QQuick3DViewport *view3D, QQuick3DNode *node, QVec
                 context = QQuick3DObjectPrivate::get(node)->sceneManager->rci;
 #endif
                 if (!context.isNull()) {
-                    auto bufferManager = context->bufferManager();
+#else
+                const auto &sm = QQuick3DObjectPrivate::get(node)->sceneManager;
+                auto context = sm->wattached ? sm->wattached->rci().get() : nullptr;
+                if (context) {
+#endif
+                    const auto &bufferManager(context->bufferManager());
 #if QT_VERSION < QT_VERSION_CHECK(6, 3, 0)
                     QSSGBounds3 bounds = renderModel->getModelBounds(bufferManager);
 #else
diff --git a/src/tools/qml2puppet/qml2puppet/editor3d/selectionboxgeometry.cpp b/src/tools/qml2puppet/qml2puppet/editor3d/selectionboxgeometry.cpp
index 8a2a244996..1157b1c5f8 100644
--- a/src/tools/qml2puppet/qml2puppet/editor3d/selectionboxgeometry.cpp
+++ b/src/tools/qml2puppet/qml2puppet/editor3d/selectionboxgeometry.cpp
@@ -312,14 +312,20 @@ void SelectionBoxGeometry::getBounds(
         if (auto renderModel = static_cast<QSSGRenderModel *>(renderNode)) {
             QWindow *window = static_cast<QWindow *>(m_view3D->window());
             if (window) {
+#if QT_VERSION < QT_VERSION_CHECK(6, 5, 1)
                 QSSGRef<QSSGRenderContextInterface> context;
 #if QT_VERSION < QT_VERSION_CHECK(6, 0, 0)
                 context = QSSGRenderContextInterface::getRenderContextInterface(quintptr(window));
-#else
+#elif QT_VERSION < QT_VERSION_CHECK(6, 5, 1)
                 context = QQuick3DObjectPrivate::get(this)->sceneManager->rci;
 #endif
                 if (!context.isNull()) {
-                    auto bufferManager = context->bufferManager();
+#else
+                const auto &sm = QQuick3DObjectPrivate::get(this)->sceneManager;
+                auto context = sm->wattached ? sm->wattached->rci().get() : nullptr;
+                if (context) {
+#endif
+                    const auto &bufferManager(context->bufferManager());
 #if QT_VERSION < QT_VERSION_CHECK(6, 3, 0)
                     QSSGBounds3 bounds = renderModel->getModelBounds(bufferManager);
 #else
-- 
2.40.1

