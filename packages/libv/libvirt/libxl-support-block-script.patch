libxl: set script field of libxl_device_disk

Add a hack to the libvirt libxl driver to set
libxl_device_disk->script when the disk configuration starts
with some well-known Xen external block scripts: dmmd, drbd,
and npiv.

For more details, see bsc#954872 and FATE#319810

Index: libvirt-5.10.0/src/libxl/libxl_conf.c
===================================================================
--- libvirt-5.10.0.orig/src/libxl/libxl_conf.c
+++ libvirt-5.10.0/src/libxl/libxl_conf.c
@@ -869,6 +869,25 @@ libxlDiskSetDiscard(libxl_device_disk *x
 #endif
 }
 
+static int
+libxlDiskSetScript(libxl_device_disk *x_disk, const char *disk_spec)
+{
+    if (disk_spec == NULL)
+        return 0;
+
+    if (STRPREFIX(disk_spec, "dmmd:")) {
+        if (VIR_STRDUP(x_disk->script, "block-dmmd") < 0)
+            return -1;
+    } else if (STRPREFIX(disk_spec, "drbd:")) {
+        if (VIR_STRDUP(x_disk->script, "block-drbd") < 0)
+            return -1;
+    } else if (STRPREFIX(disk_spec, "npiv:")) {
+        if (VIR_STRDUP(x_disk->script, "block-npiv") < 0)
+            return -1;
+    }
+    return 0;
+}
+
 static void
 libxlDiskSetCacheMode(libxl_device_disk *x_disk, int cachemode)
 {
@@ -1009,6 +1028,7 @@ libxlMakeNetworkDiskSrc(virStorageSource
 int
 libxlMakeDisk(virDomainDiskDefPtr l_disk, libxl_device_disk *x_disk)
 {
+    const char *src = virDomainDiskGetSource(l_disk);
     const char *driver = virDomainDiskGetDriver(l_disk);
     int format = virDomainDiskGetFormat(l_disk);
     int actual_type = virStorageSourceGetActualType(l_disk->src);
@@ -1024,7 +1044,7 @@ libxlMakeDisk(virDomainDiskDefPtr l_disk
         if (libxlMakeNetworkDiskSrc(l_disk->src, &x_disk->pdev_path) < 0)
             return -1;
     } else {
-        x_disk->pdev_path = g_strdup(virDomainDiskGetSource(l_disk));
+        x_disk->pdev_path = g_strdup(src);
     }
 
     x_disk->vdev = g_strdup(l_disk->dst);
@@ -1135,6 +1155,9 @@ libxlMakeDisk(virDomainDiskDefPtr l_disk
     if (libxlDiskSetDiscard(x_disk, l_disk->discard) < 0)
         return -1;
     libxlDiskSetCacheMode(x_disk, l_disk->cachemode);
+    if (libxlDiskSetScript(x_disk, src) < 0)
+        return -1;
+
     /* An empty CDROM must have the empty format, otherwise libxl fails. */
     if (x_disk->is_cdrom && !x_disk->pdev_path)
         x_disk->format = LIBXL_DISK_FORMAT_EMPTY;
