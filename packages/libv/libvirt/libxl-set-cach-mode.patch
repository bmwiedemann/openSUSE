https://bugzilla.novell.com/show_bug.cgi?id=879425
---
 src/libxl/libxl_conf.c |   25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

Index: libvirt-6.4.0/src/libxl/libxl_conf.c
===================================================================
--- libvirt-6.4.0.orig/src/libxl/libxl_conf.c
+++ libvirt-6.4.0/src/libxl/libxl_conf.c
@@ -905,6 +905,30 @@ libxlDiskSetDiscard(libxl_device_disk *x
 #endif
 }
 
+static void
+libxlDiskSetCacheMode(libxl_device_disk *x_disk, int cachemode)
+{
+    switch (cachemode) {
+#if defined(LIBXL_HAVE_LIBXL_DEVICE_DISK_DISABLE_FLUSH_MAGIC)
+    case VIR_DOMAIN_DISK_CACHE_UNSAFE:
+        if (x_disk->readwrite)
+            x_disk->readwrite = (x_disk->readwrite & LIBXL_HAVE_LIBXL_DEVICE_DISK_DISABLE_FLUSH_MASK) | LIBXL_HAVE_LIBXL_DEVICE_DISK_DISABLE_FLUSH_MAGIC;
+        break;
+#endif
+#if defined(LIBXL_HAVE_DEVICE_DISK_DIRECT_IO_SAFE)
+    case VIR_DOMAIN_DISK_CACHE_DIRECTSYNC:
+        x_disk->direct_io_safe = true;
+        break;
+#endif
+    case VIR_DOMAIN_DISK_CACHE_DEFAULT:
+    case VIR_DOMAIN_DISK_CACHE_DISABLE:
+    case VIR_DOMAIN_DISK_CACHE_WRITETHRU:
+    case VIR_DOMAIN_DISK_CACHE_WRITEBACK:
+    default:
+        break;
+    }
+}
+
 static char *
 libxlMakeNetworkDiskSrcStr(virStorageSourcePtr src,
                            const char *username,
@@ -1146,6 +1170,7 @@ libxlMakeDisk(virDomainDiskDefPtr l_disk
     x_disk->is_cdrom = l_disk->device == VIR_DOMAIN_DISK_DEVICE_CDROM ? 1 : 0;
     if (libxlDiskSetDiscard(x_disk, l_disk->discard) < 0)
         return -1;
+    libxlDiskSetCacheMode(x_disk, l_disk->cachemode);
     /* An empty CDROM must have the empty format, otherwise libxl fails. */
     if (x_disk->is_cdrom && !x_disk->pdev_path)
         x_disk->format = LIBXL_DISK_FORMAT_EMPTY;
