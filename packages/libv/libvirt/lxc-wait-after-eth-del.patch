From 7d83ea171dc86bdec171e14ffdbde8ae7e06fc7a Mon Sep 17 00:00:00 2001
From: Jim Fehlig <jfehlig@suse.com>
Date: Tue, 5 Jul 2022 13:50:31 -0600
Subject: Wait for udev events to be handled after removing veth

As per http://www.redhat.com/archives/libvir-list/2013-July/msg01279.html,
wait for udev events to be handled after removing a virtual NIC.
Any udev rule associated to NIC destroy could happen to run with a new
device with the same name that is being created.

From: <cbosdonnat@suse.com>
---
 src/lxc/lxc_controller.c | 1 +
 src/lxc/lxc_driver.c     | 2 ++
 src/lxc/lxc_process.c    | 1 +
 3 files changed, 4 insertions(+)

Index: libvirt-8.10.0/src/lxc/lxc_controller.c
===================================================================
--- libvirt-8.10.0.orig/src/lxc/lxc_controller.c
+++ libvirt-8.10.0/src/lxc/lxc_controller.c
@@ -1997,6 +1997,7 @@ static int virLXCControllerDeleteInterfa
         if (virNetDevVethDelete(ctrl->veths[i]) < 0)
             ret = -1;
     }
+    virWaitForDevices();
 
     return ret;
 }
Index: libvirt-8.10.0/src/lxc/lxc_driver.c
===================================================================
--- libvirt-8.10.0.orig/src/lxc/lxc_driver.c
+++ libvirt-8.10.0/src/lxc/lxc_driver.c
@@ -3498,6 +3498,7 @@ lxcDomainAttachDeviceNetLive(virLXCDrive
         case VIR_DOMAIN_NET_TYPE_NETWORK:
         case VIR_DOMAIN_NET_TYPE_ETHERNET:
             ignore_value(virNetDevVethDelete(veth));
+            virWaitForDevices();
             break;
 
         case VIR_DOMAIN_NET_TYPE_DIRECT:
@@ -3939,6 +3940,7 @@ lxcDomainDetachDeviceNetLive(virDomainOb
             virDomainAuditNet(vm, detach, NULL, "detach", false);
             goto cleanup;
         }
+        virWaitForDevices();
         break;
 
         /* It'd be nice to support this, but with macvlan
Index: libvirt-8.10.0/src/lxc/lxc_process.c
===================================================================
--- libvirt-8.10.0.orig/src/lxc/lxc_process.c
+++ libvirt-8.10.0/src/lxc/lxc_process.c
@@ -226,6 +226,7 @@ static void virLXCProcessCleanup(virLXCD
                 VIR_WARN("Unable to release network device '%s'", NULLSTR(iface->ifname));
         }
     }
+    virWaitForDevices();
 
     virDomainConfVMNWFilterTeardown(vm);
 
