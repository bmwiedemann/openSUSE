From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bj=C3=B6rn=20Bidar?= <bjorn.bidar@thaodan.de>
Date: Thu, 19 Oct 2023 03:23:51 +0300
Subject: [PATCH] libgit.el: Be able to load libegit2 from load-path if found
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Prefer previously installed libegit2 but check first for libegit2 from
load-path if it wasn't build already.

I modeled this logic similarly as in Jinx or ZMQ.el

Signed-off-by: Bj√∂rn Bidar <bjorn.bidar@thaodan.de>
---
 libgit.el | 18 +++++++++++++-----
 1 file changed, 13 insertions(+), 5 deletions(-)

diff --git a/libgit.el b/libgit.el
index 20c9bd48c41ac40f65afcba2ac67221ab3c63535..a3b798ee3e23738f6889af58077a88f435ef62ec 100644
--- a/libgit.el
+++ b/libgit.el
@@ -53,8 +53,13 @@
   (expand-file-name "build" libgit--root)
   "Directory where the libegit2 dynamic module file should be built.")
 
-(defvar libgit--module-file
-  (expand-file-name "libegit2.so" libgit--build-dir)
+(defvar libgit--module-file-name
+  (file-name-with-extension "libegit2" module-file-suffix)
+  "Name of the libegit2 dynamic module file.")
+
+(defvar libgit--module-file-name-path
+  (expand-file-name libgit--module-file-name
+                    libgit--build-dir)
   "Path to the libegit2 dynamic module file.")
 
 (defun libgit--configure ()
@@ -90,7 +95,7 @@ On successful exit, pass control on to the load step."
   "Load the `libegit2' dynamic module.
 If that fails, then raise an error."
   (unless (featurep 'libegit2)
-    (load libgit--module-file nil t t))
+    (load libgit--module-file-name-path nil t t))
   (unless (featurep 'libegit2)
     (error "libgit: unable to load the libegit2 dynamic module")))
 
@@ -100,8 +105,11 @@ If that fails, then raise an error."
 If the module is not available, then offer to build it."
   (interactive)
   (cond
-   ((file-exists-p libgit--module-file)
-    (libgit--load))
+    ((file-exists-p libgit--module-file-name-path)
+     (libgit--load))
+    ((locate-library libgit--module-file-name t)
+     (setq libgit--module-file-name-path (locate-library libgit--module-file-name t))
+     (libgit--load))
    (libgit-auto-rebuild
     (libgit--configure))
    ((and (not noninteractive)
