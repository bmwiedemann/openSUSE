commit 4f3ab561948f9f4dc506a62e068b47361c0a82f4
Author: Nicolas Morey <nmorey@suse.com>
Date:   Sat Sep 7 13:09:18 2024 +0200

    autogen: only deal with json/yaksa if enabled
    
    --without-(json|yaksa) is partially ignored as submodule is not
    checked but still configured
    
    Signed-off-by: Nicolas Morey <nmorey@suse.com>

diff --git configure.ac configure.ac
index 7787ded6564b..cfb9008b5b9d 100644
--- configure.ac
+++ configure.ac
@@ -1055,18 +1055,26 @@ AC_SUBST([jsonsrcdir])
 jsonlib=""
 AC_SUBST([jsonlib])
 
-jsonlib="modules/json-c/libjson-c.la"
-if test -e "${use_top_srcdir}/modules/PREBUILT" -a -e "$jsonlib"; then
-    jsonsrcdir=""
+
+PAC_CHECK_HEADER_LIB([json-c/json.h], [json-c], [json_object_get], [have_json=yes], [have_json=no])
+if test "${have_json}" = "no" ; then
+   jsonlib="modules/json-c/libjson-c.la"
+   if test -e "${use_top_srcdir}/modules/PREBUILT" -a -e "$jsonlib"; then
+       jsonsrcdir=""
+   else
+       PAC_PUSH_ALL_FLAGS()
+       PAC_RESET_ALL_FLAGS()
+       PAC_CONFIG_SUBDIR_ARGS([modules/json-c],[--enable-embedded --disable-werror],[],[AC_MSG_ERROR(json-c configure failed)])
+       PAC_POP_ALL_FLAGS()
+       jsonsrcdir="${main_top_builddir}/modules/json-c"
+   fi
+   PAC_APPEND_FLAG([-I${use_top_srcdir}/modules/json-c],[CPPFLAGS])
+   PAC_APPEND_FLAG([-I${main_top_builddir}/modules/json-c],[CPPFLAGS])
 else
-    PAC_PUSH_ALL_FLAGS()
-    PAC_RESET_ALL_FLAGS()
-    PAC_CONFIG_SUBDIR_ARGS([modules/json-c],[--enable-embedded --disable-werror],[],[AC_MSG_ERROR(json-c configure failed)])
-    PAC_POP_ALL_FLAGS()
-    jsonsrcdir="${main_top_builddir}/modules/json-c"
+   AC_MSG_NOTICE([Using an external libjson-c])
+   PAC_APPEND_FLAG([-I/usr/include/json-c],[CPPFLAGS])
+   PAC_APPEND_FLAG([-ljson-c],[WRAPPER_LIBS])
 fi
-PAC_APPEND_FLAG([-I${use_top_srcdir}/modules/json-c],[CPPFLAGS])
-PAC_APPEND_FLAG([-I${main_top_builddir}/modules/json-c],[CPPFLAGS])
 
 # ----------------------------------------------------------------------------
 # HWLOC / NETLOC
