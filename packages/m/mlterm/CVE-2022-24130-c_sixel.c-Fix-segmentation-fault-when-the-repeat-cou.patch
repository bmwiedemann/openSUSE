From 2ee22f5eff111109e77d7c65d6ae80eec77c8c79 Mon Sep 17 00:00:00 2001
From: arakiken <arakiken@users.sf.net>
Date: Fri, 4 Feb 2022 01:20:01 +0900
Subject: [PATCH] * c_sixel.c: Fix segmentation fault when the repeat count in
 sixel   sequence is over 512.  
 (https://github.com/arakiken/mlterm/issues/35)

---
 ChangeLog        | 6 ++++++
 common/c_sixel.c | 5 +++--
 2 files changed, 9 insertions(+), 2 deletions(-)

Index: mlterm-3.9.2/ChangeLog
===================================================================
--- mlterm-3.9.2.orig/ChangeLog
+++ mlterm-3.9.2/ChangeLog
@@ -1,3 +1,9 @@
+2022-02-04  Araki Ken  <arakiken@users.sf.net>
+
+	* c_sixel.c: Fix segmentation fault when the repeat count in sixel
+	  sequence is over 512.
+	  (https://github.com/arakiken/mlterm/issues/35)
+
 2022-01-16  Araki Ken  <arakiken@users.sf.net>
 
 	* 3.9.2 released.
Index: mlterm-3.9.2/common/c_sixel.c
===================================================================
--- mlterm-3.9.2.orig/common/c_sixel.c
+++ mlterm-3.9.2/common/c_sixel.c
@@ -540,10 +540,11 @@ body:
       }
 
       if (width < pix_x + rep) {
+        u_int expand = BL_MAX(rep, 512);
         u_int h;
 
-        new_width = width + 512;
-        stride += (512 * PIXEL_SIZE);
+        new_width = width + expand;
+        stride += (expand * PIXEL_SIZE);
         h = width * height / new_width;
         /*
          * h=17, pix_y=6
