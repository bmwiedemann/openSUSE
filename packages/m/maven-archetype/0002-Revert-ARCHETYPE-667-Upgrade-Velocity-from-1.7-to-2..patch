From 53b617347a6214def825f6248422440ec53778de Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fridrich=20=C5=A0trba?= <fridrich.strba@bluewin.ch>
Date: Fri, 27 Sep 2024 09:55:16 +0200
Subject: [PATCH 2/3] Revert "[ARCHETYPE-667] Upgrade Velocity from 1.7 to 2.3"

This reverts commit 8b10a1aa171d3d47a15b04866dcb7481e53b55cf.
---
 archetype-common/pom.xml                      |  2 +-
 .../maven/archetype/VelocityConfigurator.java | 65 -------------------
 .../DefaultFilesetArchetypeGenerator.java     |  7 +-
 .../maven/archetype/old/ArchetypeTest.java    |  5 +-
 maven-archetype-plugin/pom.xml                |  2 +-
 ...efaultArchetypeGenerationConfigurator.java | 20 +++---
 pom.xml                                       | 20 +++++-
 7 files changed, 35 insertions(+), 86 deletions(-)
 delete mode 100644 archetype-common/src/main/java/org/apache/maven/archetype/VelocityConfigurator.java

diff --git a/archetype-common/pom.xml b/archetype-common/pom.xml
index acd34901..5fc92702 100644
--- a/archetype-common/pom.xml
+++ b/archetype-common/pom.xml
@@ -105,7 +105,7 @@
     </dependency>
     <dependency>
       <groupId>org.apache.velocity</groupId>
-      <artifactId>velocity-engine-core</artifactId>
+      <artifactId>velocity</artifactId>
     </dependency>
     <dependency>
       <groupId>junit</groupId>
diff --git a/archetype-common/src/main/java/org/apache/maven/archetype/VelocityConfigurator.java b/archetype-common/src/main/java/org/apache/maven/archetype/VelocityConfigurator.java
deleted file mode 100644
index 899f0f6b..00000000
--- a/archetype-common/src/main/java/org/apache/maven/archetype/VelocityConfigurator.java
+++ /dev/null
@@ -1,65 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one
- * or more contributor license agreements.  See the NOTICE file
- * distributed with this work for additional information
- * regarding copyright ownership.  The ASF licenses this file
- * to you under the Apache License, Version 2.0 (the
- * "License"); you may not use this file except in compliance
- * with the License.  You may obtain a copy of the License at
- *
- *   http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing,
- * software distributed under the License is distributed on an
- * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- * KIND, either express or implied.  See the License for the
- * specific language governing permissions and limitations
- * under the License.
- */
-package org.apache.maven.archetype;
-
-import javax.inject.Named;
-import javax.inject.Singleton;
-
-import java.util.Properties;
-
-import org.codehaus.plexus.velocity.VelocityComponentConfigurator;
-
-/**
- * Velocity configurator. Used by {@link org.codehaus.plexus.velocity.VelocityComponent}
- * <p/>
- * Preserve compatibility of Velocity 2.2 with Velocity 1.x
- * <a href="https://velocity.apache.org/engine/2.3/upgrading.html">Velocity Upgrading</a>
- */
-@Named
-@Singleton
-class VelocityConfigurator implements VelocityComponentConfigurator {
-
-    @Override
-    public void configure(Properties properties) {
-
-        // # No automatic conversion of methods arguments
-        properties.put("introspector.conversion_handler.class", "none");
-
-        // # Use backward compatible space gobbling
-        properties.put("parser.space_gobbling", "bc");
-
-        // # Have #if($foo) only returns false if $foo is false or null
-        properties.put("directive.if.empty_check", false);
-
-        // # Allow '-' in identifiers (since 2.1)
-        properties.put("parser.allow_hyphen_in_identifiers", true);
-
-        // # Enable backward compatibility mode for Velocimacros
-        properties.put("velocimacro.enable_bc_mode", true);
-
-        // # When using an invalid reference handler, also include quiet references (since 2.2)
-        properties.put("event_handler.invalid_references.quiet", "true");
-
-        // # When using an invalid reference handler, also include null references (since 2.2)
-        properties.put("event_handler.invalid_references.null", true);
-
-        // # When using an invalid reference handler, also include tested references (since 2.2)
-        properties.put("event_handler.invalid_references.tested", true);
-    }
-}
diff --git a/archetype-common/src/main/java/org/apache/maven/archetype/generator/DefaultFilesetArchetypeGenerator.java b/archetype-common/src/main/java/org/apache/maven/archetype/generator/DefaultFilesetArchetypeGenerator.java
index 2bb6dec9..3a1b81fc 100644
--- a/archetype-common/src/main/java/org/apache/maven/archetype/generator/DefaultFilesetArchetypeGenerator.java
+++ b/archetype-common/src/main/java/org/apache/maven/archetype/generator/DefaultFilesetArchetypeGenerator.java
@@ -60,6 +60,7 @@ import org.apache.maven.archetype.metadata.FileSet;
 import org.apache.maven.archetype.metadata.ModuleDescriptor;
 import org.apache.maven.archetype.metadata.RequiredProperty;
 import org.apache.velocity.VelocityContext;
+import org.apache.velocity.app.Velocity;
 import org.apache.velocity.context.Context;
 import org.codehaus.plexus.logging.AbstractLogEnabled;
 import org.codehaus.plexus.util.FileUtils;
@@ -429,7 +430,7 @@ public class DefaultFilesetArchetypeGenerator extends AbstractLogEnabled impleme
 
     private String evaluateExpression(Context context, String key, String value) {
         try (StringWriter stringWriter = new StringWriter()) {
-            velocity.getEngine().evaluate(context, stringWriter, key, value);
+            Velocity.evaluate(context, stringWriter, key, value);
             return stringWriter.toString();
         } catch (Exception ex) {
             return value;
@@ -685,8 +686,8 @@ public class DefaultFilesetArchetypeGenerator extends AbstractLogEnabled impleme
 
         String localTemplateFileName = templateFileName.replace('/', File.separatorChar);
         if (!templateFileName.equals(localTemplateFileName)
-                && !velocity.getEngine().resourceExists(templateFileName)
-                && velocity.getEngine().resourceExists(localTemplateFileName)) {
+                && !velocity.getEngine().templateExists(templateFileName)
+                && velocity.getEngine().templateExists(localTemplateFileName)) {
             templateFileName = localTemplateFileName;
         }
 
diff --git a/archetype-common/src/test/java/org/apache/maven/archetype/old/ArchetypeTest.java b/archetype-common/src/test/java/org/apache/maven/archetype/old/ArchetypeTest.java
index 82a1f48e..03256432 100644
--- a/archetype-common/src/test/java/org/apache/maven/archetype/old/ArchetypeTest.java
+++ b/archetype-common/src/test/java/org/apache/maven/archetype/old/ArchetypeTest.java
@@ -146,10 +146,7 @@ public class ArchetypeTest extends PlexusTestCase {
 
             velocity.getEngine()
                     .mergeTemplate(
-                            OldArchetype.ARCHETYPE_RESOURCES + "/" + OldArchetype.ARCHETYPE_POM,
-                            "utf-8",
-                            context,
-                            writer);
+                            OldArchetype.ARCHETYPE_RESOURCES + "/" + OldArchetype.ARCHETYPE_POM, context, writer);
         } finally {
             Thread.currentThread().setContextClassLoader(old);
         }
diff --git a/maven-archetype-plugin/pom.xml b/maven-archetype-plugin/pom.xml
index 57ab3fad..b07ab7af 100644
--- a/maven-archetype-plugin/pom.xml
+++ b/maven-archetype-plugin/pom.xml
@@ -130,7 +130,7 @@
     </dependency>
     <dependency>
       <groupId>org.apache.velocity</groupId>
-      <artifactId>velocity-engine-core</artifactId>
+      <artifactId>velocity</artifactId>
     </dependency>
     <dependency>
       <groupId>commons-collections</groupId>
diff --git a/maven-archetype-plugin/src/main/java/org/apache/maven/archetype/ui/generation/DefaultArchetypeGenerationConfigurator.java b/maven-archetype-plugin/src/main/java/org/apache/maven/archetype/ui/generation/DefaultArchetypeGenerationConfigurator.java
index 186700b5..52e897a7 100644
--- a/maven-archetype-plugin/src/main/java/org/apache/maven/archetype/ui/generation/DefaultArchetypeGenerationConfigurator.java
+++ b/maven-archetype-plugin/src/main/java/org/apache/maven/archetype/ui/generation/DefaultArchetypeGenerationConfigurator.java
@@ -46,8 +46,13 @@ import org.apache.maven.archetype.exception.UnknownArchetype;
 import org.apache.maven.archetype.ui.ArchetypeConfiguration;
 import org.apache.maven.archetype.ui.ArchetypeDefinition;
 import org.apache.maven.archetype.ui.ArchetypeFactory;
+import org.apache.maven.artifact.repository.ArtifactRepository;
+import org.apache.maven.artifact.repository.ArtifactRepositoryPolicy;
+import org.apache.maven.artifact.repository.MavenArtifactRepository;
+import org.apache.maven.artifact.repository.layout.ArtifactRepositoryLayout;
 import org.apache.velocity.Template;
 import org.apache.velocity.VelocityContext;
+import org.apache.velocity.app.Velocity;
 import org.apache.velocity.context.Context;
 import org.apache.velocity.context.InternalContextAdapterImpl;
 import org.apache.velocity.runtime.RuntimeServices;
@@ -59,7 +64,6 @@ import org.apache.velocity.runtime.visitor.BaseVisitor;
 import org.codehaus.plexus.components.interactivity.PrompterException;
 import org.codehaus.plexus.logging.AbstractLogEnabled;
 import org.codehaus.plexus.util.StringUtils;
-import org.codehaus.plexus.velocity.VelocityComponent;
 import org.eclipse.aether.RepositorySystem;
 import org.eclipse.aether.RepositorySystemSession;
 import org.eclipse.aether.repository.RemoteRepository;
@@ -80,9 +84,6 @@ public class DefaultArchetypeGenerationConfigurator extends AbstractLogEnabled
     @Inject
     private ArchetypeGenerationQueryer archetypeGenerationQueryer;
 
-    @Inject
-    private VelocityComponent velocity;
-
     @Inject
     private RepositorySystem repositorySystem;
 
@@ -263,10 +264,11 @@ public class DefaultArchetypeGenerationConfigurator extends AbstractLogEnabled
         request.setProperties(properties);
     }
 
-    private String expandEmbeddedTemplateExpressions(String originalText, String textDescription, Context context) {
+    private static String expandEmbeddedTemplateExpressions(
+            String originalText, String textDescription, Context context) {
         if (StringUtils.contains(originalText, "${")) {
             try (StringWriter target = new StringWriter()) {
-                velocity.getEngine().evaluate(context, target, textDescription, originalText);
+                Velocity.evaluate(context, target, textDescription, originalText);
                 return target.toString();
             } catch (IOException ex) {
                 // closing StringWriter shouldn't actually generate any exception
@@ -333,9 +335,9 @@ public class DefaultArchetypeGenerationConfigurator extends AbstractLogEnabled
                 String defaultValue = archetypeConfiguration.getDefaultValue(propertyName);
                 if (StringUtils.contains(defaultValue, "${")) {
                     try {
-                        Template template = new Template();
-                        template.setName(propertyName + ".default");
-                        SimpleNode node = RuntimeSingleton.parse(new StringReader(defaultValue), template);
+                        final boolean dumpNamespace = false;
+                        SimpleNode node = RuntimeSingleton.parse(
+                                new StringReader(defaultValue), propertyName + ".default", dumpNamespace);
 
                         node.init(velocityContextAdapter, velocityRuntime);
 
diff --git a/pom.xml b/pom.xml
index 2a66d3e0..6e784f26 100644
--- a/pom.xml
+++ b/pom.xml
@@ -162,7 +162,21 @@
       <dependency>
         <groupId>org.codehaus.plexus</groupId>
         <artifactId>plexus-velocity</artifactId>
-        <version>2.1.0</version>
+        <version>1.2</version>
+        <exclusions>
+          <exclusion>
+            <groupId>velocity</groupId>
+            <artifactId>velocity</artifactId>
+          </exclusion>
+          <exclusion>
+            <groupId>velocity</groupId>
+            <artifactId>velocity-api</artifactId>
+          </exclusion>
+          <exclusion>
+            <groupId>org.codehaus.plexus</groupId>
+            <artifactId>plexus-container-default</artifactId>
+          </exclusion>
+        </exclusions>
       </dependency>
       <dependency>
         <groupId>org.jdom</groupId>
@@ -171,8 +185,8 @@
       </dependency>
       <dependency>
         <groupId>org.apache.velocity</groupId>
-        <artifactId>velocity-engine-core</artifactId>
-        <version>2.3</version>
+        <artifactId>velocity</artifactId>
+        <version>1.7</version>
       </dependency>
       <dependency>
         <groupId>commons-collections</groupId>
-- 
2.46.1

