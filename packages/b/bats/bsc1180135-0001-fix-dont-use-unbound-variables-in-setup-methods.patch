From 43b8ae1444e2faf62a80455eafa42d0b02709423 Mon Sep 17 00:00:00 2001
From: Martin Schulze <martin.schulze@vireso.de>
Date: Mon, 17 Aug 2020 23:22:31 +0200
Subject: [PATCH] fix: don't use unbound variables in setup methods

- fixes #340
---
 lib/bats-core/test_functions.bash             |  2 +-
 test/bats.bats                                | 13 +++++++++++
 .../bats/set_-eu_in_setup_and_teardown.bats   | 23 +++++++++++++++++++
 3 files changed, 37 insertions(+), 1 deletion(-)
 create mode 100644 test/fixtures/bats/set_-eu_in_setup_and_teardown.bats

diff --git a/lib/bats-core/test_functions.bash b/lib/bats-core/test_functions.bash
index 9eded0c0309a..e1fbb2a9f49a 100644
--- a/lib/bats-core/test_functions.bash
+++ b/lib/bats-core/test_functions.bash
@@ -54,7 +54,7 @@ teardown() {
 
 skip() {
   # if this is a skip in teardown ...
-  if [[ -n "$BATS_TEARDOWN_STARTED" ]]; then
+  if [[ -n "${BATS_TEARDOWN_STARTED-}" ]]; then
     # ... we want to skip the rest of teardown.
     # communicate to bats_exit_trap that the teardown was completed without error
     # shellcheck disable=SC2034
diff --git a/test/bats.bats b/test/bats.bats
index 1dc7e5be635c..73fb54459b28 100755
--- a/test/bats.bats
+++ b/test/bats.bats
@@ -576,3 +576,16 @@ END_OF_ERR_MSG
   run bash -c "echo $'1..1\nok 1' | bats_test_count_validator"
   [[ $status -eq 0 ]]
 }
+
+@test "Don't use unbound variables inside bats (issue #340)" {
+  run bats "$FIXTURE_ROOT/set_-eu_in_setup_and_teardown.bats"
+  echo "$output"
+  [[ "${lines[0]}" == "1..4" ]]
+  [[ "${lines[1]}" == "ok 1 skipped test # skip" ]]
+  [[ "${lines[2]}" == "ok 2 skipped test with reason # skip reason" ]]
+  [[ "${lines[3]}" == "ok 3 passing test" ]]
+  [[ "${lines[4]}" == "not ok 4 failing test" ]]
+  [[ "${lines[5]}" == "# (in test file $RELATIVE_FIXTURE_ROOT/set_-eu_in_setup_and_teardown.bats, line 22)" ]]
+  [[ "${lines[6]}" == "#   \`false' failed" ]]
+  [[ "${#lines[@]}" -eq 7 ]]
+}
diff --git a/test/fixtures/bats/set_-eu_in_setup_and_teardown.bats b/test/fixtures/bats/set_-eu_in_setup_and_teardown.bats
new file mode 100644
index 000000000000..e9879f0ab54e
--- /dev/null
+++ b/test/fixtures/bats/set_-eu_in_setup_and_teardown.bats
@@ -0,0 +1,23 @@
+setup() {
+    set -eu
+}
+
+teardown() {
+    set -eu
+}
+
+@test "skipped test" {
+    skip
+}
+
+@test "skipped test with reason" {
+    skip "reason"
+}
+
+@test "passing test" {
+    run true
+}
+
+@test "failing test" {
+    false
+}
\ No newline at end of file
-- 
2.29.2

