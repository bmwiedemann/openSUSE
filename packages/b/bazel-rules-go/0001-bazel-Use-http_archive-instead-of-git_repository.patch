From 74e4f31d017d2b97fcf343fdaf3335bdbecdc9c0 Mon Sep 17 00:00:00 2001
From: Michal Rostecki <mrostecki@opensuse.org>
Date: Fri, 13 Sep 2019 14:26:58 +0200
Subject: [PATCH] bazel: Use http_archive instead of git_repository

git_repository does not allow to:

- override repository via CLI arguments
- prefetch the tarball and use prebuild cache or distdir

which makes packaging in Linux distributions harder.

Signed-off-by: Michal Rostecki <mrostecki@opensuse.org>
---
 go/private/repositories.bzl | 165 +++++++++++++++++++++++-------------
 1 file changed, 106 insertions(+), 59 deletions(-)

diff --git a/go/private/repositories.bzl b/go/private/repositories.bzl
index d2d75097..9b2c78ea 100644
--- a/go/private/repositories.bzl
+++ b/go/private/repositories.bzl
@@ -21,7 +21,56 @@ load("@io_bazel_rules_go//go/private:nogo.bzl", "DEFAULT_NOGO", "go_register_nog
 load("@io_bazel_rules_go//go/platform:list.bzl", "GOOS_GOARCH")
 load("@io_bazel_rules_go//proto:gogo.bzl", "gogo_special_proto")
 load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
-load("@bazel_tools//tools/build_defs/repo:git.bzl", "git_repository")
+
+# master, as of 2019-03-03
+GOLANG_X_TOOLS_COMMIT = "589c23e65e65055d47b9ad4a99723bc389136265"
+GOLANG_X_TOOLS_SHA = "2d78895bf626de1fd750d7ce90d092b5c909d75a623af7049234bd42d4f103d9"
+
+GOLANG_PROTOBUF_RELEASE = "1.3.0"
+GOLANG_PROTOBUF_SHA = "f44cfe140cdaf0031dac7d7376eee4d5b07084cce400d7ecfac4c46d33f18a52"
+
+BAZEL_SKYLIB_RELEASE = "0.7.0"
+BAZEL_SKYLIB_SHA = "2c62d8cd4ab1e65c08647eb4afe38f51591f43f7f0885e7769832fa137633dcb"
+
+PROTOBUF_RELEASE = "3.7.0"
+PROTOBUF_SHA = "a19dcfe9d156ae45d209b15e0faed5c7b5f109b6117bfc1974b6a7b98a850320"
+
+# master, as of 2019-03-03
+GO_PROTO_VALIDATORS_COMMIT = "1f388280e944c97cc59c75d8c84a704097d1f1d6"
+GO_PROTO_VALIDATORS_SHA = "ad2e28b8a0a1c3fcf6dc1c22eba2204e2a6bc822a6d4cab543a233c62e5a85b7"
+
+GOGO_PROTOBUF_RELEASE = "1.2.1"
+GOGO_PROTOBUF_SHA = "99e423905ba8921e86817607a5294ffeedb66fdd4a85efce5eb2848f715fdb3a"
+
+# master, as of 2019-03-3
+GOLANG_X_NET_COMMIT = "16b79f2e4e95ea23b2bf9903c9809ff7b013ce85"
+GOLANG_X_NET_SHA = "916d7b42140ec92fc85f67a58cf10c0ce3feec468ae1f919ff22720844731be6"
+
+# v0.3.0, latest as of 2019-03-03
+GOLANG_X_TEXT_COMMIT = "f21a4dfb5e38f5895301dc265a8def02365cc3d0"
+GOLANG_X_TEXT_SHA = "339419ef0264faa388f9d20fc66025a896f32dfc9d6acec3ec83591870de2de4"
+
+# master, as of 2019-03-03
+GOLANG_X_SYS_COMMIT = "d455e41777fca6e8a5a79e34a14b8368bc11d9ba"
+GOLANG_X_SYS_SHA = "ed157d9ceeb5f12c59eb9cd821fccb7bff4d68c12d0e17369e2d2906e4b5fdd5"
+
+GRPC_GO_RELEASE = "1.19.0"
+GRPC_GO_SHA = "299e274bb6f514f2bbfcbe067b65f5cc1fcfe5c4878ca1a05af2142169711c0a"
+
+# master, as of 2019-03-03
+GO_GENPROTO_COMMIT = "4f5b463f9597cbe0dd13a6a2cd4f85e788d27508"
+GO_GENPROTO_SHA = "687c8d929e562d01d2fbba886d21ca32c86d8f12268f9cf58fd5fb4ec6d1d1c5"
+
+# master, as of 2019-03-03
+GOOGLEAPIS_COMMIT = "41d72d444fbe445f4da89e13be02078734fb7875"
+GOOGLEAPIS_SHA = "76c3286f238e7123229da9efe424bb597390d1d46bbc5b22ebc4795143d646a3"
+
+# master as of 2019-03-03
+GLOG_COMMIT = "23def4e6c14b4da8ac2ed8007337bc5eb5007998"
+GLOG_SHA = "ef225f77e38c3f071656a5bc529d7a66585e2ebc2b6149fa2bd4de1fb1ddacd6"
+
+GO_BINDATA_RELEASE = "3.13.0"
+GO_BINDATA_SHA = "16d23471f8b092d36261fc6b162e4cc30b245bf3b9c28b0f548788e6180a5729"
 
 def go_rules_dependencies():
     """See /go/workspace.rst#go-rules-dependencies for full documentation."""
@@ -36,32 +85,31 @@ def go_rules_dependencies():
 
     # Needed for nogo vet checks and go/packages.
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_x_tools",
-        # master, as of 2019-03-03
-        remote = "https://go.googlesource.com/tools",
-        commit = "589c23e65e65055d47b9ad4a99723bc389136265", # master, as of 2019-03-03
+        sha256 = GOLANG_X_TOOLS_SHA,
+        strip_prefix = "tools-" + GOLANG_X_TOOLS_COMMIT,
+        urls = ["https://github.com/golang/tools/archive/" + GOLANG_X_TOOLS_COMMIT + ".tar.gz"],
         patches = [
             "@io_bazel_rules_go//third_party:org_golang_x_tools-gazelle.patch",
             "@io_bazel_rules_go//third_party:org_golang_x_tools-extras.patch",
         ],
         patch_args = ["-p1"],
-        shallow_since = "1551386336 +0000",
         # gazelle args: -go_prefix golang.org/x/tools
     )
 
     # Proto dependencies
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_github_golang_protobuf",
-        remote = "https://github.com/golang/protobuf",
-        commit = "c823c79ea1570fb5ff454033735a8e68575d1d0f",  # v1.3.0, as of 2019-03-03
+        sha256 = GOLANG_PROTOBUF_SHA,
+        strip_prefix = "protobuf-" + GOLANG_PROTOBUF_RELEASE,
+        urls = ["https://github.com/golang/protobuf/archive/v" + GOLANG_PROTOBUF_RELEASE + ".tar.gz"],
         patches = [
             "@io_bazel_rules_go//third_party:com_github_golang_protobuf-gazelle.patch",
             "@io_bazel_rules_go//third_party:com_github_golang_protobuf-extras.patch",
         ],
         patch_args = ["-p1"],
-        shallow_since = "1549405252 -0800"
         # gazelle args: -go_prefix github.com/golang/protobuf -proto disable_global
     )
 
@@ -70,19 +118,19 @@ def go_rules_dependencies():
     # when go/def.bzl is loaded. The vendored copy of skylib in go/private/skylib
     # may be used instead.
     _maybe(
-        git_repository,
+        http_archive,
         name = "bazel_skylib",
-        remote = "https://github.com/bazelbuild/bazel-skylib",
-        commit = "6741f733227dc68137512161a5ce6fcf283e3f58",  # 0.7.0, as of 2019-03-03
-        shallow_since = "1549647446 +0100",
+        sha256 = BAZEL_SKYLIB_SHA,
+        strip_prefix = "bazel-skylib-" + BAZEL_SKYLIB_RELEASE,
+        urls = ["https://github.com/bazelbuild/bazel-skylib/archive/" + BAZEL_SKYLIB_RELEASE + ".tar.gz"],
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_google_protobuf",
-        remote = "https://github.com/protocolbuffers/protobuf",
-        commit = "582743bf40c5d3639a70f98f183914a2c0cd0680",  # v3.7.0, as of 2019-03-03
-        shallow_since = "1551387314 -0800",
+        sha256 = PROTOBUF_SHA,
+        strip_prefix = "protobuf-" + PROTOBUF_RELEASE,
+        urls =  ["https://github.com/protocolbuffers/protobuf/archive/v" + PROTOBUF_RELEASE + ".tar.gz"],
     )
     # Workaround for protocolbuffers/protobuf#5472
     # At master, they provide a macro that creates this dependency. We can't
@@ -101,24 +149,24 @@ def go_rules_dependencies():
         )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_github_mwitkow_go_proto_validators",
-        remote = "https://github.com/mwitkow/go-proto-validators",
-        commit = "1f388280e944c97cc59c75d8c84a704097d1f1d6",  # master, as of 2019-03-03
+        sha256 = GO_PROTO_VALIDATORS_SHA,
+        strip_prefix = "go-proto-validators-" + GO_PROTO_VALIDATORS_COMMIT,
+        urls = ["https://github.com/mwitkow/go-proto-validators/archive/" + GO_PROTO_VALIDATORS_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:com_github_mwitkow_go_proto_validators-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1549963709 +0000",
         # gazelle args: -go_prefix github.com/mwitkow/go-proto-validators -proto disable
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_github_gogo_protobuf",
-        remote = "https://github.com/gogo/protobuf",
-        commit = "ba06b47c162d49f2af050fb4c75bcbc86a159d5c",  # v1.2.1, as of 2019-03-03
+        sha256 = GOGO_PROTOBUF_SHA,
+        strip_prefix = "protobuf-" + GOGO_PROTOBUF_RELEASE,
+        urls = ["https://github.com/gogo/protobuf/archive/v" + GOGO_PROTOBUF_RELEASE + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:com_github_gogo_protobuf-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1550471403 +0200",
         # gazelle args: -go_prefix github.com/gogo/protobuf -proto legacy
     )
 
@@ -129,68 +177,68 @@ def go_rules_dependencies():
 
     # GRPC dependencies
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_x_net",
-        remote = "https://go.googlesource.com/net",
-        commit = "16b79f2e4e95ea23b2bf9903c9809ff7b013ce85",  # master, as of 2019-03-3
+        sha256 = GOLANG_X_NET_SHA,
+        strip_prefix = "net-" + GOLANG_X_NET_COMMIT,
+        urls = ["https://github.com/golang/net/archive/" + GOLANG_X_NET_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:org_golang_x_net-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1551482021 +0000",
         # gazelle args: -go_prefix golang.org/x/net
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_x_text",
-        remote = "https://go.googlesource.com/text",
-        commit = "f21a4dfb5e38f5895301dc265a8def02365cc3d0",  # v0.3.0, latest as of 2019-03-03
+        sha256 = GOLANG_X_TEXT_SHA,
+        strip_prefix = "text-" + GOLANG_X_TEXT_COMMIT,
+        urls = ["https://github.com/golang/text/archive/" + GOLANG_X_TEXT_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:org_golang_x_text-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1513256923 +0000",
         # gazelle args: -go_prefix golang.org/x/text
     )
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_x_sys",
-        remote = "https://go.googlesource.com/sys",
-        commit = "d455e41777fca6e8a5a79e34a14b8368bc11d9ba",  # master, as of 2019-03-03
+        sha256 = GOLANG_X_SYS_SHA,
+        strip_prefix = "sys-" + GOLANG_X_SYS_COMMIT,
+        urls = ["https://github.com/golang/sys/archive/" + GOLANG_X_SYS_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:org_golang_x_sys-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1551616002 +0000",
         # gazelle args: -go_prefix golang.org/x/sys
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_google_grpc",
-        remote = "https://github.com/grpc/grpc-go",
-        commit = "2fdaae294f38ed9a121193c51ec99fecd3b13eb7",  # v1.19.0, latest as of 2019-03-03
+        sha256 = GRPC_GO_SHA,
+        strip_prefix = "grpc-go-" + GRPC_GO_RELEASE,
+        urls = ["https://github.com/grpc/grpc-go/archive/v" + GRPC_GO_RELEASE + ".tar.gz"],
         patches = [
             "@io_bazel_rules_go//third_party:org_golang_google_grpc-gazelle.patch",
             "@io_bazel_rules_go//third_party:org_golang_google_grpc-crosscompile.patch",
         ],
         patch_args = ["-p1"],
-        shallow_since = "1551206709 -0800",
         # gazelle args: -go_prefix google.golang.org/grpc -proto disable
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "org_golang_google_genproto",
-        remote = "https://github.com/google/go-genproto",
-        commit = "4f5b463f9597cbe0dd13a6a2cd4f85e788d27508",  # master, as of 2019-03-03
+        sha256 = GO_GENPROTO_SHA,
+        strip_prefix = "go-genproto-" + GO_GENPROTO_COMMIT,
+        urls = ["https://github.com/google/go-genproto/archive/" + GO_GENPROTO_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:org_golang_google_genproto-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1551303189 -0700",
         # gazelle args: -go_prefix google.golang.org/genproto -proto disable_global
     )
 
     _maybe(
-        git_repository,
+        http_archive,
         name = "go_googleapis",
-        # master as of 2019-01-17
-        remote = "https://github.com/googleapis/googleapis",
-        commit = "41d72d444fbe445f4da89e13be02078734fb7875",  # master, as of 2019-03-03
+        sha256 = GOOGLEAPIS_SHA,
+        strip_prefix = "googleapis-" + GOOGLEAPIS_COMMIT,
+        urls = ["https://github.com/googleapis/googleapis/archive/" + GOOGLEAPIS_COMMIT + ".tar.gz"],
         patches = [
             "@io_bazel_rules_go//third_party:go_googleapis-deletebuild.patch",
             "@io_bazel_rules_go//third_party:go_googleapis-directives.patch",
@@ -198,28 +246,27 @@ def go_rules_dependencies():
             "@io_bazel_rules_go//third_party:go_googleapis-fix.patch",
         ],
         patch_args = ["-E", "-p1"],
-        shallow_since = "1551404057 -0800",
     )
 
     # Needed for examples
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_github_golang_glog",
-        remote = "https://github.com/golang/glog",
-        commit = "23def4e6c14b4da8ac2ed8007337bc5eb5007998",  # master as of 2019-03-03
+        sha256 = GLOG_SHA,
+        strip_prefix = "glog-" + GLOG_COMMIT,
+        urls = ["https://github.com/golang/glog/archive/" + GLOG_COMMIT + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:com_github_golang_glog-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1453852388 +1100",
         # gazelle args: -go_prefix github.com/golang/glog
     )
     _maybe(
-        git_repository,
+        http_archive,
         name = "com_github_kevinburke_go_bindata",
-        remote = "https://github.com/kevinburke/go-bindata",
-        commit = "53d73b98acf3bd9f56d7f9136ed8e1be64756e1d",  # v3.13.0, latest as of 2019-03-03
+        sha256 = GO_BINDATA_SHA,
+        strip_prefix = "go-bindata-" + GO_BINDATA_RELEASE,
+        urls = ["https://github.com/kevinburke/go-bindata/archive/v" + GO_BINDATA_RELEASE + ".tar.gz"],
         patches = ["@io_bazel_rules_go//third_party:com_github_kevinburke_go_bindata-gazelle.patch"],
         patch_args = ["-p1"],
-        shallow_since = "1545009224 +0000",
         # gazelle args: -go_prefix github.com/kevinburke/go-bindata
     )
 
-- 
2.23.0

