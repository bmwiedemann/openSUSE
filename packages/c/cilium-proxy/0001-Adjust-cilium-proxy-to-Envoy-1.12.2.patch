From a25ec5657261f66f34515563dde3b44d6bd3334d Mon Sep 17 00:00:00 2001
From: Michal Rostecki <mrostecki@opensuse.org>
Date: Thu, 16 Jan 2020 19:35:55 +0100
Subject: [PATCH] Adjust cilium proxy to Envoy 1.12.2

Signed-off-by: Michal Rostecki <mrostecki@opensuse.org>
---
 WORKSPACE                | 7 ++-----
 cilium/l7policy.cc       | 2 +-
 cilium/l7policy.h        | 1 +
 cilium/network_filter.cc | 2 +-
 4 files changed, 5 insertions(+), 7 deletions(-)

diff --git a/WORKSPACE b/WORKSPACE
index adae9df..574198d 100644
--- a/WORKSPACE
+++ b/WORKSPACE
@@ -7,8 +7,8 @@ workspace(name = "cilium")
 #
 # No other line in this file may have ENVOY_SHA followed by an equals sign!
 #
-ENVOY_SHA = "fc40c08a807111943c4b3cbe11df494f3e0df4d4"
-ENVOY_SHA256 = "f6bb1bfbd5a6681ef4898f396e671ff4adcd372f6dca8d0cfa980f8b91914ff1"
+ENVOY_SHA = "9153a6077d17ed4af1457b998a9a6b3c75572456"
+ENVOY_SHA256 = "53467391b515ac088d7d89f8d177669ff5e3486f1c9d1d42fdab940e6bc0c04b"
 
 load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
 
@@ -17,9 +17,6 @@ http_archive(
     url = "https://github.com/jrajahalme/envoy/archive/" + ENVOY_SHA + ".tar.gz",
     sha256 = ENVOY_SHA256,
     strip_prefix = "envoy-" + ENVOY_SHA,
-    patches = [
-        "@//patches:sni_support_fix.patch",
-    ],
     patch_args = ["-p1"],
 )
 
diff --git a/cilium/l7policy.cc b/cilium/l7policy.cc
index d354482..51e23d9 100644
--- a/cilium/l7policy.cc
+++ b/cilium/l7policy.cc
@@ -22,7 +22,7 @@ class ConfigFactory
 public:
   Http::FilterFactoryCb
   createFilterFactory(const Json::Object& json, const std::string &,
-                      Server::Configuration::FactoryContext& context) override {
+                      Server::Configuration::FactoryContext& context) {
     auto config = std::make_shared<Cilium::Config>(json, context);
     return [config](
                Http::FilterChainFactoryCallbacks& callbacks) mutable -> void {
diff --git a/cilium/l7policy.h b/cilium/l7policy.h
index e5e2bd6..e36357e 100644
--- a/cilium/l7policy.h
+++ b/cilium/l7policy.h
@@ -4,6 +4,7 @@
 
 #include "absl/types/optional.h"
 
+#include "envoy/json/json_object.h"
 #include "envoy/stats/stats_macros.h"
 #include "envoy/server/filter_config.h"
 
diff --git a/cilium/network_filter.cc b/cilium/network_filter.cc
index 92be1b6..ce2e0f2 100644
--- a/cilium/network_filter.cc
+++ b/cilium/network_filter.cc
@@ -34,7 +34,7 @@ public:
   }
 
   Network::FilterFactoryCb
-  createFilterFactory(const Json::Object& json_config, FactoryContext& context) override {
+  createFilterFactory(const Json::Object& json_config, FactoryContext& context) {
     auto config = std::make_shared<Filter::CiliumL3::Config>(json_config, context);
     return [config](Network::FilterManager &filter_manager) mutable -> void {
       filter_manager.addFilter(std::make_shared<Filter::CiliumL3::Instance>(config));
-- 
2.16.4

