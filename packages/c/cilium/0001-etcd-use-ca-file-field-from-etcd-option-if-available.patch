From 190aff2dc4ba6c954dc839c42263b4eead32db00 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20Martins?= <andre@cilium.io>
Date: Mon, 2 Sep 2019 21:46:03 +0200
Subject: [PATCH 1/3] etcd: use ca-file field from etcd option if available
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ca-file usage is removed in etcd v3.4 but since we haven't removed its
usage soon enough we will have support for it for one more release to
allow users to perform the necessary change in their ConfigMaps in v1.7

Signed-off-by: Andr√© Martins <andre@cilium.io>
Signed-off-by: Michal Rostecki <mrostecki@opensuse.org>
---
 Documentation/cmdref/kvstore.rst              |  2 +-
 Documentation/install/upgrade.rst             |  8 +--
 Documentation/kubernetes/configuration.rst    |  4 +-
 Gopkg.lock                                    |  2 +
 .../scripts/03-install-kubernetes-worker.sh   |  2 +-
 examples/kubernetes/1.10/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.10/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.10/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.10/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.10/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.10/cilium-minikube.yaml |  4 +-
 .../1.10/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.10/cilium.yaml          |  4 +-
 examples/kubernetes/1.11/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.11/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.11/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.11/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.11/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.11/cilium-minikube.yaml |  4 +-
 .../1.11/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.11/cilium.yaml          |  4 +-
 examples/kubernetes/1.12/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.12/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.12/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.12/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.12/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.12/cilium-minikube.yaml |  4 +-
 .../1.12/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.12/cilium.yaml          |  4 +-
 examples/kubernetes/1.13/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.13/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.13/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.13/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.13/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.13/cilium-minikube.yaml |  4 +-
 .../1.13/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.13/cilium.yaml          |  4 +-
 examples/kubernetes/1.14/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.14/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.14/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.14/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.14/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.14/cilium-minikube.yaml |  4 +-
 .../1.14/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.14/cilium.yaml          |  4 +-
 examples/kubernetes/1.15/cilium-cm.yaml       |  4 +-
 .../kubernetes/1.15/cilium-containerd.yaml    |  4 +-
 examples/kubernetes/1.15/cilium-crio.yaml     |  4 +-
 .../kubernetes/1.15/cilium-external-etcd.yaml |  4 +-
 examples/kubernetes/1.15/cilium-microk8s.yaml |  4 +-
 examples/kubernetes/1.15/cilium-minikube.yaml |  4 +-
 .../1.15/cilium-with-node-init.yaml           |  4 +-
 examples/kubernetes/1.15/cilium.yaml          |  4 +-
 examples/kubernetes/Makefile                  |  6 +-
 .../kubernetes/templates/v1/cilium-cm.yaml    |  4 +-
 pkg/kvstore/etcd.go                           | 63 ++++++++++++++++++-
 test/k8sT/manifests/cilium-cm-patch.yaml      |  4 +-
 test/k8sT/manifests/v1.3/cilium-cm-patch.yaml |  4 +-
 .../cilium-cm-patch-clean-cilium-state.yaml   |  4 +-
 tests/k8s/cluster/cluster-manager.bash        |  2 +-
 60 files changed, 179 insertions(+), 118 deletions(-)

diff --git Documentation/cmdref/kvstore.rst Documentation/cmdref/kvstore.rst
index 75732587d..1c677d5d2 100644
--- Documentation/cmdref/kvstore.rst
+++ Documentation/cmdref/kvstore.rst
@@ -66,7 +66,7 @@ Example of the etcd configuration file:
     endpoints:
     - https://192.168.0.1:2379
     - https://192.168.0.2:2379
-    ca-file: '/var/lib/cilium/etcd-ca.pem'
+    trusted-ca-file: '/var/lib/cilium/etcd-ca.pem'
     # In case you want client to server authentication
     key-file: '/var/lib/cilium/etcd-client.key'
     cert-file: '/var/lib/cilium/etcd-client.crt'
diff --git Documentation/install/upgrade.rst Documentation/install/upgrade.rst
index 9f76738ff..7ea20ce99 100644
--- Documentation/install/upgrade.rst
+++ Documentation/install/upgrade.rst
@@ -615,10 +615,10 @@ Export the current ConfigMap
             endpoints:
             - https://192.168.33.11:2379
             #
-            # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+            # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
             # and create a kubernetes secret by following the tutorial in
             # https://cilium.link/etcd-config
-            ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+            trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
             #
             # In case you want client to server authentication, uncomment the following
             # lines and add the certificate and key in cilium-etcd-secrets below
@@ -708,10 +708,10 @@ new options while keeping the configuration that we wanted:
             endpoints:
             - https://192.168.33.11:2379
             #
-            # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+            # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
             # and create a kubernetes secret by following the tutorial in
             # https://cilium.link/etcd-config
-            ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+            trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
             #
             # In case you want client to server authentication, uncomment the following
             # lines and add the certificate and key in cilium-etcd-secrets below
diff --git Documentation/kubernetes/configuration.rst Documentation/kubernetes/configuration.rst
index af4dba1cb..5eba87b77 100644
--- Documentation/kubernetes/configuration.rst
+++ Documentation/kubernetes/configuration.rst
@@ -73,10 +73,10 @@ enabled.
         - https://node-1:31079
         - https://node-2:31079
         #
-        # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+        # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
         # and create a kubernetes secret by following the tutorial in
         # https://cilium.link/etcd-config
-        ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+        trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
         #
         # In case you want client to server authentication, uncomment the following
         # lines and create a kubernetes secret by following the tutorial in
diff --git Gopkg.lock Gopkg.lock
index 53a3f52da..185e42613 100644
--- Gopkg.lock
+++ Gopkg.lock
@@ -1811,6 +1811,7 @@
     "github.com/coreos/etcd/clientv3/concurrency",
     "github.com/coreos/etcd/clientv3/yaml",
     "github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes",
+    "github.com/coreos/etcd/pkg/tlsutil",
     "github.com/davecgh/go-spew/spew",
     "github.com/docker/docker/api/types",
     "github.com/docker/docker/api/types/events",
@@ -1930,6 +1931,7 @@
     "k8s.io/kubernetes/pkg/kubelet/types",
     "k8s.io/kubernetes/pkg/kubelet/util",
     "k8s.io/kubernetes/pkg/registry/core/service/ipallocator",
+    "sigs.k8s.io/yaml",
   ]
   solver-name = "gps-cdcl"
   solver-version = 1
diff --git examples/kubernetes-ingress/scripts/03-install-kubernetes-worker.sh examples/kubernetes-ingress/scripts/03-install-kubernetes-worker.sh
index 7482773e3..437b80d90 100755
--- examples/kubernetes-ingress/scripts/03-install-kubernetes-worker.sh
+++ examples/kubernetes-ingress/scripts/03-install-kubernetes-worker.sh
@@ -169,7 +169,7 @@ sudo tee /var/lib/cilium/etcd-config.yml <<EOF
 ---
 endpoints:
 - https://${controllers_ips[0]}:2379
-ca-file: '/var/lib/cilium/ca-etcd.pem'
+trusted-ca-file: '/var/lib/cilium/ca-etcd.pem'
 key-file: '/var/lib/cilium/etcd-cilium-key.pem'
 cert-file: '/var/lib/cilium/etcd-cilium.pem'
 EOF
diff --git examples/kubernetes/1.10/cilium-cm.yaml examples/kubernetes/1.10/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.10/cilium-cm.yaml
+++ examples/kubernetes/1.10/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-containerd.yaml examples/kubernetes/1.10/cilium-containerd.yaml
index 15381d8ac..c33dd87f8 100644
--- examples/kubernetes/1.10/cilium-containerd.yaml
+++ examples/kubernetes/1.10/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-crio.yaml examples/kubernetes/1.10/cilium-crio.yaml
index a0ef7a85e..c055058c2 100644
--- examples/kubernetes/1.10/cilium-crio.yaml
+++ examples/kubernetes/1.10/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-external-etcd.yaml examples/kubernetes/1.10/cilium-external-etcd.yaml
index 4f0efda4b..176a41c7e 100644
--- examples/kubernetes/1.10/cilium-external-etcd.yaml
+++ examples/kubernetes/1.10/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-microk8s.yaml examples/kubernetes/1.10/cilium-microk8s.yaml
index afa688b68..e6a67c53b 100644
--- examples/kubernetes/1.10/cilium-microk8s.yaml
+++ examples/kubernetes/1.10/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-minikube.yaml examples/kubernetes/1.10/cilium-minikube.yaml
index 928da35cb..e3f2ecea2 100644
--- examples/kubernetes/1.10/cilium-minikube.yaml
+++ examples/kubernetes/1.10/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium-with-node-init.yaml examples/kubernetes/1.10/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.10/cilium-with-node-init.yaml
+++ examples/kubernetes/1.10/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.10/cilium.yaml examples/kubernetes/1.10/cilium.yaml
index 6bfb739df..930798c40 100644
--- examples/kubernetes/1.10/cilium.yaml
+++ examples/kubernetes/1.10/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-cm.yaml examples/kubernetes/1.11/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.11/cilium-cm.yaml
+++ examples/kubernetes/1.11/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-containerd.yaml examples/kubernetes/1.11/cilium-containerd.yaml
index 42ec1f72b..dc4f16818 100644
--- examples/kubernetes/1.11/cilium-containerd.yaml
+++ examples/kubernetes/1.11/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-crio.yaml examples/kubernetes/1.11/cilium-crio.yaml
index 3aa17c23c..1144f8dff 100644
--- examples/kubernetes/1.11/cilium-crio.yaml
+++ examples/kubernetes/1.11/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-external-etcd.yaml examples/kubernetes/1.11/cilium-external-etcd.yaml
index c25723be5..5604865f3 100644
--- examples/kubernetes/1.11/cilium-external-etcd.yaml
+++ examples/kubernetes/1.11/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-microk8s.yaml examples/kubernetes/1.11/cilium-microk8s.yaml
index ac60e57c3..59111f916 100644
--- examples/kubernetes/1.11/cilium-microk8s.yaml
+++ examples/kubernetes/1.11/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-minikube.yaml examples/kubernetes/1.11/cilium-minikube.yaml
index f2b3b16a7..dbb344d20 100644
--- examples/kubernetes/1.11/cilium-minikube.yaml
+++ examples/kubernetes/1.11/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium-with-node-init.yaml examples/kubernetes/1.11/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.11/cilium-with-node-init.yaml
+++ examples/kubernetes/1.11/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.11/cilium.yaml examples/kubernetes/1.11/cilium.yaml
index a1abca385..487427f5d 100644
--- examples/kubernetes/1.11/cilium.yaml
+++ examples/kubernetes/1.11/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-cm.yaml examples/kubernetes/1.12/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.12/cilium-cm.yaml
+++ examples/kubernetes/1.12/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-containerd.yaml examples/kubernetes/1.12/cilium-containerd.yaml
index 42ec1f72b..dc4f16818 100644
--- examples/kubernetes/1.12/cilium-containerd.yaml
+++ examples/kubernetes/1.12/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-crio.yaml examples/kubernetes/1.12/cilium-crio.yaml
index 3aa17c23c..1144f8dff 100644
--- examples/kubernetes/1.12/cilium-crio.yaml
+++ examples/kubernetes/1.12/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-external-etcd.yaml examples/kubernetes/1.12/cilium-external-etcd.yaml
index c25723be5..5604865f3 100644
--- examples/kubernetes/1.12/cilium-external-etcd.yaml
+++ examples/kubernetes/1.12/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-microk8s.yaml examples/kubernetes/1.12/cilium-microk8s.yaml
index ac60e57c3..59111f916 100644
--- examples/kubernetes/1.12/cilium-microk8s.yaml
+++ examples/kubernetes/1.12/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-minikube.yaml examples/kubernetes/1.12/cilium-minikube.yaml
index f2b3b16a7..dbb344d20 100644
--- examples/kubernetes/1.12/cilium-minikube.yaml
+++ examples/kubernetes/1.12/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium-with-node-init.yaml examples/kubernetes/1.12/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.12/cilium-with-node-init.yaml
+++ examples/kubernetes/1.12/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.12/cilium.yaml examples/kubernetes/1.12/cilium.yaml
index a1abca385..487427f5d 100644
--- examples/kubernetes/1.12/cilium.yaml
+++ examples/kubernetes/1.12/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-cm.yaml examples/kubernetes/1.13/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.13/cilium-cm.yaml
+++ examples/kubernetes/1.13/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-containerd.yaml examples/kubernetes/1.13/cilium-containerd.yaml
index 42ec1f72b..dc4f16818 100644
--- examples/kubernetes/1.13/cilium-containerd.yaml
+++ examples/kubernetes/1.13/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-crio.yaml examples/kubernetes/1.13/cilium-crio.yaml
index 3aa17c23c..1144f8dff 100644
--- examples/kubernetes/1.13/cilium-crio.yaml
+++ examples/kubernetes/1.13/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-external-etcd.yaml examples/kubernetes/1.13/cilium-external-etcd.yaml
index c25723be5..5604865f3 100644
--- examples/kubernetes/1.13/cilium-external-etcd.yaml
+++ examples/kubernetes/1.13/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-microk8s.yaml examples/kubernetes/1.13/cilium-microk8s.yaml
index ac60e57c3..59111f916 100644
--- examples/kubernetes/1.13/cilium-microk8s.yaml
+++ examples/kubernetes/1.13/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-minikube.yaml examples/kubernetes/1.13/cilium-minikube.yaml
index f2b3b16a7..dbb344d20 100644
--- examples/kubernetes/1.13/cilium-minikube.yaml
+++ examples/kubernetes/1.13/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium-with-node-init.yaml examples/kubernetes/1.13/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.13/cilium-with-node-init.yaml
+++ examples/kubernetes/1.13/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.13/cilium.yaml examples/kubernetes/1.13/cilium.yaml
index a1abca385..487427f5d 100644
--- examples/kubernetes/1.13/cilium.yaml
+++ examples/kubernetes/1.13/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-cm.yaml examples/kubernetes/1.14/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.14/cilium-cm.yaml
+++ examples/kubernetes/1.14/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-containerd.yaml examples/kubernetes/1.14/cilium-containerd.yaml
index 42ec1f72b..dc4f16818 100644
--- examples/kubernetes/1.14/cilium-containerd.yaml
+++ examples/kubernetes/1.14/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-crio.yaml examples/kubernetes/1.14/cilium-crio.yaml
index 3aa17c23c..1144f8dff 100644
--- examples/kubernetes/1.14/cilium-crio.yaml
+++ examples/kubernetes/1.14/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-external-etcd.yaml examples/kubernetes/1.14/cilium-external-etcd.yaml
index c25723be5..5604865f3 100644
--- examples/kubernetes/1.14/cilium-external-etcd.yaml
+++ examples/kubernetes/1.14/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-microk8s.yaml examples/kubernetes/1.14/cilium-microk8s.yaml
index ac60e57c3..59111f916 100644
--- examples/kubernetes/1.14/cilium-microk8s.yaml
+++ examples/kubernetes/1.14/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-minikube.yaml examples/kubernetes/1.14/cilium-minikube.yaml
index f2b3b16a7..dbb344d20 100644
--- examples/kubernetes/1.14/cilium-minikube.yaml
+++ examples/kubernetes/1.14/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium-with-node-init.yaml examples/kubernetes/1.14/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.14/cilium-with-node-init.yaml
+++ examples/kubernetes/1.14/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.14/cilium.yaml examples/kubernetes/1.14/cilium.yaml
index a1abca385..487427f5d 100644
--- examples/kubernetes/1.14/cilium.yaml
+++ examples/kubernetes/1.14/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-cm.yaml examples/kubernetes/1.15/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/1.15/cilium-cm.yaml
+++ examples/kubernetes/1.15/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-containerd.yaml examples/kubernetes/1.15/cilium-containerd.yaml
index 42ec1f72b..dc4f16818 100644
--- examples/kubernetes/1.15/cilium-containerd.yaml
+++ examples/kubernetes/1.15/cilium-containerd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-crio.yaml examples/kubernetes/1.15/cilium-crio.yaml
index 3aa17c23c..1144f8dff 100644
--- examples/kubernetes/1.15/cilium-crio.yaml
+++ examples/kubernetes/1.15/cilium-crio.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-external-etcd.yaml examples/kubernetes/1.15/cilium-external-etcd.yaml
index c25723be5..5604865f3 100644
--- examples/kubernetes/1.15/cilium-external-etcd.yaml
+++ examples/kubernetes/1.15/cilium-external-etcd.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://EDIT-ME-ETCD-ADDRESS:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-microk8s.yaml examples/kubernetes/1.15/cilium-microk8s.yaml
index ac60e57c3..59111f916 100644
--- examples/kubernetes/1.15/cilium-microk8s.yaml
+++ examples/kubernetes/1.15/cilium-microk8s.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - http://127.0.0.1:31079
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    # ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    # trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-minikube.yaml examples/kubernetes/1.15/cilium-minikube.yaml
index f2b3b16a7..dbb344d20 100644
--- examples/kubernetes/1.15/cilium-minikube.yaml
+++ examples/kubernetes/1.15/cilium-minikube.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://127.0.0.1:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd/ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium-with-node-init.yaml examples/kubernetes/1.15/cilium-with-node-init.yaml
index 5de86cfa6..de74b1847 100644
--- examples/kubernetes/1.15/cilium-with-node-init.yaml
+++ examples/kubernetes/1.15/cilium-with-node-init.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.cilium.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/1.15/cilium.yaml examples/kubernetes/1.15/cilium.yaml
index a1abca385..487427f5d 100644
--- examples/kubernetes/1.15/cilium.yaml
+++ examples/kubernetes/1.15/cilium.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git examples/kubernetes/Makefile examples/kubernetes/Makefile
index ef1f3290b..3801a0fbf 100644
--- examples/kubernetes/Makefile
+++ examples/kubernetes/Makefile
@@ -137,7 +137,7 @@ cilium-external-etcd.yaml:
             rm -f ./$@ && \
             for f in $(CILIUM_EXTERNAL_ETCD); do (cat "$${f}") >> $@; done; \
 	sed -i 's+https://cilium-etcd-client.kube-system.svc:2379+http://EDIT-ME-ETCD-ADDRESS:2379+' cilium-external-etcd.yaml; \
-	sed -i "s+ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'+# ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'+" cilium-external-etcd.yaml; \
+	sed -i "s+trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'+# trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'+" cilium-external-etcd.yaml; \
 	sed -i "s+key-file: '/var/lib/etcd-secrets/etcd-client.key'+# key-file: '/var/lib/etcd-secrets/etcd-client.key'+" cilium-external-etcd.yaml; \
 	sed -i "s+cert-file: '/var/lib/etcd-secrets/etcd-client.crt'+# cert-file: '/var/lib/etcd-secrets/etcd-client.crt'+" cilium-external-etcd.yaml); \
 	done
@@ -163,7 +163,7 @@ cilium-microk8s.yaml:
             rm -f ./$@ && \
             for f in $(CILIUM_MICROK8S); do (cat "$${f}") >> $@; done; \
             sed -i 's+https://cilium-etcd-client.kube-system.svc:2379+http://127.0.0.1:31079+' cilium-microk8s.yaml; \
-            sed -i 's+ca-file:+# ca-file:+' cilium-microk8s.yaml; \
+            sed -i 's+trusted-ca-file:+# trusted-ca-file:+' cilium-microk8s.yaml; \
             sed -i 's+key-file:+# key-file:+' cilium-microk8s.yaml; \
             sed -i 's+cert-file:+# cert-file:+' cilium-microk8s.yaml; \
             sed -i 's+path: /var/run/containerd+path: /var/snap/microk8s/common/run+'  cilium-microk8s.yaml; \
@@ -180,7 +180,7 @@ cilium-minikube.yaml:
             for f in $(CILIUM_MINIKUBE); do (cat "$${f}") >> $@; done; \
             if [[ "$$k8s_version" == "1.8" || "$$k8s_version" == "1.9" ]]; then \
             sed -i 's+https://cilium-etcd-client.kube-system.svc:2379+http://127.0.0.1:2379+' cilium-minikube.yaml; \
-            sed -i 's+ca-file:+# ca-file:+' cilium-minikube.yaml; \
+            sed -i 's+trusted-ca-file:+# trusted-ca-file:+' cilium-minikube.yaml; \
             sed -i 's+key-file:+# key-file:+' cilium-minikube.yaml; \
             sed -i 's+cert-file:+# cert-file:+' cilium-minikube.yaml; \
             else \
diff --git examples/kubernetes/templates/v1/cilium-cm.yaml examples/kubernetes/templates/v1/cilium-cm.yaml
index 6e9b043b7..c4a5ad0b5 100644
--- examples/kubernetes/templates/v1/cilium-cm.yaml
+++ examples/kubernetes/templates/v1/cilium-cm.yaml
@@ -12,10 +12,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git pkg/kvstore/etcd.go pkg/kvstore/etcd.go
index 7654193cc..72e140d52 100644
--- pkg/kvstore/etcd.go
+++ pkg/kvstore/etcd.go
@@ -19,6 +19,7 @@ import (
 	"context"
 	"errors"
 	"fmt"
+	"io/ioutil"
 	"math/rand"
 	"net/url"
 	"os"
@@ -35,10 +36,12 @@ import (
 	"github.com/coreos/etcd/clientv3/concurrency"
 	clientyaml "github.com/coreos/etcd/clientv3/yaml"
 	v3rpcErrors "github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes"
+	"github.com/coreos/etcd/pkg/tlsutil"
 	"github.com/hashicorp/go-version"
 	"github.com/sirupsen/logrus"
 	ctx "golang.org/x/net/context"
 	"golang.org/x/time/rate"
+	"sigs.k8s.io/yaml"
 )
 
 const (
@@ -476,7 +479,7 @@ func (e *etcdClient) renewLockSession() error {
 
 func connectEtcdClient(config *client.Config, cfgPath string, errChan chan error, rateLimit int, opts *ExtraOptions) (BackendOperations, error) {
 	if cfgPath != "" {
-		cfg, err := clientyaml.NewConfig(cfgPath)
+		cfg, err := newConfig(cfgPath)
 		if err != nil {
 			return nil, err
 		}
@@ -1371,7 +1374,7 @@ func IsEtcdOperator(selectedBackend string, opts map[string]string, k8sNamespace
 		return false
 	}
 
-	cfg, err := clientyaml.NewConfig(etcdConfig)
+	cfg, err := newConfig(etcdConfig)
 	if err != nil {
 		log.WithError(err).Error("Unable to read etcd configuration.")
 		return false
@@ -1384,3 +1387,59 @@ func IsEtcdOperator(selectedBackend string, opts map[string]string, k8sNamespace
 
 	return false
 }
+
+// newConfig is a wrapper of clientyaml.NewConfig. Since etcd has deprecated
+// the `ca-file` field from yamlConfig in v3.4, the clientyaml.NewConfig won't
+// read that field from the etcd configuration file making Cilium fail to
+// connect to a TLS-enabled etcd server. Since we should have deprecated the
+// usage of this field a long time ago, in this galaxy, we will have this
+// wrapper function as a workaround which will still use the `ca-file` field to
+// avoid users breaking their connectivity to etcd when upgrading Cilium.
+// TODO remove this wrapper in cilium >= 1.8
+func newConfig(fpath string) (*client.Config, error) {
+	cfg, err := clientyaml.NewConfig(fpath)
+	if err != nil {
+		return nil, err
+	}
+	if cfg.TLS == nil || cfg.TLS.RootCAs != nil {
+		return cfg, nil
+	}
+
+	yc := &yamlConfig{}
+	b, err := ioutil.ReadFile(fpath)
+	if err != nil {
+		return nil, err
+	}
+	err = yaml.Unmarshal(b, yc)
+	if err != nil {
+		return nil, err
+	}
+	if yc.InsecureTransport {
+		return cfg, nil
+	}
+
+	if yc.CAfile != "" {
+		cp, err := tlsutil.NewCertPool([]string{yc.CAfile})
+		if err != nil {
+			return nil, err
+		}
+		cfg.TLS.RootCAs = cp
+	}
+	return cfg, nil
+}
+
+// copy of the internal structure in go.etcd.io/etcd/clientv3/yaml so we
+// can still use the `ca-file` field for one more release.
+type yamlConfig struct {
+	client.Config
+
+	InsecureTransport     bool   `json:"insecure-transport"`
+	InsecureSkipTLSVerify bool   `json:"insecure-skip-tls-verify"`
+	Certfile              string `json:"cert-file"`
+	Keyfile               string `json:"key-file"`
+	TrustedCAfile         string `json:"trusted-ca-file"`
+
+	// CAfile is being deprecated. Use 'TrustedCAfile' instead.
+	// TODO: deprecate this in v4
+	CAfile string `json:"ca-file"`
+}
diff --git test/k8sT/manifests/cilium-cm-patch.yaml test/k8sT/manifests/cilium-cm-patch.yaml
index 00894301f..c8b4d0b9b 100644
--- test/k8sT/manifests/cilium-cm-patch.yaml
+++ test/k8sT/manifests/cilium-cm-patch.yaml
@@ -7,10 +7,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git test/k8sT/manifests/v1.3/cilium-cm-patch.yaml test/k8sT/manifests/v1.3/cilium-cm-patch.yaml
index 67f4c46fa..6b8eb8f8f 100644
--- test/k8sT/manifests/v1.3/cilium-cm-patch.yaml
+++ test/k8sT/manifests/v1.3/cilium-cm-patch.yaml
@@ -7,10 +7,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git test/k8sT/manifests/v1.4/cilium-cm-patch-clean-cilium-state.yaml test/k8sT/manifests/v1.4/cilium-cm-patch-clean-cilium-state.yaml
index a0a9831bf..77b18697b 100644
--- test/k8sT/manifests/v1.4/cilium-cm-patch-clean-cilium-state.yaml
+++ test/k8sT/manifests/v1.4/cilium-cm-patch-clean-cilium-state.yaml
@@ -7,10 +7,10 @@ data:
     endpoints:
       - https://cilium-etcd-client.kube-system.svc:2379
     #
-    # In case you want to use TLS in etcd, uncomment the 'ca-file' line
+    # In case you want to use TLS in etcd, uncomment the 'trusted-ca-file' line
     # and create a kubernetes secret by following the tutorial in
     # https://cilium.link/etcd-config
-    ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
+    trusted-ca-file: '/var/lib/etcd-secrets/etcd-client-ca.crt'
     #
     # In case you want client to server authentication, uncomment the following
     # lines and create a kubernetes secret by following the tutorial in
diff --git tests/k8s/cluster/cluster-manager.bash tests/k8s/cluster/cluster-manager.bash
index 3986f0765..df8cd7545 100755
--- tests/k8s/cluster/cluster-manager.bash
+++ tests/k8s/cluster/cluster-manager.bash
@@ -337,7 +337,7 @@ function deploy_cilium(){
                 s+image: cilium/cilium:stable+image: cilium/cilium:${docker_image_tag}+g;\
                 s+imagePullPolicy: Always+imagePullPolicy: Never+g;\
                 s+debug: \"false\"+debug: \"true\"+g;\
-                s+#ca-file: '+ca-file: '+g;\
+                s+#trusted-ca-file: '+trusted-ca-file: '+g;\
                 s+etcd-ca: \"\"+etcd-ca: \""$(base64 -w 0 "${certs_dir}/ca.pem")"\"+g" \
             "${cilium_original}" > "${cilium_dir}/cilium.yaml"
 
-- 
2.23.0

