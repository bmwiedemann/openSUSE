From ca4929c77b9923e357900703f0a3861ebcbc1306 Mon Sep 17 00:00:00 2001
From: John Paul Adrian Glaubitz <glaubitz@physik.fu-berlin.de>
Date: Thu, 26 Jan 2023 09:29:29 +0100
Subject: [PATCH] Fix crash in on_socket_created() when password storage is
 enabled

Fixes #164
---
 pan/tasks/nntp-pool.cc | 14 ++++----------
 1 file changed, 4 insertions(+), 10 deletions(-)

diff --git a/pan/tasks/nntp-pool.cc b/pan/tasks/nntp-pool.cc
index 434881f..ece1c5f 100644
--- a/pan/tasks/nntp-pool.cc
+++ b/pan/tasks/nntp-pool.cc
@@ -187,16 +187,10 @@ NNTP_Pool :: on_socket_created (const StringView  & host,
     // okay, we at least established a connection.
     // now try to handshake and pass the buck to on_nntp_done().
     NNTP * nntp;
-    if (!_prefs.get_flag("use-password-storage", false))
-    {
-      std::string pw (pass ? pass : "");
-      if (pass) g_free(pass);
-      nntp = new NNTP (_server, user, pw, _server_info, socket);
-    }
-    else
-    {
-      nntp = new NNTP ( _server, user, pass, _server_info, socket);
-    }
+    std::string pw (pass ? pass : "");
+    nntp = new NNTP (_server, user, pw, _server_info, socket);
+    if (!_prefs.get_flag("use-password-storage", false) && pass)
+      g_free(pass);
     nntp->handshake (this);
   }
 }
-- 
2.30.2

