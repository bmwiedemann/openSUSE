From 1473e8eb6eb59dc7521dcd5f8a4c9390e9b53223 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?J=2E=20David=20Ib=C3=A1=C3=B1ez?= <jdavid.ibp@gmail.com>
Date: Mon, 17 Jul 2023 22:23:30 +0200
Subject: [PATCH] Upgrade to libgit2 v1.7.0

---
 .github/workflows/tests.yml  |  8 ++++----
 .github/workflows/wheels.yml |  4 ++--
 CHANGELOG.rst                |  9 +++++++++
 Makefile                     |  2 +-
 appveyor.yml                 |  2 +-
 build.sh                     | 12 ++++++------
 docs/install.rst             | 18 ++++++++++--------
 pygit2/decl/diff.h           |  1 +
 pygit2/decl/oid.h            |  4 ++++
 pygit2/decl/remote.h         |  1 +
 src/types.h                  |  4 ++--
 11 files changed, 41 insertions(+), 24 deletions(-)

Index: pygit2-1.12.2/CHANGELOG.rst
===================================================================
--- pygit2-1.12.2.orig/CHANGELOG.rst
+++ pygit2-1.12.2/CHANGELOG.rst
@@ -1,3 +1,12 @@
+1.13.0 (UNRELEASED)
+-------------------------
+
+- Upgrade to libgit2 v1.7.0
+
+- docs: update links to pypy, pygit2.org
+  `#1228 <https://github.com/libgit2/pygit2/pull/1228>`_
+
+
 1.12.2 (2023-06-25)
 -------------------------
 
Index: pygit2-1.12.2/Makefile
===================================================================
--- pygit2-1.12.2.orig/Makefile
+++ pygit2-1.12.2/Makefile
@@ -1,7 +1,7 @@
 .PHONY: build html
 
 build:
-	OPENSSL_VERSION=3.0.9 LIBSSH2_VERSION=1.11.0 LIBGIT2_VERSION=1.6.4 sh build.sh
+	OPENSSL_VERSION=3.0.9 LIBSSH2_VERSION=1.11.0 LIBGIT2_VERSION=1.7.0 sh build.sh
 
 html: build
 	make -C docs html
Index: pygit2-1.12.2/build.sh
===================================================================
--- pygit2-1.12.2.orig/build.sh
+++ pygit2-1.12.2/build.sh
@@ -26,19 +26,19 @@
 #
 #   sh build.sh
 #
-# Build libgit2 1.6.4 (will use libssh2 if available), then build pygit2
+# Build libgit2 1.7.0 (will use libssh2 if available), then build pygit2
 # inplace:
 #
-#   LIBGIT2_VERSION=1.6.4 sh build.sh
+#   LIBGIT2_VERSION=1.7.0 sh build.sh
 #
-# Build libssh2 1.11.0 and libgit2 1.6.4, then build pygit2 inplace:
+# Build libssh2 1.11.0 and libgit2 1.7.0, then build pygit2 inplace:
 #
-#   LIBSSH2_VERSION=1.11.0 LIBGIT2_VERSION=1.6.4 sh build.sh
+#   LIBSSH2_VERSION=1.11.0 LIBGIT2_VERSION=1.7.0 sh build.sh
 #
-# Tell where libssh2 is installed, build libgit2 1.6.4, then build pygit2
+# Tell where libssh2 is installed, build libgit2 1.7.0, then build pygit2
 # inplace:
 #
-#   LIBSSH2_PREFIX=/usr/local LIBGIT2_VERSION=1.6.4 sh build.sh
+#   LIBSSH2_PREFIX=/usr/local LIBGIT2_VERSION=1.7.0 sh build.sh
 #
 # Build inplace and run the tests:
 #
Index: pygit2-1.12.2/pygit2/decl/diff.h
===================================================================
--- pygit2-1.12.2.orig/pygit2/decl/diff.h
+++ pygit2-1.12.2/pygit2/decl/diff.h
@@ -54,6 +54,7 @@ typedef struct {
 	void                *payload;
 	uint32_t    context_lines;
 	uint32_t    interhunk_lines;
+	git_oid_t   oid_type;
 	uint16_t    id_abbrev;
 	git_off_t   max_size;
 	const char *old_prefix;
Index: pygit2-1.12.2/pygit2/decl/oid.h
===================================================================
--- pygit2-1.12.2.orig/pygit2/decl/oid.h
+++ pygit2-1.12.2/pygit2/decl/oid.h
@@ -1,3 +1,7 @@
+typedef enum {
+	GIT_OID_SHA1 = 1,  /**< SHA1 */
+} git_oid_t;
+
 typedef struct git_oid {
 	unsigned char id[20];
 } git_oid;
Index: pygit2-1.12.2/pygit2/decl/remote.h
===================================================================
--- pygit2-1.12.2.orig/pygit2/decl/remote.h
+++ pygit2-1.12.2/pygit2/decl/remote.h
@@ -83,6 +83,7 @@ typedef struct {
 	int update_fetchhead;
 	git_remote_autotag_option_t download_tags;
 	git_proxy_options proxy_opts;
+	int depth;
 	git_remote_redirect_t follow_redirects;
 	git_strarray custom_headers;
 } git_fetch_options;
Index: pygit2-1.12.2/src/types.h
===================================================================
--- pygit2-1.12.2.orig/src/types.h
+++ pygit2-1.12.2/src/types.h
@@ -32,8 +32,8 @@
 #include <Python.h>
 #include <git2.h>
 
-#if !(LIBGIT2_VER_MAJOR == 1 && LIBGIT2_VER_MINOR == 6)
-#error You need a compatible libgit2 version (1.6.x)
+#if !(LIBGIT2_VER_MAJOR == 1 && LIBGIT2_VER_MINOR == 7)
+#error You need a compatible libgit2 version (1.7.x)
 #endif
 
 /*
