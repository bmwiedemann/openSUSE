From e9f61bd37d7269aec15c15a98d2353c809ee0f86 Mon Sep 17 00:00:00 2001
From: Jonathan Kang <jonathankang@gnome.org>
Date: Fri, 22 Jul 2022 15:11:15 +0800
Subject: [PATCH] zypp: Avoid statuReset() on locked packages

https://bugzilla.suse.com/show_bug.cgi?id=1199895
---
 backends/zypp/pk-backend-zypp.cpp | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

Index: PackageKit-1.2.5/backends/zypp/pk-backend-zypp.cpp
===================================================================
--- PackageKit-1.2.5.orig/backends/zypp/pk-backend-zypp.cpp
+++ PackageKit-1.2.5/backends/zypp/pk-backend-zypp.cpp
@@ -1482,7 +1482,7 @@ zypp_perform_execution (PkBackendJob *jo
 			ResPool pool = ResPool::instance ();
 			for (ResPool::const_iterator it = pool.begin (); it != pool.end (); ++it) {
 				if (it->status ().isToBeInstalled ())
-					it->statusReset ();
+					it->statusReinit ();
 			}
 
 			pk_backend_job_error_code (job, PK_ERROR_ENUM_DEP_RESOLUTION_FAILED, "%s", emsg);
@@ -1520,7 +1520,7 @@ zypp_perform_execution (PkBackendJob *jo
 				switch (type) {
 				case REMOVE:
 					if (!(*it)->isSystem ()) {
-						it->statusReset ();
+						it->statusReinit ();
 						continue;
 					}
 					break;
@@ -1537,7 +1537,7 @@ zypp_perform_execution (PkBackendJob *jo
 				
 				if (!zypp_backend_pool_item_notify (job, *it, TRUE))
 					ret = FALSE;
-				it->statusReset ();
+				it->statusReinit ();
 			}
 			goto exit;
 		}
@@ -2849,7 +2849,7 @@ backend_install_packages_thread (PkBacke
 		if (!zypp_perform_execution (job, zypp, INSTALL, FALSE, transaction_flags)) {
 			// reset the status of the marked packages
 			for (vector<PoolItem>::iterator it = items.begin (); it != items.end (); ++it) {
-				it->statusReset ();
+				it->statusReinit ();
 			}
 			return;
 		}
@@ -2954,7 +2954,7 @@ backend_remove_packages_thread (PkBacken
 		if (!zypp_perform_execution (job, zypp, REMOVE, TRUE, transaction_flags)) {
 			//reset the status of the marked packages
 			for (vector<PoolItem>::iterator it = items.begin (); it != items.end (); ++it) {
-				it->statusReset();
+				it->statusReinit();
 			}
 			zypp_backend_finished_error (
 				job, PK_ERROR_ENUM_TRANSACTION_ERROR,
@@ -3803,7 +3803,7 @@ backend_what_provides_thread (PkBackendJ
 				zypp_backend_package (job, status, it->resolvable()->satSolvable(),
 						      it->resolvable ()->summary ().c_str ());
 			}
-			it->statusReset ();
+			it->statusReinit ();
 		}
 		solver.setIgnoreAlreadyRecommended (FALSE);
 	} else {
