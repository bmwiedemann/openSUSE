From 1f937b09bc268725cfdb09fc88939d1acde24b25 Mon Sep 17 00:00:00 2001
From: Bernat Gabor <bgabor8@bloomberg.net>
Date: Sat, 4 Jul 2020 17:37:51 +0100
Subject: [PATCH] Fix test suite failing if run under system Python

Signed-off-by: Bernat Gabor <bgabor8@bloomberg.net>
---
 docs/changelog/1882.bufix.rst                | 1 +
 tests/conftest.py                            | 7 +++++++
 tests/unit/discovery/py_info/test_py_info.py | 2 +-
 3 files changed, 9 insertions(+), 1 deletion(-)
 create mode 100644 docs/changelog/1882.bufix.rst

diff --git a/docs/changelog/1882.bufix.rst b/docs/changelog/1882.bufix.rst
new file mode 100644
index 000000000..25669a364
--- /dev/null
+++ b/docs/changelog/1882.bufix.rst
@@ -0,0 +1 @@
+Fix test suite failing if run from system Python - by :user:`gaborbernat`.
diff --git a/tests/conftest.py b/tests/conftest.py
index 97e109e93..e69e4d72d 100644
--- a/tests/conftest.py
+++ b/tests/conftest.py
@@ -342,3 +342,10 @@ def cross_python(is_inside_ci, session_app_data):
 @pytest.fixture(scope="session")
 def for_py_version():
     return "{}.{}".format(*sys.version_info[0:2])
+
+
+@pytest.fixture()
+def skip_if_test_in_system(session_app_data):
+    current = PythonInfo.current(session_app_data)
+    if current.system_executable is not None:
+        pytest.skip("test not valid if run under system")
diff --git a/tests/unit/discovery/py_info/test_py_info.py b/tests/unit/discovery/py_info/test_py_info.py
index 11f3dcc26..6ed11c3e2 100644
--- a/tests/unit/discovery/py_info/test_py_info.py
+++ b/tests/unit/discovery/py_info/test_py_info.py
@@ -299,7 +299,7 @@ def test_py_info_setuptools():
     PythonInfo()
 
 
-def test_py_info_to_system_raises(session_app_data, mocker, caplog):
+def test_py_info_to_system_raises(session_app_data, mocker, caplog, skip_if_test_in_system):
     caplog.set_level(logging.DEBUG)
     mocker.patch.object(PythonInfo, "_find_possible_folders", return_value=[])
     result = PythonInfo.from_exe(sys.executable, app_data=session_app_data, raise_on_error=False)
