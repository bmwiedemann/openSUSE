From e3858c140eb2ed0d86b0cf00c94099252f047e41 Mon Sep 17 00:00:00 2001
From: Daniel Garcia Moreno <daniel.garcia@suse.com>
Date: Mon, 26 Sep 2022 12:25:20 +0200
Subject: [PATCH] Revert "[CMake] Statically link libxml2 for Linux"

This reverts commit 257a83214b3951588c1e7f3977b950517e23cbf5.
---
 CMakeLists.txt                        | 11 ++++-------
 c/makeotf/lib/cffread/CMakeLists.txt  |  2 +-
 c/makeotf/lib/hotconv/CMakeLists.txt  |  2 +-
 c/makeotf/lib/pstoken/CMakeLists.txt  |  2 +-
 c/makeotf/lib/typecomp/CMakeLists.txt |  2 +-
 c/makeotf/source/CMakeLists.txt       |  2 +-
 c/mergefonts/source/CMakeLists.txt    |  2 +-
 c/rotatefont/source/CMakeLists.txt    |  2 +-
 c/shared/source/CMakeLists.txt        |  6 +++---
 c/tx/source/CMakeLists.txt            |  2 +-
 cmake/ExternalLibXML2.cmake           |  2 +-
 12 files changed, 16 insertions(+), 22 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a2423022..9ce80598 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -42,16 +42,13 @@ set(ANTLR4_WITH_STATIC_CRT OFF)
 set(ANTLR4_TAG tags/4.9.3)
 include(ExternalAntlr4Cpp)
 
-
 FIND_PACKAGE(LibXml2)
-IF ((NOT ${LibXml2_FOUND}) OR "${CMAKE_SYSTEM}" MATCHES "Linux")
-   MESSAGE(STATUS "Could not locate LibXml2 or system is Linux, will install externally & statically link")
+IF (NOT ${LibXml2_FOUND})
+   MESSAGE(STATUS "Could not locate LibXml2, will install externally.")
    set(LIBXML2_TAG tags/v2.9.13)
    include(ExternalLibXML2)
-   include_directories(${LIBXML2_STATIC_INCLUDE_DIR})
-ELSE ((NOT ${LibXml2_FOUND}) OR "${CMAKE_SYSTEM}" MATCHES "Linux")
-   include_directories(${LIBXML2_INCLUDE_DIR})
-ENDIF((NOT ${LibXml2_FOUND}) OR "${CMAKE_SYSTEM}" MATCHES "Linux")
+ENDIF(NOT ${LibXml2_FOUND})
+include_directories(${LIBXML2_INCLUDE_DIR})
 
 # sanitizer support
 # work around https://github.com/pypa/setuptools/issues/1928 with environment
diff --git a/c/makeotf/lib/cffread/CMakeLists.txt b/c/makeotf/lib/cffread/CMakeLists.txt
index 7d74e512..9a400fde 100644
--- a/c/makeotf/lib/cffread/CMakeLists.txt
+++ b/c/makeotf/lib/cffread/CMakeLists.txt
@@ -2,7 +2,7 @@ add_library(makeotf_cffread STATIC cffread.c)
 
 target_include_directories(makeotf_cffread PRIVATE AFTER $<$<COMPILE_LANGUAGE:CXX>:${ANTLR4_INCLUDE_DIRS}>)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(makeotf_cffread PUBLIC ${LIBXML2_LIBRARY})
 else ()
     add_dependencies(makeotf_cffread ${LIBXML2_TARGET})
diff --git a/c/makeotf/lib/hotconv/CMakeLists.txt b/c/makeotf/lib/hotconv/CMakeLists.txt
index 14e5c3cd..3cceceea 100644
--- a/c/makeotf/lib/hotconv/CMakeLists.txt
+++ b/c/makeotf/lib/hotconv/CMakeLists.txt
@@ -71,7 +71,7 @@ set_property(TARGET hotconv PROPERTY C_STANDARD 99)
 target_include_directories(hotconv PRIVATE AFTER $<$<COMPILE_LANGUAGE:CXX>:${ANTLR4_INCLUDE_DIRS}>)
 target_link_libraries(hotconv PUBLIC antlr4_static)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(hotconv PUBLIC ${LIBXML2_LIBRARY})
 else ()
     add_dependencies(hotconv ${LIBXML2_TARGET})
diff --git a/c/makeotf/lib/pstoken/CMakeLists.txt b/c/makeotf/lib/pstoken/CMakeLists.txt
index a0fd67d3..1f928976 100644
--- a/c/makeotf/lib/pstoken/CMakeLists.txt
+++ b/c/makeotf/lib/pstoken/CMakeLists.txt
@@ -1,6 +1,6 @@
 add_library(makeotf_pstoken STATIC pstoken.c)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(makeotf_pstoken PUBLIC ${LIBXML2_LIBRARY})
 else ()
     add_dependencies(makeotf_pstoken ${LIBXML2_TARGET})
diff --git a/c/makeotf/lib/typecomp/CMakeLists.txt b/c/makeotf/lib/typecomp/CMakeLists.txt
index ce6e3592..39cbd8a5 100644
--- a/c/makeotf/lib/typecomp/CMakeLists.txt
+++ b/c/makeotf/lib/typecomp/CMakeLists.txt
@@ -45,7 +45,7 @@ add_library(typecomp STATIC
     tc.c
 )
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(typecomp PUBLIC ${LIBXML2_LIBRARY})
 else ()
     add_dependencies(typecomp ${LIBXML2_TARGET})
diff --git a/c/makeotf/source/CMakeLists.txt b/c/makeotf/source/CMakeLists.txt
index 625c4b0b..5f15b3a0 100644
--- a/c/makeotf/source/CMakeLists.txt
+++ b/c/makeotf/source/CMakeLists.txt
@@ -27,7 +27,7 @@ if (HAVE_M_LIB)
     target_link_libraries(makeotfexe PRIVATE m)
 endif ()
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(makeotfexe PUBLIC ${LIBXML2_LIBRARY})
 else ()
     if (WIN32)
diff --git a/c/mergefonts/source/CMakeLists.txt b/c/mergefonts/source/CMakeLists.txt
index 4c87283b..b77d1ef4 100644
--- a/c/mergefonts/source/CMakeLists.txt
+++ b/c/mergefonts/source/CMakeLists.txt
@@ -9,7 +9,7 @@ target_include_directories(mergefonts PRIVATE ../../shared/include ../../shared/
 
 target_link_libraries(mergefonts PUBLIC tx_shared)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if (${LibXml2_FOUND})
     target_link_libraries(mergefonts PUBLIC ${LIBXML2_LIBRARY})
 else ()
     add_dependencies(mergefonts ${LIBXML2_TARGET})
diff --git a/c/rotatefont/source/CMakeLists.txt b/c/rotatefont/source/CMakeLists.txt
index 69bfcebf..6d3660d3 100644
--- a/c/rotatefont/source/CMakeLists.txt
+++ b/c/rotatefont/source/CMakeLists.txt
@@ -9,7 +9,7 @@ target_include_directories(rotatefont PRIVATE ../../shared/include ../../shared/
 
 target_link_libraries(rotatefont PUBLIC tx_shared)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if(${LibXml2_FOUND})
     target_link_libraries(rotatefont PUBLIC ${LIBXML2_LIBRARY})
 else()
     add_dependencies(rotatefont ${LIBXML2_TARGET})
diff --git a/c/shared/source/CMakeLists.txt b/c/shared/source/CMakeLists.txt
index 08ad93b1..f6a4ca04 100644
--- a/c/shared/source/CMakeLists.txt
+++ b/c/shared/source/CMakeLists.txt
@@ -3,9 +3,9 @@ include_directories(../include ../resource)
 MACRO(ADD_AFDKOLIB lm)
     file(GLOB sl_sources "${lm}/*")
     add_library(${lm} STATIC ${sl_sources})
-    if((NOT ${LibXml2_FOUND}) OR "${CMAKE_SYSTEM}" MATCHES "Linux")
+    if(NOT ${LibXml2_FOUND})
         add_dependencies(${lm} ${LIBXML2_TARGET})
-    endif((NOT ${LibXml2_FOUND}) OR "${CMAKE_SYSTEM}" MATCHES "Linux")
+    endif(NOT ${LibXml2_FOUND})
 ENDMACRO(ADD_AFDKOLIB)
 
 ADD_AFDKOLIB(absfont)
@@ -47,7 +47,7 @@ target_compile_definitions(t1write PRIVATE $<$<CONFIG:Debug>:T1W_DEBUG=1>)
 target_compile_definitions(ttread PRIVATE $<$<CONFIG:Debug>:TTR_DEBUG=1>)
 target_compile_definitions(tx_shared PRIVATE $<$<CONFIG:Debug>:CFW_DEBUG=1>)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if(${LibXml2_FOUND})
     target_link_libraries(tx_shared PUBLIC ${LIBXML2_LIBRARY})
 else()
     target_compile_definitions(tx_shared PUBLIC -DLIBXML_STATIC)
diff --git a/c/tx/source/CMakeLists.txt b/c/tx/source/CMakeLists.txt
index dad21cc6..684cb7ed 100644
--- a/c/tx/source/CMakeLists.txt
+++ b/c/tx/source/CMakeLists.txt
@@ -8,7 +8,7 @@ add_executable(tx
 target_include_directories(tx PRIVATE ../../shared/include ../../shared/resource ../../shared/source/tx_shared)
 target_link_libraries(tx PUBLIC tx_shared)
 
-if ((${LibXml2_FOUND}) AND (NOT "${CMAKE_SYSTEM}" MATCHES "Linux"))
+if(${LibXml2_FOUND})
     target_link_libraries(tx PUBLIC ${LIBXML2_LIBRARY})
 else()
     add_dependencies(tx ${LIBXML2_TARGET})
diff --git a/cmake/ExternalLibXML2.cmake b/cmake/ExternalLibXML2.cmake
index a26252c0..df4233b9 100644
--- a/cmake/ExternalLibXML2.cmake
+++ b/cmake/ExternalLibXML2.cmake
@@ -43,7 +43,7 @@ set_target_properties(libxml2 PROPERTIES
   INTERFACE_INCLUDE_DIRECTORIES ${SOURCE_DIR}/include)
 target_include_directories(libxml2 INTERFACE ${SOURCE_DIR}/include INTERFACE ${BINARY_DIR})
 
-set(LIBXML2_STATIC_INCLUDE_DIR ${SOURCE_DIR}/include ${BINARY_DIR})
+set(LIBXML2_INCLUDE_DIR ${SOURCE_DIR}/include ${BINARY_DIR})
 
 set(LIBXML2_WIN_LIBRARIES wsock32 ws2_32 libxml2)
 
-- 
2.37.3

