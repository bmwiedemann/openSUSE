From 1ea9f1dc0ac4e871b7a54a8f3b12a01ac7d5f3d7 Mon Sep 17 00:00:00 2001
From: Ralf Gommers <ralf.gommers@gmail.com>
Date: Tue, 16 Jul 2024 17:49:38 +0200
Subject: [PATCH] BLD: bump minimum pybind11 version to 2.13.1, mark
 pypocketfft as safe without GIL

---
 pyproject.toml                       | 2 +-
 requirements/build.txt               | 2 +-
 scipy/fft/_pocketfft/pypocketfft.cxx | 3 ++-
 scipy/meson.build                    | 2 +-
 4 files changed, 5 insertions(+), 4 deletions(-)

Index: scipy-1.14.1/requirements/build.txt
===================================================================
--- scipy-1.14.1.orig/requirements/build.txt
+++ scipy-1.14.1/requirements/build.txt
@@ -2,7 +2,7 @@
 # Do not edit this file; modify `pyproject.toml` instead and run `python tools/generate_requirements.py`.
 meson-python>=0.15.0
 Cython>=3.0.8
-pybind11>=2.12.0
+pybind11>=2.13.1
 pythran>=0.14.0
 ninja
 numpy>=1.23.5
Index: scipy-1.14.1/scipy/fft/_pocketfft/pypocketfft.cxx
===================================================================
--- scipy-1.14.1.orig/scipy/fft/_pocketfft/pypocketfft.cxx
+++ scipy-1.14.1/scipy/fft/_pocketfft/pypocketfft.cxx
@@ -12,6 +12,7 @@
  *  \author Peter Bell
  */
 
+// Note: do not reorder, pybind11.h must come first (it includes Python.h)
 #include <pybind11/pybind11.h>
 #include <pybind11/numpy.h>
 #include <pybind11/stl.h>
@@ -756,7 +757,7 @@ out : int
 
 } // unnamed namespace
 
-PYBIND11_MODULE(pypocketfft, m)
+PYBIND11_MODULE(pypocketfft, m, py::mod_gil_not_used())
   {
   using namespace pybind11::literals;
 
Index: scipy-1.14.1/scipy/meson.build
===================================================================
--- scipy-1.14.1.orig/scipy/meson.build
+++ scipy-1.14.1/scipy/meson.build
@@ -83,7 +83,7 @@ fortranobject_c = incdir_f2py / 'fortran
 npymath_path = _incdir_numpy_abs / '..' / 'lib'
 npymath_lib = cc.find_library('npymath', dirs: npymath_path)
 
-pybind11_dep = dependency('pybind11', version: '>=2.12.0')
+pybind11_dep = dependency('pybind11', version: '>=2.13.1')
 
 # Pythran include directory and build flags
 if use_pythran
Index: scipy-1.14.1/pyproject.toml
===================================================================
--- scipy-1.14.1.orig/pyproject.toml
+++ scipy-1.14.1/pyproject.toml
@@ -24,7 +24,7 @@ requires = [
     # The upper bound on Cython is pre-emptive only
     "Cython>=3.0.8,<3.1.0",        # when updating version, also update check in meson.build
     # The upper bound on pybind11 is pre-emptive only
-    "pybind11>=2.12.0,<2.13.0",     # when updating version, also update check in scipy/meson.build
+    "pybind11>=2.13.1,<2.14.0",     # when updating version, also update check in scipy/meson.build
     # The upper bound on pythran is pre-emptive only; 0.16.1
     # is released/working at time of writing.
     "pythran>=0.14.0,<0.17.0",
