From cfd5f6615971d17cc538830421c02f3221b023c3 Mon Sep 17 00:00:00 2001
From: nate <njsimon10@gmail.com>
Date: Sat, 20 Jan 2024 10:19:56 -0600
Subject: [PATCH] apply jxl patch from gthumb, adds support for jxl-0.9.0

---
 extensions/cairo_io/cairo-image-surface-jxl.c | 18 +++++++++++++++---
 1 file changed, 15 insertions(+), 3 deletions(-)

diff --git a/extensions/cairo_io/cairo-image-surface-jxl.c b/extensions/cairo_io/cairo-image-surface-jxl.c
index b43d13c1..36a8588c 100644
--- a/extensions/cairo_io/cairo-image-surface-jxl.c
+++ b/extensions/cairo_io/cairo-image-surface-jxl.c
@@ -234,18 +234,30 @@ _cairo_image_surface_create_from_jxl(GInputStream  *istream,
 
 		case JXL_DEC_COLOR_ENCODING:
 #if HAVE_LCMS2
-			if (JxlDecoderGetColorAsEncodedProfile(dec, &pixel_format, JXL_COLOR_PROFILE_TARGET_DATA, NULL) == JXL_DEC_SUCCESS)
+			if (JxlDecoderGetColorAsEncodedProfile(dec,
+#if JPEGXL_NUMERIC_VERSION < JPEGXL_COMPUTE_NUMERIC_VERSION(0,9,0)
+			&pixel_format,
+#endif
+			JXL_COLOR_PROFILE_TARGET_DATA, NULL) == JXL_DEC_SUCCESS)
 				break;
 
 			{
 				gsize profile_size;
-				if (JxlDecoderGetICCProfileSize(dec, &pixel_format, JXL_COLOR_PROFILE_TARGET_DATA, &profile_size) > 0) {
+				if (JxlDecoderGetICCProfileSize(dec,
+#if JPEGXL_NUMERIC_VERSION < JPEGXL_COMPUTE_NUMERIC_VERSION(0,9,0)
+				&pixel_format,
+#endif
+				JXL_COLOR_PROFILE_TARGET_DATA, &profile_size) > 0) {
 					g_message("Could not get ICC profile size.\n");
 					break;
 				}
 
 				guchar *profile_data = g_new(guchar, profile_size);
-				if (JxlDecoderGetColorAsICCProfile(dec, &pixel_format, JXL_COLOR_PROFILE_TARGET_DATA, profile_data, profile_size) > 0) {
+				if (JxlDecoderGetColorAsICCProfile(dec,
+#if JPEGXL_NUMERIC_VERSION < JPEGXL_COMPUTE_NUMERIC_VERSION(0,9,0)
+				&pixel_format,
+#endif
+				JXL_COLOR_PROFILE_TARGET_DATA, profile_data, profile_size) > 0) {
 					g_message("Could not get ICC profile.\n");
 					g_free(profile_data);
 					break;
