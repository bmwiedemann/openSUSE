From e815b790c41a96ef7518a23ab28d9e3bec088541 Mon Sep 17 00:00:00 2001
From: Tristan Cacqueray <tdecacqu@redhat.com>
Date: Tue, 30 Jul 2019 14:03:12 +0000
Subject: Fix scikit-learn 0.21.3 support

Recent scikit release doesn't embed the joblib.

Change-Id: Ie8ad434ea08bf72e7418b116b71ed335b38e1252
---
 logreduce/process.py            | 10 +++++++---
 logreduce/tests/test_process.py |  8 ++++++--
 2 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/logreduce/process.py b/logreduce/process.py
index f0c8d9b..c934840 100644
--- a/logreduce/process.py
+++ b/logreduce/process.py
@@ -22,7 +22,11 @@ import uuid
 import numpy as np
 import sklearn.utils.validation
 import sklearn.exceptions
-import sklearn.externals
+try:
+    from sklearn.externals import joblib
+except ImportError:
+    # Recent sklearn library doesn't vendor joblib anymore
+    import joblib
 
 from logreduce.models import models
 from logreduce.tokenizer import remove_ansible_std_lines_lists
@@ -63,7 +67,7 @@ class Classifier:
             fileobj = open(fileobj, 'wb')
         fileobj.write(b'LGRD')
         fileobj.write(struct.pack('I', self.version))
-        sklearn.externals.joblib.dump(self, fileobj, compress=True)
+        joblib.dump(self, fileobj, compress=True)
         self.log.debug("%s: written" % fileobj.name)
 
     @staticmethod
@@ -81,7 +85,7 @@ class Classifier:
         if isinstance(fileobj, str):
             fileobj = open(fileobj, 'rb')
         Classifier.check(fileobj)
-        return sklearn.externals.joblib.load(fileobj)
+        return joblib.load(fileobj)
 
     @staticmethod
     def filename2modelname(filename):
diff --git a/logreduce/tests/test_process.py b/logreduce/tests/test_process.py
index 0889bb6..b27e692 100644
--- a/logreduce/tests/test_process.py
+++ b/logreduce/tests/test_process.py
@@ -43,8 +43,12 @@ class ProcessTests(unittest.TestCase):
         logreduce.process.Classifier.check(model)
         # joblib load reset the seek for io bytes, bypass model check in test
         model = io.BytesIO(model.read())
-        import sklearn
-        clf = sklearn.externals.joblib.load(model)
+        try:
+            from sklearn.externals import joblib
+        except ImportError:
+            # Recent sklearn library doesn't vendor joblib anymore
+            import joblib
+        clf = joblib.load(model)
 
         # Re-use the model with another test file
         target = os.path.join(os.path.dirname(baseline), "test_units.py")
-- 
cgit v1.2.1

