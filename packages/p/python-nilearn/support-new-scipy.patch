From 5effd2789ed89042a41575fef4a6fc97922b0ac0 Mon Sep 17 00:00:00 2001
From: Remi Gau <remi_gau@hotmail.com>
Date: Tue, 23 Apr 2024 13:58:35 +0200
Subject: [PATCH 1/2] changed cg parameters

---
 nilearn/_utils/segmentation.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/nilearn/_utils/segmentation.py b/nilearn/_utils/segmentation.py
index 8c6367b847..3cc47d87f1 100644
--- a/nilearn/_utils/segmentation.py
+++ b/nilearn/_utils/segmentation.py
@@ -355,7 +355,7 @@ def _solve_cg(lap_sparse, B, tol):
     lap_sparse = lap_sparse.tocsc()
     X = []
     for i in range(len(B)):
-        x0 = cg(lap_sparse, -B[i].todense(), tol=tol, atol="legacy")[0]
+        x0 = cg(lap_sparse, -B[i].todense(), rtol=tol, atol=0)[0]
         X.append(x0)
 
     X = np.array(X)

From 9075d6a15d17cfe9cb684f3a5ac8537af98c3af3 Mon Sep 17 00:00:00 2001
From: Remi Gau <remi_gau@hotmail.com>
Date: Wed, 24 Apr 2024 08:38:48 +0200
Subject: [PATCH 2/2] fix compat support scipy < 1.12 [test nightly]

---
 nilearn/_utils/segmentation.py | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/nilearn/_utils/segmentation.py b/nilearn/_utils/segmentation.py
index 3cc47d87f1..844e018807 100644
--- a/nilearn/_utils/segmentation.py
+++ b/nilearn/_utils/segmentation.py
@@ -11,10 +11,12 @@
 import warnings
 
 import numpy as np
-from scipy import ndimage as ndi, sparse
+from scipy import __version__, ndimage as ndi, sparse
 from scipy.sparse.linalg import cg
 from sklearn.utils import as_float_array
 
+from nilearn._utils.helpers import compare_version
+
 
 def _make_graph_edges_3d(n_x, n_y, n_z):
     """Return a list of edges for a 3D image.
@@ -355,7 +357,14 @@ def _solve_cg(lap_sparse, B, tol):
     lap_sparse = lap_sparse.tocsc()
     X = []
     for i in range(len(B)):
-        x0 = cg(lap_sparse, -B[i].todense(), rtol=tol, atol=0)[0]
+        # TODO Python 3.8
+        # consider remove if/else block when dropping support for 3.8
+        # would require pinning scipy to >= 1.12
+        # See https://github.com/nilearn/nilearn/pull/4394
+        if compare_version(__version__, ">=", "1.12"):
+            x0 = cg(lap_sparse, -B[i].todense(), rtol=tol, atol=0)[0]
+        else:
+            x0 = cg(lap_sparse, -B[i].todense(), tol=tol, atol="legacy")[0]
         X.append(x0)
 
     X = np.array(X)
