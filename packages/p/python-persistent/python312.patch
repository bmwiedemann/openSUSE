From 2195d2edd96ad209568cbaa8499eb87c2fb8fc4e Mon Sep 17 00:00:00 2001
From: Michael Howitz <mh@gocept.com>
Date: Thu, 30 Mar 2023 08:34:00 +0200
Subject: [PATCH] Add preliminary support for Python 3.12a6.

---
 .github/workflows/tests.yml              | 34 +++++++++++++++++++++---
 .manylinux-install.sh                    | 11 ++++++--
 .meta.toml                               |  4 +--
 CHANGES.rst                              |  2 +-
 appveyor.yml                             |  3 +++
 setup.cfg                                |  2 +-
 src/persistent/tests/test_persistence.py |  5 ----
 src/persistent/tests/test_picklecache.py |  5 ----
 tox.ini                                  |  5 +++-
 9 files changed, 50 insertions(+), 21 deletions(-)

Index: persistent-5.0/.manylinux-install.sh
===================================================================
--- persistent-5.0.orig/.manylinux-install.sh
+++ persistent-5.0/.manylinux-install.sh
@@ -28,6 +28,7 @@ yum -y install libffi-devel
 
 tox_env_map() {
     case $1 in
+        *"cp312"*) echo 'py312';;
         *"cp37"*) echo 'py37';;
         *"cp38"*) echo 'py38';;
         *"cp39"*) echo 'py39';;
@@ -40,13 +41,19 @@ tox_env_map() {
 # Compile wheels
 for PYBIN in /opt/python/*/bin; do
     if \
+       [[ "${PYBIN}" == *"cp312"* ]] || \
        [[ "${PYBIN}" == *"cp311"* ]] || \
        [[ "${PYBIN}" == *"cp37"* ]] || \
        [[ "${PYBIN}" == *"cp38"* ]] || \
        [[ "${PYBIN}" == *"cp39"* ]] || \
        [[ "${PYBIN}" == *"cp310"* ]] ; then
-        "${PYBIN}/pip" install -e /io/
-        "${PYBIN}/pip" wheel /io/ -w wheelhouse/
+        if [[ "${PYBIN}" == *"cp312"* ]] ; then
+            "${PYBIN}/pip" install --pre -e /io/
+            "${PYBIN}/pip" wheel /io/ --pre -w wheelhouse/
+        else
+            "${PYBIN}/pip" install -e /io/
+            "${PYBIN}/pip" wheel /io/ -w wheelhouse/
+        fi
         if [ `uname -m` == 'aarch64' ]; then
           cd /io/
           ${PYBIN}/pip install tox
Index: persistent-5.0/setup.cfg
===================================================================
--- persistent-5.0.orig/setup.cfg
+++ persistent-5.0/setup.cfg
@@ -19,7 +19,7 @@ ignore =
 force_single_line = True
 combine_as_imports = True
 sections = FUTURE,STDLIB,THIRDPARTY,ZOPE,FIRSTPARTY,LOCALFOLDER
-known_third_party = six, docutils, pkg_resources
+known_third_party = six, docutils, pkg_resources, pytz
 known_zope = 
 known_first_party = 
 default_section = ZOPE
Index: persistent-5.0/src/persistent/tests/test_persistence.py
===================================================================
--- persistent-5.0.orig/src/persistent/tests/test_persistence.py
+++ persistent-5.0/src/persistent/tests/test_persistence.py
@@ -29,11 +29,6 @@ from collections import UserDict as Iter
 
 class _Persistent_Base:
 
-    # py2/3 compat
-    assertRaisesRegex = getattr(unittest.TestCase,
-                                'assertRaisesRegex',
-                                unittest.TestCase.assertRaisesRegexp)
-
     def _getTargetClass(self):
         # concrete testcase classes must override
         raise NotImplementedError()
Index: persistent-5.0/src/persistent/tests/test_picklecache.py
===================================================================
--- persistent-5.0.orig/src/persistent/tests/test_picklecache.py
+++ persistent-5.0/src/persistent/tests/test_picklecache.py
@@ -60,11 +60,6 @@ def _len(seq):
 
 class PickleCacheTestMixin:
 
-    # py2/3 compat
-    assertRaisesRegex = getattr(unittest.TestCase,
-                                'assertRaisesRegex',
-                                unittest.TestCase.assertRaisesRegexp)
-
     def _getTargetClass(self):
         from persistent.picklecache import PickleCachePy as BasePickleCache
         class PickleCache(BasePickleCache):
