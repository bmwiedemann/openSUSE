From a87460582c3843acffb307217e5c3fa7061cdb2f Mon Sep 17 00:00:00 2001
From: Christophe Giboudeaux <christophe@krop.fr>
Date: Tue, 14 Jul 2020 14:37:22 +0200
Subject: [PATCH] Fix build with openSUSE clang9 package.

qt-creator doesn't support linking to clang-cpp instead of split libraries.
See https://bugreports.qt.io/browse/QTCREATORBUG-23172
---
 CMakeLists.txt                                          | 4 ++--
 src/plugins/clangcodemodel/CMakeLists.txt               | 2 +-
 src/plugins/clangformat/CMakeLists.txt                  | 4 ++--
 src/plugins/clangpchmanager/CMakeLists.txt              | 2 +-
 src/plugins/clangrefactoring/CMakeLists.txt             | 2 +-
 src/tools/clangpchmanagerbackend/CMakeLists.txt         | 2 +-
 src/tools/clangrefactoringbackend/source/CMakeLists.txt | 5 +----
 tests/unit/unittest/CMakeLists.txt                      | 8 ++++----
 8 files changed, 13 insertions(+), 16 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index f76ce0a1..effeb731 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -74,11 +74,11 @@ else()
 endif()
 install(TARGETS OptionalSvg EXPORT QtCreator)
 
-find_package(Clang COMPONENTS libclang QUIET)
+find_package(Clang COMPONENTS clang-cpp QUIET)
 # silence a lot of warnings from building against llvm
 # this would better fit inside a central libclang detection/include cmake file, but since we do not
 # have one put it temporary here
-if(MSVC AND TARGET libclang)
+if(MSVC AND TARGET clang-cpp)
     target_compile_options(libclang INTERFACE /wd4100 /wd4141 /wd4146 /wd4244 /wd4267 /wd4291)
 endif()
 find_package(LLVM QUIET)
diff --git a/src/plugins/clangcodemodel/CMakeLists.txt b/src/plugins/clangcodemodel/CMakeLists.txt
index 56ee6841..05b142bd 100644
--- a/src/plugins/clangcodemodel/CMakeLists.txt
+++ b/src/plugins/clangcodemodel/CMakeLists.txt
@@ -3,7 +3,7 @@ if (WITH_TESTS)
 endif()
 
 add_qtc_plugin(ClangCodeModel
-  CONDITION TARGET libclang
+  CONDITION TARGET clang-cpp
   DEPENDS ClangSupport CPlusPlus
   PLUGIN_DEPENDS Core CppTools TextEditor ${TST_COMPONENT}
   SOURCES
diff --git a/src/plugins/clangformat/CMakeLists.txt b/src/plugins/clangformat/CMakeLists.txt
index 3edaead7..610a8766 100644
--- a/src/plugins/clangformat/CMakeLists.txt
+++ b/src/plugins/clangformat/CMakeLists.txt
@@ -1,6 +1,6 @@
 add_qtc_plugin(ClangFormat
-  CONDITION TARGET libclang
-  DEPENDS Utils Qt5::Widgets clangFormat
+  CONDITION TARGET clang-cpp
+  DEPENDS Utils Qt5::Widgets clang-cpp LLVM
   INCLUDES "${CLANG_INCLUDE_DIRS}"
   PLUGIN_DEPENDS Core TextEditor CppEditor CppTools ProjectExplorer
   SOURCES
diff --git a/src/plugins/clangpchmanager/CMakeLists.txt b/src/plugins/clangpchmanager/CMakeLists.txt
index c1c9b29f..86403c41 100644
--- a/src/plugins/clangpchmanager/CMakeLists.txt
+++ b/src/plugins/clangpchmanager/CMakeLists.txt
@@ -1,6 +1,6 @@
 add_qtc_plugin(ClangPchManager
   BUILD_DEFAULT OFF
-  CONDITION TARGET libclang
+  CONDITION TARGET clang-cpp
   DEPENDS ClangSupport CPlusPlus
   DEFINES CLANGPCHMANAGER_LIB
   PLUGIN_DEPENDS Core CppTools
diff --git a/src/plugins/clangrefactoring/CMakeLists.txt b/src/plugins/clangrefactoring/CMakeLists.txt
index 95c926dc..621163c8 100644
--- a/src/plugins/clangrefactoring/CMakeLists.txt
+++ b/src/plugins/clangrefactoring/CMakeLists.txt
@@ -1,6 +1,6 @@
 add_qtc_plugin(ClangRefactoring
   BUILD_DEFAULT OFF
-  CONDITION TARGET libclang
+  CONDITION TARGET clang-cpp
   DEPENDS ClangSupport CPlusPlus
   PLUGIN_DEPENDS Core CppTools TextEditor ClangPchManager
   SOURCES ${TEST_SOURCES}
diff --git a/src/tools/clangpchmanagerbackend/CMakeLists.txt b/src/tools/clangpchmanagerbackend/CMakeLists.txt
index 965ef441..b49967bf 100644
--- a/src/tools/clangpchmanagerbackend/CMakeLists.txt
+++ b/src/tools/clangpchmanagerbackend/CMakeLists.txt
@@ -3,7 +3,7 @@ add_subdirectory(source)
 add_qtc_executable(clangpchmanagerbackend
   DEPENDS
     clangrefactoringbackend_lib clangpchmanagerbackend_lib
-    clangTooling libclang Sqlite ClangSupport clangQuery clangIndex
+    clang-cpp Sqlite
   SOURCES
     clangpchmanagerbackendmain.cpp
 )
diff --git a/src/tools/clangrefactoringbackend/source/CMakeLists.txt b/src/tools/clangrefactoringbackend/source/CMakeLists.txt
index f06ddee1..66c3e431 100644
--- a/src/tools/clangrefactoringbackend/source/CMakeLists.txt
+++ b/src/tools/clangrefactoringbackend/source/CMakeLists.txt
@@ -1,10 +1,7 @@
 add_qtc_library(clangrefactoringbackend_lib STATIC
   PUBLIC_DEPENDS
     Threads::Threads
-    LLVMCore libclang
-    clangAST clangASTMatchers clangBasic clangDynamicASTMatchers clangFrontend
-    clangHandleCXX clangIndex clangLex
-    clangSerialization clangTooling clangQuery
+    LLVM clang-cpp
     ClangSupport
   PUBLIC_DEFINES CLANGSUPPORT_BUILD_LIB
   PUBLIC_INCLUDES
diff --git a/tests/unit/unittest/CMakeLists.txt b/tests/unit/unittest/CMakeLists.txt
index 9ae0b9c9..69dc3440 100644
--- a/tests/unit/unittest/CMakeLists.txt
+++ b/tests/unit/unittest/CMakeLists.txt
@@ -202,7 +202,7 @@ string(REPLACE "$$dependencyList" "\"Dependencies\" : []" plugin_json_in ${plugi
 file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/CppTools.json" ${plugin_json_in}})
 
 extend_qtc_test(unittest
-  CONDITION TARGET libclang
+  CONDITION TARGET clang-cpp
   INCLUDES "${CLANG_INCLUDE_DIRS}"
   DEPENDS libclang
   SOURCES
@@ -260,9 +260,9 @@ extend_qtc_test(unittest
 )
 
 extend_qtc_test(unittest
-  CONDITION TARGET clangTooling
+  CONDITION TARGET clang-cpp
   DEFINES CLANG_UNIT_TESTS
-  DEPENDS clangTooling clangIndex clangQuery
+  DEPENDS clang-cpp LLVM
   SOURCES
     gtest-llvm-printing.cpp
     clangquerygatherer-test.cpp
@@ -286,7 +286,7 @@ extend_qtc_test(unittest
 )
 
 extend_qtc_test(unittest
-  CONDITION TARGET clangFormat
+  CONDITION TARGET clang-cpp
   DEPENDS clangFormat
   SOURCES
     clangformat-test.cpp
-- 
2.27.0

