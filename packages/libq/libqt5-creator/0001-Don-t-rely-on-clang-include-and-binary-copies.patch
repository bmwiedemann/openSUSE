From fc882219ffbd7372a463788791d7e2d69e0ed194 Mon Sep 17 00:00:00 2001
From: Christophe Giboudeaux <christophe@krop.fr>
Date: Thu, 1 Oct 2020 19:59:56 +0200
Subject: [PATCH] Don't rely on clang include and binary copies

The qtcreator build system contains a build target
disabled by default which copies the clang include
files and binaries into the qtcreator libexec subdir.

Instead, we'll use the openSUSE's clang locations
directly. This should fix boo#1176888 and work around
https://bugreports.qt.io/browse/QTCREATORBUG-24583 and
https://bugreports.qt.io/browse/QTCREATORBUG-21972.
---
 src/libs/clangsupport/CMakeLists.txt | 42 ++--------------------------
 1 file changed, 2 insertions(+), 40 deletions(-)

diff --git a/src/libs/clangsupport/CMakeLists.txt b/src/libs/clangsupport/CMakeLists.txt
index d1f38507..792566a3 100644
--- a/src/libs/clangsupport/CMakeLists.txt
+++ b/src/libs/clangsupport/CMakeLists.txt
@@ -5,8 +5,8 @@ add_qtc_library(ClangSupport
   PUBLIC_DEPENDS Utils Sqlite Qt5::Core Qt5::Network
   PUBLIC_DEFINES
     CLANG_VERSION="${CLANG_VERSION}"
-    CLANG_RESOURCE_DIR="${IDE_LIBEXEC_PATH}/clang/lib/clang/${CLANG_VERSION}/include"
-    CLANG_BINDIR="${IDE_LIBEXEC_PATH}/clang/bin"
+    CLANG_RESOURCE_DIR="${LLVM_LIBRARY_DIR}/clang/${CLANG_VERSION}/include"
+    CLANG_BINDIR="${LLVM_LIBRARY_DIR}/clang/${CLANG_VERSION}/bin"
   DEFINES CLANGSUPPORT_BUILD_LIB
   PUBLIC_INCLUDES
     "${CMAKE_CURRENT_LIST_DIR}"
@@ -146,41 +146,3 @@ add_qtc_library(ClangSupport
 if (NOT TARGET libclang)
   return()
 endif()
-
-# For the developer build directory
-qtc_copy_to_builddir(copy_clang_to_builddir
-  DIRECTORIES "${LLVM_LIBRARY_DIR}/clang/${CLANG_VERSION}/include"
-  DESTINATION "${IDE_LIBEXEC_PATH}/clang/lib/clang/${CLANG_VERSION}/include"
-)
-
-foreach(executable clang clang-cl clangd clang-tidy clazy-standalone)
-  if (EXISTS "${LLVM_TOOLS_BINARY_DIR}/${executable}${CMAKE_EXECUTABLE_SUFFIX}")
-    qtc_copy_to_builddir(copy_clang_${executable}_to_builddir
-      FILES "${LLVM_TOOLS_BINARY_DIR}/${executable}${CMAKE_EXECUTABLE_SUFFIX}"
-      DESTINATION "${IDE_LIBEXEC_PATH}/clang/bin/"
-    )
-    # For the install directory
-    install(PROGRAMS
-      "${LLVM_TOOLS_BINARY_DIR}/${executable}${CMAKE_EXECUTABLE_SUFFIX}"
-      DESTINATION "${IDE_LIBEXEC_PATH}/clang/bin"
-      COMPONENT Dependencies
-      EXCLUDE_FROM_ALL
-    )
-    if (IS_SYMLINK "${LLVM_TOOLS_BINARY_DIR}/${executable}${CMAKE_EXECUTABLE_SUFFIX}")
-      file(READ_SYMLINK
-        "${LLVM_TOOLS_BINARY_DIR}/${executable}${CMAKE_EXECUTABLE_SUFFIX}" real_executable)
-      install(PROGRAMS
-        "${LLVM_TOOLS_BINARY_DIR}/${real_executable}${CMAKE_EXECUTABLE_SUFFIX}"
-        DESTINATION "${IDE_LIBEXEC_PATH}/clang/bin"
-        COMPONENT Dependencies
-        EXCLUDE_FROM_ALL
-      )
-    endif()
-  endif()
-endforeach()
-
-install(DIRECTORY ${LLVM_LIBRARY_DIR}/clang/${CLANG_VERSION}/include
-  DESTINATION "${IDE_LIBEXEC_PATH}/clang/lib/clang/${CLANG_VERSION}"
-  COMPONENT Dependencies
-  EXCLUDE_FROM_ALL
-)
-- 
2.28.0

