#!/bin/bash
# Name: Deepin API polkit profiles installer
# Version: 1.0
# Description: On openSUSE, deepin-api does not install polkit profiles by default
# for security. The tool can help users to install these profiles for getting the
# full features of Deepin Desktop, if user do not care security.
# Author: Hillwood Yang <hillwood@opensuse.org>
# License: WTFPL-2.0

if [ "$(id -u)" != "0" ]; then
	echo "error: You must be root to use this program!"
	exit 1
fi

while :
do
    ANSWER=n
    echo "This is the Deepin API polkit profiles installer, it helps you to install the polkit \
profiles for Deepin API. These profiles will enable the full features for Deepin Desktop."
    echo "But hese polkit profiles are not accepted by SUSE security Team. Install these \
profiles will bring some security issues (boo#1070943 and boo#1136026). Are you sure that you install \
this files anyhow?[Yes/No]N"
    read ANSWER
    case $ANSWER in
        Y | y | yes | Yes)
            break;;
        N | n | no | No)
            break;;
        *)
            echo "Unknown response, please reinput";;
    esac
done

if [ "$ANSWER" = "n" ] || [ "$ANSWER" = "N" ] || [ "$ANSWER" = "no" ] || [ "$ANSWER" = "No" ]; then
    echo "Exit deepin-api-polkit installation."
    exit 1
fi

SYSTEM_TMP=/tmp
TMP_DIR=$SYSTEM_TMP/deepin-api-polkit

pushd /usr/share/polkit-1/actions/ &>/dev/null

    Filelist=&(ls com.deepin.api*) &>/dev/null

    if [ "$Filelist" != "" ]; then
        rm -rf "$Filelist"
    fi

popd &>/dev/null

mkdir -p $TMP_DIR

pushd $TMP_DIR &>/dev/null
    tar -xvf /usr/share/dde-api/polkit.tar.gz &>/dev/null
    cp polkit/* /usr/share/polkit-1/actions/
    chmod 0644 /usr/share/polkit-1/actions/com.deepin.api*
popd &>/dev/null

rm -rf $TMP_DIR

echo "Deepin API polkit profiles install succeed!"
