From cedbe540bdcfb5672f97763abb8cf1f79439ec4c Mon Sep 17 00:00:00 2001
From: Chen Bin <chenbin@uniontech.com>
Date: Tue, 3 Aug 2021 16:01:31 +0800
Subject: [PATCH] =?UTF-8?q?fix(=E6=89=93=E5=8D=B0=E9=A2=84=E8=A7=88):=20?=
 =?UTF-8?q?=E5=86=85=E9=83=A8=E6=8E=A7=E4=BB=B6=E7=9A=84=E9=81=AE=E7=9B=96?=
 =?UTF-8?q?=E5=AF=BC=E8=87=B4=E5=AF=B9=E8=AF=9D=E6=A1=86=E6=97=A0=E5=86=85?=
 =?UTF-8?q?=E5=AE=B9?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

打印预览为了隐藏对话框的模糊效果，使用一个不透明控件
遮挡。由于平板项目调整了DDialog控件布局，添加了一个背
景控件，导致打印预览的背景控件全部遮盖住所有内容。
将打印预览的背景控件调整到所有控件最底端解决此问题

调整打印预览部分布局代码，原代码使用背景控件遮盖标题栏
形成标题栏背景。这种做法不太妥当，这里调整为直接修改标
题栏调色板。

修复预览页面背景色不一致的问题：由于多种颜色有不透明度
的叠加，导致源颜色较深，这里调整目标颜色使背景颜色保持
一致。

Log: 打印预览UI问题修复
Change-Id: I3792a87cc3f8f56c163751d9e42d094e054a240b
---
 src/widgets/dprintpreviewdialog.cpp | 22 ++++++++++++----------
 src/widgets/dprintpreviewwidget.cpp |  4 ++--
 2 files changed, 14 insertions(+), 12 deletions(-)

diff --git a/src/widgets/dprintpreviewdialog.cpp b/src/widgets/dprintpreviewdialog.cpp
index a83d3370..07080399 100644
--- a/src/widgets/dprintpreviewdialog.cpp
+++ b/src/widgets/dprintpreviewdialog.cpp
@@ -18,6 +18,7 @@
 #include "dfilechooseredit.h"
 #include "dslider.h"
 #include "dtoolbutton.h"
+#include "dtitlebar.h"
 
 #include <DScrollArea>
 #include <DScrollBar>
@@ -112,18 +113,19 @@ void DPrintPreviewDialogPrivate::startup()
 void DPrintPreviewDialogPrivate::initui()
 {
     Q_Q(DPrintPreviewDialog);
+
     DWidget *mainWidget = new DWidget(q);
     mainWidget->setObjectName("mainwidget");
-
-    DWidget *titleWidget = new DWidget(q);
-    titleWidget->setObjectName("titlewidget");
-
     mainWidget->setAutoFillBackground(true);
+    mainWidget->lower();
 
-    DPalette pa = DPaletteHelper::instance()->palette(titleWidget);
+    DTitlebar *titlebar = q->findChild<DTitlebar *>();
+    Q_ASSERT(titlebar);
+    titlebar->setAutoFillBackground(true);
+
+    DPalette pa = DPaletteHelper::instance()->palette(titlebar);
     pa.setBrush(DPalette::Background, pa.base());
-    DPaletteHelper::instance()->setPalette(titleWidget, pa);
-    titleWidget->setAutoFillBackground(true);
+    DPaletteHelper::instance()->setPalette(titlebar, pa);
 
     QHBoxLayout *mainlayout = new QHBoxLayout();
     mainlayout->setContentsMargins(QMargins(0, 0, 0, 0));
@@ -2423,17 +2425,17 @@ void DPrintPreviewDialog::resizeEvent(QResizeEvent *event)
 {
     Q_UNUSED(event);
     Q_D(DPrintPreviewDialog);
-    this->findChild<DWidget *>("titlewidget")->setGeometry(0, 0, this->width(), 50);
+
     this->findChild<DWidget *>("mainwidget")->setGeometry(0, 0, this->width(), this->height());
     double per = static_cast<double>(this->width()) / static_cast<double>(851);
     if (per >= 1.2) {
         this->findChild<DWidget *>("rightWidget")->setMaximumWidth(452 * 1.2);
         this->findChild<DWidget *>("leftWidget")->setMaximumWidth(this->width() - 20 - 10 - 452 * 1.2);
-        this->findChild<DBackgroundGroup *>("backGround")->setItemSpacing(10);
+        d->back->setItemSpacing(10);
     } else {
         this->findChild<DWidget *>("rightWidget")->setMaximumWidth(452 * per);
         this->findChild<DWidget *>("leftWidget")->setMaximumWidth(this->width() - 20 - 2 - 452 * per);
-        this->findChild<DBackgroundGroup *>("backGround")->setItemSpacing(2);
+        d->back->setItemSpacing(2);
     }
 }
 
diff --git a/src/widgets/dprintpreviewwidget.cpp b/src/widgets/dprintpreviewwidget.cpp
index 49ddb001..115dd6ca 100644
--- a/src/widgets/dprintpreviewwidget.cpp
+++ b/src/widgets/dprintpreviewwidget.cpp
@@ -2015,9 +2015,9 @@ void DPrintPreviewWidget::themeTypeChanged(DGuiApplicationHelper::ColorType them
 {
     Q_D(DPrintPreviewWidget);
     if (DGuiApplicationHelper::DarkType == themeType)
-        d->scene->setBackgroundBrush(QColor(0, 0, 0, 3));
+        d->graphicsView->setBackgroundBrush(QColor(0, 0, 0, 42));
     else
-        d->scene->setBackgroundBrush(QColor(255, 255, 255, 5));
+        d->graphicsView->setBackgroundBrush(QColor(255, 255, 255, 120));
 }
 
 DPrinter::DPrinter(QPrinter::PrinterMode mode)
