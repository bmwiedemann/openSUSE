From 98bcabe35cf8ae4db9c4ae64542f7fa1fe6159a8 Mon Sep 17 00:00:00 2001
From: Christophe Giboudeaux <christophe@krop.fr>
Date: Fri, 25 May 2018 09:38:55 +0200
Subject: [PATCH] Fix build with Qt 5.11

---
 CMakeLists.txt       | 8 +++-----
 src/CMakeLists.txt   | 8 ++++++--
 tests/CMakeLists.txt | 1 -
 3 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7115d3a..8a768e4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -13,12 +13,13 @@ option(BUILD_WITH_QT4 "Build libechonest with Qt4 no matter if Qt5 was found" ON
 
 if( NOT BUILD_WITH_QT4 )
     find_package(Qt5Core QUIET)
+    if( Qt5Core_DIR )
     # CMAKE 2.8.13+/3.0.0+ requires these for IMPORTed targets
     find_package(Qt5Xml REQUIRED)
-    if( Qt5Core_DIR )
+    find_package(Qt5Network REQUIRED)
         message(STATUS "Found Qt5! Be aware that Qt5-support is still experimental and not officially supported!")
         set(ECHONEST_LIB_VERSION_SUFFIX 5)
-
+        include_directories(${Qt5Core_INCLUDE_DIRS} ${Qt5Network_INCLUDE_DIRS})
         macro(qt_wrap_cpp)
             qt5_wrap_cpp(${ARGN})
         endmacro()
@@ -39,9 +40,6 @@ if( NOT Qt5Core_DIR )
     endif()
     include( ${QT_USE_FILE} )
 
-    macro(qt5_use_modules)
-    endmacro()
-
     macro(qt_wrap_cpp)
         qt4_wrap_cpp(${ARGN})
     endmacro()
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 4b8835c..1b8f97c 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -45,9 +45,13 @@ set( LIBECHONEST_H
 QT_WRAP_CPP( ${LIBECHONEST_H} )
 
 add_library( ${ECHONEST_LIB_TARGET_NAME} SHARED ${LIBECHONEST_SRC} )
-target_link_libraries( ${ECHONEST_LIB_TARGET_NAME} ${QT_QTCORE_LIBRARY} ${QT_QTNETWORK_LIBRARY} ${QJSON_LIBRARIES} )
+if(BUILD_WITH_QT4)
+  target_link_libraries( ${ECHONEST_LIB_TARGET_NAME} ${QT_QTCORE_LIBRARY} ${QT_QTNETWORK_LIBRARY} ${QJSON_LIBRARIES} )
+else()
+  target_link_libraries( ${ECHONEST_LIB_TARGET_NAME} ${Qt5Core_LIBRARIES} ${Qt5Network_LIBRARIES} )
+endif()
+
 set_target_properties( ${ECHONEST_LIB_TARGET_NAME} PROPERTIES VERSION ${ECHONEST_LIB_VERSION} SOVERSION ${ECHONEST_LIB_VERSION_SONAME} )
-qt5_use_modules( ${ECHONEST_LIB_TARGET_NAME} Core Network Xml )
 install( TARGETS ${ECHONEST_LIB_TARGET_NAME}   RUNTIME DESTINATION bin
                             LIBRARY DESTINATION lib${LIB_SUFFIX}
                             ARCHIVE DESTINATION lib${LIB_SUFFIX}
diff --git a/tests/CMakeLists.txt b/tests/CMakeLists.txt
index 91d70db..368f3d2 100644
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -17,7 +17,6 @@ macro(add_echonest_test _source)
     add_executable(${_name} ${_source})
     target_link_libraries(${_name} ${ECHONEST_LIB_TARGET_NAME} ${QT_QTCORE_LIBRARY} ${QT_QTTEST_LIBRARY} ${QTCORE_QTNETWORK_LIBRARY} ${QT_QTXML_LIBRARY} ${QJSON_LIBRARIES} )
     add_test(${_name}-test ${EXECUTABLE_OUTPUT_PATH}/${_name})
-    qt5_use_modules(${_name} Network Test)
 endmacro(add_echonest_test)
 
 add_echonest_test( ArtistTest.cpp )
-- 
2.17.0

