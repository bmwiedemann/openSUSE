From 3b12260597d17ad582a23c3d8183de85dcbb64c9 Mon Sep 17 00:00:00 2001
From: Biswapriyo Nath <nathbappai@gmail.com>
Date: Fri, 17 Nov 2023 20:44:41 +0530
Subject: [PATCH] CMake: Add sload_f2fs tool

---
 vendor/CMakeLists.f2fstools.txt | 52 +++++++++++++++++++++++++++++----
 vendor/CMakeLists.txt           |  1 +
 3 files changed, 50 insertions(+), 5 deletions(-)

diff --git a/vendor/CMakeLists.f2fstools.txt b/vendor/CMakeLists.f2fstools.txt
index 152cc37..7fdf640 100644
--- a/vendor/CMakeLists.f2fstools.txt
+++ b/vendor/CMakeLists.f2fstools.txt
@@ -1,6 +1,13 @@
 # SPDX-License-Identifier: Apache-2.0
 # CMakeLists.f2fstools.txt: CMake file for f2fs-tools directory
 
+set(f2fs_tools_defaults
+	-DF2FS_MAJOR_VERSION=1
+	-DF2FS_MINOR_VERSION=16
+	-DF2FS_TOOLS_VERSION="1.16.0"
+	-DF2FS_TOOLS_DATE="2023-04-11"
+	-DWITH_ANDROID)
+
 add_library(libf2fs STATIC
 	f2fs-tools/lib/libf2fs.c
 	f2fs-tools/mkfs/f2fs_format.c
@@ -9,11 +16,7 @@ add_library(libf2fs STATIC
 	f2fs-tools/lib/nls_utf8.c)
 
 target_compile_definitions(libf2fs PUBLIC
-	-DF2FS_MAJOR_VERSION=1
-	-DF2FS_MINOR_VERSION=16
-	-DF2FS_TOOLS_VERSION="1.16.0"
-	-DF2FS_TOOLS_DATE="2023-04-11"
-	-DWITH_ANDROID
+	${f2fs_tools_defaults}
 	-DWITH_BLKDISCARD)
 
 target_include_directories(libf2fs PUBLIC
@@ -29,3 +32,42 @@ add_executable(make_f2fs
 
 target_link_libraries(make_f2fs PRIVATE
 	libf2fs libsparse z)
+
+set(fsck_main_src_files
+	f2fs-tools/fsck/dir.c
+	f2fs-tools/fsck/dict.c
+	f2fs-tools/fsck/mkquota.c
+	f2fs-tools/fsck/quotaio.c
+	f2fs-tools/fsck/quotaio_tree.c
+	f2fs-tools/fsck/quotaio_v2.c
+	f2fs-tools/fsck/node.c
+	f2fs-tools/fsck/segment.c
+	f2fs-tools/fsck/xattr.c
+	f2fs-tools/fsck/main.c
+	f2fs-tools/fsck/mount.c
+	f2fs-tools/lib/libf2fs.c
+	f2fs-tools/lib/libf2fs_io.c
+	f2fs-tools/lib/libf2fs_zoned.c
+	f2fs-tools/lib/nls_utf8.c
+	f2fs-tools/fsck/dump.c)
+
+add_executable(sload_f2fs
+	${fsck_main_src_files}
+	f2fs-tools/fsck/fsck.c
+	f2fs-tools/fsck/sload.c
+	f2fs-tools/fsck/compress.c)
+
+target_compile_definitions(sload_f2fs PRIVATE
+	${f2fs_tools_defaults}
+	-DWITH_SLOAD)
+
+target_include_directories(sload_f2fs PRIVATE
+	f2fs-tools/include
+	selinux/libselinux/include
+	core/libsparse/include
+	core/libcutils/include)
+
+target_link_libraries(sload_f2fs PRIVATE
+	libsparse libselinux libcutils z
+	PkgConfig::libpcre2-8
+	PkgConfig::liblz4)
diff --git a/vendor/CMakeLists.txt b/vendor/CMakeLists.txt
index 6690dd9..0b6d0aa 100644
--- a/vendor/CMakeLists.txt
+++ b/vendor/CMakeLists.txt
@@ -109,6 +109,7 @@ install(TARGETS
 	lpmake
 	lpunpack
 	make_f2fs
+	sload_f2fs
 	simg2img
 	e2fsdroid
 	ext2simg
