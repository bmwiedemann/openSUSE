From 5646b46b9635cd8641a6a44669dc80fa4007baa9 Mon Sep 17 00:00:00 2001
From: Jaroslav Kysela <perex@perex.cz>
Date: Tue, 16 Jun 2020 13:40:21 +0200
Subject: [PATCH 07/51] cht-bsw-rt5672: merge all possible configurations to
 HiFi.conf

Signed-off-by: Jaroslav Kysela <perex@perex.cz>
---
 ucm2/cht-bsw-rt5672/HiFi-stereo-dmic2.conf         |  27 -----
 ucm2/cht-bsw-rt5672/HiFi.conf                      | 115 +++++++++++++++++++--
 .../LENOVO-20BN002QGE-ThinkPad8-20BN002QGE.conf    |   1 -
 .../LENOVO-20BN002QGE-ThinkPad8.conf               |   1 -
 .../cht-bsw-rt5672-stereo-dmic2.conf               |   6 --
 5 files changed, 107 insertions(+), 43 deletions(-)
 delete mode 100644 ucm2/cht-bsw-rt5672/HiFi-stereo-dmic2.conf
 delete mode 120000 ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8-20BN002QGE.conf
 delete mode 120000 ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8.conf
 delete mode 100644 ucm2/cht-bsw-rt5672/cht-bsw-rt5672-stereo-dmic2.conf

diff --git a/ucm2/cht-bsw-rt5672/HiFi-stereo-dmic2.conf b/ucm2/cht-bsw-rt5672/HiFi-stereo-dmic2.conf
deleted file mode 100644
index 0d95e902b6ef..000000000000
--- a/ucm2/cht-bsw-rt5672/HiFi-stereo-dmic2.conf
+++ /dev/null
@@ -1,27 +0,0 @@
-# Adapted from https://github.com/plbossart/UCM/tree/master/cht-bsw-rt5672
-
-SectionVerb {
-	Include.e.File "/codecs/rt5672/EnableSeq.conf"
-
-	If.Controls {
-		Condition {
-			Type ControlExists
-			Control "name='media0_in Gain 0 Switch'"
-		}
-		Before.EnableSequence "0"
-		True {
-			Include.pe.File "/platforms/bytcr/PlatformEnableSeq.conf"
-			Include.pd.File "/platforms/bytcr/PlatformDisableSeq.conf"
-		}
-	}
-}
-
-Include.spk.File "/codecs/rt5672/Speaker.conf"
-RenameDevice."Speaker1" "Speaker"
-RemoveDevice."Speaker2" "Speaker2"
-Include.hp.File "/codecs/rt5672/HeadPhones.conf"
-
-Include.dmic.File "/codecs/rt5672/DMIC2.conf"
-RenameDevice."Mic2" "Mic"
-RemoveDevice."Mic1" "Mic1"
-Include.hsmic.File "/codecs/rt5672/HeadsetMic.conf"
diff --git a/ucm2/cht-bsw-rt5672/HiFi.conf b/ucm2/cht-bsw-rt5672/HiFi.conf
index 39cb0fe125cd..394e45d39ace 100644
--- a/ucm2/cht-bsw-rt5672/HiFi.conf
+++ b/ucm2/cht-bsw-rt5672/HiFi.conf
@@ -1,7 +1,37 @@
 # Adapted from https://github.com/plbossart/UCM/tree/master/cht-bsw-rt5672
 
-SectionVerb {
+Define.Speaker "yes"
+Define.Headphones "yes"
+Define.MonoSpeaker "yes"
+Define.DigitalMic1 "yes"
+Define.DigitalMic2 "yes"
+Define.HeadsetMic "yes"
+
+If.cfg-dmic1 {
+	Condition {
+		Type Regex
+		String "${CardLongName}"
+		Regex "(SoMeThInK1)" # fixme!
+	}
+	True {
+		Define.MonoSpeaker ""
+		Define.DigitalMic2 ""
+	}
+}
+
+If.cfg-dmic2 {
+	Condition {
+		Type Regex
+		String "${CardLongName}"
+		Regex "(LENOVO.*ThinkPad8)"
+	}
+	True {
+		Define.MonoSpeaker ""
+		Define.DigitalMic1 ""
+	}
+}
 
+SectionVerb {
 	Include.e.File "/codecs/rt5672/EnableSeq.conf"
 
 	If.Controls {
@@ -10,14 +40,83 @@ SectionVerb {
 			Control "name='media0_in Gain 0 Switch'"
 		}
 		Before.EnableSequence "0"
-		True.Include.pe.File "/platforms/bytcr/PlatformEnableSeq.conf"
+		True {
+			Include.pe.File "/platforms/bytcr/PlatformEnableSeq.conf"
+			Include.pd.File "/platforms/bytcr/PlatformDisableSeq.conf"
+		}
+	}
+}
+
+If.spk {
+	Condition {
+		Type String
+		Empty "${var:Speaker}"
+	}
+	False.Include.spk.File "/codecs/rt5672/Speaker.conf"
+}
+
+If.mspk {
+	Condition {
+		Type String
+		Empty "${var:MonoSpeaker}"
+	}
+	True {
+		RenameDevice."Speaker1" "Speaker"
+		RemoveDevice."Speaker2" "Speaker2"
+	}
+	False.Include.mspk.File "/codecs/rt5672/MonoSpeaker.conf"
+}
+
+If.hp {
+	Condition {
+		Type String
+		Empty "${var:Headphones}"
+	}
+	#True.RemoveDevice."Headphones" "Headphones"
+	False.Include.hp.File "/codecs/rt5672/HeadPhones.conf"
+}
+
+If.dmic1 {
+	Condition {
+		Type String
+		Empty "${var:DigitalMic1}"
+	}
+	True.RemoveDevice."Mic1" "Mic1"
+	False {
+		Include.dmic1.File "/codecs/rt5672/DMIC1.conf"
+		If.dmic2 {
+			Condition {
+				Type "String"
+				Empty "${var:DigitalMic2}"
+			}
+			True.RenameDevice."Mic1" "Mic"
+		}
 	}
 }
 
-Include.spk.File "/codecs/rt5672/Speaker.conf"
-Include.mspk.File "/codecs/rt5672/MonoSpeaker.conf"
-Include.hp.File "/codecs/rt5672/HeadPhones.conf"
+If.dmic2 {
+	Condition {
+		Type String
+		Empty "${var:DigitalMic2}"
+	}
+	True.RemoveDevice."Mic2" "Mic2"
+	False {
+		Include.dmic2.File "/codecs/rt5672/DMIC2.conf"
+		If.dmic1 {
+			Condition {
+				Type "String"
+				Empty "${var:DigitalMic1}"
+			}
+			True.RenameDevice."Mic2" "Mic"
+		}
+	}
+}
 
-Include.dmic1.File "/codecs/rt5672/DMIC1.conf"
-Include.dmic2.File "/codecs/rt5672/DMIC2.conf"
-Include.hsmic.File "/codecs/rt5672/HeadsetMic.conf"
+If.hsmic {
+	Condition {
+		Type String
+		Empty "${var:HeadsetMic}"
+	}
+	#True.RemoveDevice."Headset" "Headset"
+	False.Include.hsmic.File "/codecs/rt5672/HeadsetMic.conf"
+}
diff --git a/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8-20BN002QGE.conf b/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8-20BN002QGE.conf
deleted file mode 120000
index 461f0c442ffa..000000000000
--- a/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8-20BN002QGE.conf
+++ /dev/null
@@ -1 +0,0 @@
-cht-bsw-rt5672-stereo-dmic2.conf
\ No newline at end of file
diff --git a/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8.conf b/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8.conf
deleted file mode 120000
index 461f0c442ffa..000000000000
--- a/ucm2/cht-bsw-rt5672/LENOVO-20BN002QGE-ThinkPad8.conf
+++ /dev/null
@@ -1 +0,0 @@
-cht-bsw-rt5672-stereo-dmic2.conf
\ No newline at end of file
diff --git a/ucm2/cht-bsw-rt5672/cht-bsw-rt5672-stereo-dmic2.conf b/ucm2/cht-bsw-rt5672/cht-bsw-rt5672-stereo-dmic2.conf
deleted file mode 100644
index e793e9d99a0f..000000000000
--- a/ucm2/cht-bsw-rt5672/cht-bsw-rt5672-stereo-dmic2.conf
+++ /dev/null
@@ -1,6 +0,0 @@
-Syntax 3
-
-SectionUseCase."HiFi" {
-	File "HiFi-stereo-dmic2.conf"
-	Comment "Play HiFi quality Music"
-}
-- 
2.16.4

