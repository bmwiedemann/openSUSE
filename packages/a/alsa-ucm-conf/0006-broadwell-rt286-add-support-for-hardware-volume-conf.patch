From be86627a9f4179979d208943bb497b10dfc679cb Mon Sep 17 00:00:00 2001
From: Jaroslav Kysela <perex@perex.cz>
Date: Tue, 10 Dec 2019 17:08:37 +0100
Subject: [PATCH 6/6] broadwell-rt286: add support for hardware volume,
 conformance fixes

Signed-off-by: Jaroslav Kysela <perex@perex.cz>
---
 ucm2/broadwell-rt286/HiFi.conf | 90 ++++++++++++++++++++----------------------
 1 file changed, 43 insertions(+), 47 deletions(-)

diff --git a/ucm2/broadwell-rt286/HiFi.conf b/ucm2/broadwell-rt286/HiFi.conf
index 6cf31e75ace4..e766250dfac8 100644
--- a/ucm2/broadwell-rt286/HiFi.conf
+++ b/ucm2/broadwell-rt286/HiFi.conf
@@ -1,13 +1,31 @@
 # Use case Configuration for Nexus 7
 # Adapted to Ubuntu Touch by David Henningsson <david.henningsson@canonical.com>
 
-SectionVerb {
+SectionDevice."Speaker" {
+	Comment "Speaker playback"
+
+	ConflictingDevice [
+		"Headphones"
+	]
+
+	EnableSequence [
+		cset "name='SPO Switch' on"
+		cset "name='Speaker Playback Switch' on"
+		cset "name='Speaker Switch' on"
+	]
+
+	DisableSequence [
+		cset "name='Speaker Switch' off"
+		cset "name='Speaker Playback Switch' off"
+		cset "name='SPO Switch' 0"
+	]
 
-	# ALSA PCM
 	Value {
-		# ALSA PCM device for HiFi
+		Priority 100
 		PlaybackPCM "hw:${CardId}"
-		CapturePCM "hw:${CardId}"
+		PlaybackChannels 2
+		PlaybackMixerElem "DAC0"
+		PlaybackMasterElem "Master"
 	}
 }
 
@@ -19,11 +37,9 @@ SectionDevice."Headphones" {
 	]
 
 	EnableSequence [
-		cset "name='Master Playback Volume' 30"
 		cset "name='HPO L Switch' on"
 		cset "name='HPO R Switch' on"
 		cset "name='Headphone Jack Switch' on"
-		cset "name='DAC0 Playback Volume' 100"
 	]
 
 	DisableSequence [
@@ -33,36 +49,38 @@ SectionDevice."Headphones" {
 	]
 
 	Value {
-		PlaybackChannels "2"
+		Priority 200
+		PlaybackPCM "hw:${CardId}"
+		PlaybackChannels 2
+		PlaybackMixerElem "DAC0"
+		PlaybackMasterElem "Master"
 		JackDev "rt286-jack"
 		JackControl "Headphone Jack"
 		JackHWMute "Speaker"
 	}
 }
 
-SectionDevice."Speaker" {
-	Comment "Speaker playback"
+SectionDevice."Mic" {
+	Comment "Microphone"
 
 	ConflictingDevice [
-		"Headphones"
+		"Handset"
 	]
 
 	EnableSequence [
-		cset "name='Master Playback Volume' 30"
-		cset "name='DAC0 Playback Volume' 127"
-		cset "name='SPO Switch' on"
-		cset "name='Speaker Playback Switch' on"
-		cset "name='Speaker Switch' on"
+		cset "name='ADC 0 Mux' 2"
 	]
 
 	DisableSequence [
-		cset "name='Speaker Switch' off"
-		cset "name='Speaker Playback Switch' off"
-		cset "name='SPO Switch' 0"
+		cset "name='ADC0 Capture Switch' off"
 	]
 
 	Value {
-		PlaybackChannels "2"
+		Priority 100
+		CapturePCM "hw:${CardId}"
+		CaptureChannels "2"
+		CaptureMixerElem "Mic"
+		CaptureMasterElem "ADC0"
 	}
 }
 
@@ -70,14 +88,11 @@ SectionDevice."Handset" {
 	Comment "Handset Microphone"
 
 	ConflictingDevice [
-		"Mainmic"
+		"Mic"
 	]
 
 	EnableSequence [
-		cset "name='Mic Capture Volume' 28"
 		cset "name='ADC 0 Mux' 0"
-		cset "name='ADC0 Capture Switch' on"
-		cset "name='ADC0 Capture Volume' 127"
 		cset "name='AMIC Volume' 1"
 	]
 
@@ -86,32 +101,13 @@ SectionDevice."Handset" {
 	]
 
 	Value {
+		Priority 200
+		CapturePCM "hw:${CardId}"
 		CaptureChannels "2"
+		CaptureMixerElem "Mic"
+		CaptureMasterElem "ADC0"
 		JackDev "rt286-jack"
 		JackControl "Mic Jack"
-		JackHWMute "Mainmic"
-	}
-}
-
-SectionDevice."Mainmic" {
-	Comment "Main Microphone"
-
-	ConflictingDevice [
-		"Handset"
-	]
-
-	EnableSequence [
-		cset "name='Mic Capture Volume' 30"
-		cset "name='ADC 0 Mux' 2"
-		cset "name='ADC0 Capture Switch' on"
-		cset "name='ADC0 Capture Volume' 127"
-	]
-
-	DisableSequence [
-		cset "name='ADC0 Capture Switch' off"
-	]
-
-	Value {
-		CaptureChannels "2"
+		JackHWMute "Mic"
 	}
 }
-- 
2.16.4

