From edd79a6d1c4ac3283b6816d795fe6d975e5af5e3 Mon Sep 17 00:00:00 2001
From: Aleksa Sarai <cyphar@cyphar.com>
Date: Thu, 22 May 2025 18:42:54 +1000
Subject: [PATCH] incusd/forkproxy: join the correct mntns for listen

This was a copy-paste error introduced in commit 4494bad12c57
("incusd/main_forkproxy: Join all namespaces at once"). The net result
was that container-binding proxy devices with a unix listener would be
in the wrong mount namespace and the unix socket would accidentally be
created on the host.

Fixes: 4494bad12c57 ("incusd/main_forkproxy: Join all namespaces at once")
Signed-off-by: Aleksa Sarai <cyphar@cyphar.com>
---
 cmd/incusd/main_forkproxy.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/cmd/incusd/main_forkproxy.go b/cmd/incusd/main_forkproxy.go
index 71880714bcc3..9e3c6ead2fec 100644
--- a/cmd/incusd/main_forkproxy.go
+++ b/cmd/incusd/main_forkproxy.go
@@ -141,7 +141,7 @@ void forkproxy(void)
 		if (in_same_namespace(getpid(), listen_nsfd, "user") > 0)
 			setns_flags |= CLONE_NEWUSER;
 
-		if (needs_mntns & CONNECT_NEEDS_MNTNS)
+		if (needs_mntns & LISTEN_NEEDS_MNTNS)
 			setns_flags |= CLONE_NEWNS;
 
 		if (!change_namespaces(listen_pidfd, listen_nsfd, setns_flags)) {
-- 
2.49.0

