From 38ab51da7131d780fcc68331e49c92cd95171fe9 Mon Sep 17 00:00:00 2001
From: "Bernhard M. Wiedemann" <bwiedemann@suse.de>
Date: Sun, 19 Nov 2023 15:28:06 +0100
Subject: [PATCH] [build] Use a deterministic serial number in sdsk

The new serial number is based on the content hash.

Without this patch, ipxe.sdsk varied in the random 4-byte serial number
stored by mformat at offset 0x27.

This patch was done while working on reproducible builds for openSUSE.

Signed-off-by: Bernhard M. Wiedemann <bwiedemann@suse.de>
---
 src/util/genfsimg | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/util/genfsimg b/src/util/genfsimg
index 0c0692793a..0da655b328 100755
--- a/src/util/genfsimg
+++ b/src/util/genfsimg
@@ -269,6 +269,7 @@ if [ -n "${FATIMG}" ] ; then
 	FATSIZE=$(( FATCYLS * 504 ))
 	FATARGS="-s 63 -h 16 -t ${FATCYLS}"
     fi
+    FATARGS="${FATARGS} -N 0x$(sha1sum "${FATDIR}"/* | cut -c 1-40 | sha1sum | cut -c 1-8)"
     truncate -s "${FATSIZE}K" "${FATIMG}"
     mformat -v iPXE -i "${FATIMG}" ${FATARGS} ::
     mcopy -i "${FATIMG}" -s "${FATDIR}"/* ::
