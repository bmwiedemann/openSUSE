Index: src/lib/grab.c
===================================================================
--- src/lib/grab.c.orig
+++ src/lib/grab.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
@@ -9,6 +13,7 @@
 
 #include "grab.h"
 #include "ximage.h"
+#include <byteswap.h>
 
 static char         _x_err = 0;
 static DATA8        rtab[256], gtab[256], btab[256];
@@ -53,14 +58,8 @@ __imlib_GrabXImageToRGBA(DATA32 * data,
    if ((depth == 24) && (xim->bits_per_pixel == 32))
       depth = 25;               /* fake depth meaning 24 bit in 32 bpp ximage */
    /* data needs swapping */
-#define SWAP32(x) (x) = \
-   ((((int)(x) & 0x000000ff ) << 24) |\
-       (((int)(x) & 0x0000ff00 ) << 8) |\
-       (((int)(x) & 0x00ff0000 ) >> 8) |\
-       (((int)(x) & 0xff000000 ) >> 24))
-#define SWAP16(x) (x) = \
-   ((((short)(x) & 0x00ff ) << 8) |\
-       (((short)(x) & 0xff00 ) >> 8))
+#define SWAP32(x) (x) = (bswap_32(x))
+#define SWAP16(x) (x) = (bswap_16(x))
 
 #ifdef WORDS_BIGENDIAN
    if (xim->bitmap_bit_order == LSBFirst)
Index: src/modules/loaders/loader_argb.c
===================================================================
--- src/modules/loaders/loader_argb.c.orig
+++ src/modules/loaders/loader_argb.c
@@ -1,10 +1,10 @@
-#include "loader_common.h"
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
 
-#define SWAP32(x) (x) = \
-((((x) & 0x000000ff ) << 24) |\
- (((x) & 0x0000ff00 ) << 8) |\
- (((x) & 0x00ff0000 ) >> 8) |\
- (((x) & 0xff000000 ) >> 24))
+#include "loader_common.h"
+#include <byteswap.h>
+#define SWAP32(x) (x) = (bswap_32(x))
 
 char
 load(ImlibImage * im, ImlibProgressFunction progress,
Index: configure.ac
===================================================================
--- configure.ac.orig
+++ configure.ac
@@ -11,7 +11,9 @@ AM_INIT_AUTOMAKE(1.6 dist-bzip2)
 m4_ifdef([AM_SILENT_RULES], [AM_SILENT_RULES([yes])])
 
 AC_C_BIGENDIAN
-AC_PROG_CC
+AC_PROG_CC_STDC
+AC_USE_SYSTEM_EXTENSIONS
+AC_SYS_LARGEFILE
 AM_PROG_AS
 
 AC_HEADER_STDC
Index: src/lib/blend.c
===================================================================
--- src/lib/blend.c.orig
+++ src/lib/blend.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/color.c
===================================================================
--- src/lib/color.c.orig
+++ src/lib/color.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/lib/color_helpers.c
===================================================================
--- src/lib/color_helpers.c.orig
+++ src/lib/color_helpers.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "color_helpers.h"
 /*
  * Color space conversion helper routines
Index: src/lib/colormod.c
===================================================================
--- src/lib/colormod.c.orig
+++ src/lib/colormod.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <math.h>
Index: src/lib/context.c
===================================================================
--- src/lib/context.c.orig
+++ src/lib/context.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/lib/draw.c
===================================================================
--- src/lib/draw.c.orig
+++ src/lib/draw.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/lib/dynamic_filters.c
===================================================================
--- src/lib/dynamic_filters.c.orig
+++ src/lib/dynamic_filters.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <ctype.h>
Index: src/lib/ellipse.c
===================================================================
--- src/lib/ellipse.c.orig
+++ src/lib/ellipse.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/file.c
===================================================================
--- src/lib/file.c.orig
+++ src/lib/file.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <ctype.h>
Index: src/lib/filter.c
===================================================================
--- src/lib/filter.c.orig
+++ src/lib/filter.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/grad.c
===================================================================
--- src/lib/grad.c.orig
+++ src/lib/grad.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <math.h>
Index: src/lib/image.c
===================================================================
--- src/lib/image.c.orig
+++ src/lib/image.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <ctype.h>
Index: src/lib/line.c
===================================================================
--- src/lib/line.c.orig
+++ src/lib/line.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/polygon.c
===================================================================
--- src/lib/polygon.c.orig
+++ src/lib/polygon.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/rectangle.c
===================================================================
--- src/lib/rectangle.c.orig
+++ src/lib/rectangle.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/rend.c
===================================================================
--- src/lib/rend.c.orig
+++ src/lib/rend.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/lib/rgba.c
===================================================================
--- src/lib/rgba.c.orig
+++ src/lib/rgba.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/lib/rgbadraw.c
===================================================================
--- src/lib/rgbadraw.c.orig
+++ src/lib/rgbadraw.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <math.h>
Index: src/lib/rotate.c
===================================================================
--- src/lib/rotate.c.orig
+++ src/lib/rotate.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/scale.c
===================================================================
--- src/lib/scale.c.orig
+++ src/lib/scale.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <assert.h>
Index: src/lib/script.c
===================================================================
--- src/lib/script.c.orig
+++ src/lib/script.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include <ctype.h>
Index: src/lib/span.c
===================================================================
--- src/lib/span.c.orig
+++ src/lib/span.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "blend.h"
Index: src/lib/updates.c
===================================================================
--- src/lib/updates.c.orig
+++ src/lib/updates.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 
 #include "updates.h"
Index: src/lib/ximage.c
===================================================================
--- src/lib/ximage.c.orig
+++ src/lib/ximage.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "common.h"
 #ifdef BUILD_X11
 #include <X11/Xlib.h>
Index: src/modules/filters/filter_bumpmap.c
===================================================================
--- src/modules/filters/filter_bumpmap.c.orig
+++ src/modules/filters/filter_bumpmap.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "filter_common.h"
 #include <string.h>
 #include <math.h>
Index: src/modules/filters/filter_colormod.c
===================================================================
--- src/modules/filters/filter_colormod.c.orig
+++ src/modules/filters/filter_colormod.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "filter_common.h"
 #include <string.h>
 #include <math.h>
Index: src/modules/filters/filter_test.c
===================================================================
--- src/modules/filters/filter_test.c.orig
+++ src/modules/filters/filter_test.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "filter_common.h"
 #include <string.h>
 #include <Imlib2.h>
Index: src/modules/loaders/loader_bmp.c
===================================================================
--- src/modules/loaders/loader_bmp.c.orig
+++ src/modules/loaders/loader_bmp.c
@@ -8,6 +8,10 @@
  * - Simplify and make secure RLE encoding
  * - Fix 16 and 32 bit depth (old code was incorrect and it's commented) 
  */
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <sys/stat.h>
 
Index: src/modules/loaders/loader_bz2.c
===================================================================
--- src/modules/loaders/loader_bz2.c.orig
+++ src/modules/loaders/loader_bz2.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <bzlib.h>
 #include <sys/types.h>
Index: src/modules/loaders/loader_gif.c
===================================================================
--- src/modules/loaders/loader_gif.c.orig
+++ src/modules/loaders/loader_gif.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <sys/types.h>
 #include <sys/stat.h>
Index: src/modules/loaders/loader_id3.c
===================================================================
--- src/modules/loaders/loader_id3.c.orig
+++ src/modules/loaders/loader_id3.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <sys/types.h>
 #include <sys/stat.h>
Index: src/modules/loaders/loader_jpeg.c
===================================================================
--- src/modules/loaders/loader_jpeg.c.orig
+++ src/modules/loaders/loader_jpeg.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <jpeglib.h>
 #include <setjmp.h>
Index: src/modules/loaders/loader_lbm.c
===================================================================
--- src/modules/loaders/loader_lbm.c.orig
+++ src/modules/loaders/loader_lbm.c
@@ -11,6 +11,10 @@
  * Version: 2004-08-28
  *------------------------------------------------------------------------------*/
 
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 
 #define L2RLONG(a) ((((long)((a)[0]) & 0xff) << 24) + (((long)((a)[1]) & 0xff) << 16) + (((long)((a)[2]) & 0xff) << 8) + ((long)((a)[3]) & 0xff))
Index: src/modules/loaders/loader_png.c
===================================================================
--- src/modules/loaders/loader_png.c.orig
+++ src/modules/loaders/loader_png.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <png.h>
 
Index: src/modules/loaders/loader_pnm.c
===================================================================
--- src/modules/loaders/loader_pnm.c.orig
+++ src/modules/loaders/loader_pnm.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <ctype.h>
 
Index: src/modules/loaders/loader_tga.c
===================================================================
--- src/modules/loaders/loader_tga.c.orig
+++ src/modules/loaders/loader_tga.c
@@ -9,6 +9,10 @@
  *
  * header/footer structures courtesy of the GIMP Targa plugin 
  */
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <fcntl.h>
 #include <stdint.h>
Index: src/modules/loaders/loader_tiff.c
===================================================================
--- src/modules/loaders/loader_tiff.c.orig
+++ src/modules/loaders/loader_tiff.c
@@ -1,6 +1,10 @@
 /* To do: */
 /* o Need code to handle tiff with different orientations */
 
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <setjmp.h>
 #include <stdarg.h>
Index: src/modules/loaders/loader_xpm.c
===================================================================
--- src/modules/loaders/loader_xpm.c.orig
+++ src/modules/loaders/loader_xpm.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <sys/types.h>
 #include <sys/stat.h>
Index: src/modules/loaders/loader_zlib.c
===================================================================
--- src/modules/loaders/loader_zlib.c.orig
+++ src/modules/loaders/loader_zlib.c
@@ -1,3 +1,7 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #include "loader_common.h"
 #include <zlib.h>
 #include <sys/types.h>
