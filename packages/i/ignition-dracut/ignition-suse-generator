#!/bin/bash
# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# ex: ts=8 sw=4 sts=4 et filetype=sh

set -e

UNIT_DIR="${1:-/tmp}"

add_requires() {
    local name="$1"; shift
    local requires_dir="${UNIT_DIR}/ignition-files.service.requires"
    mkdir -p "${requires_dir}"
    ln -sf "../${name}" "${requires_dir}/${name}"
}

add_requires ignition-mount-initrd-fstab.service

# Overwrite static /boot dependency by upstream igniton-dracut with a more
# generic "ignition" device to fetch the user configuration; can not be put
# into UNIT_DIR, as systemd generators are running simultaneously, so use a
# directory with a higher priority. May still be overwritten by the admin by
# putting the same file into /etc.
mkdir -p "/run/systemd/system/ignition-setup-user.service.d"
cat > "/run/systemd/system/ignition-setup-user.service.d/diskful.conf" <<EOF
[Unit]
Wants=dev-disk-by\x2dlabel-ignition.device
After=dev-disk-by\x2dlabel-ignition.device

[Service]
ExecStart=
ExecStart=/usr/sbin/ignition-setup-user-suse
EOF
