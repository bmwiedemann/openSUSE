From 62257d7249e9db616bcea7eb0cec632e3d5cd6dc Mon Sep 17 00:00:00 2001
From: Christian Goll <cgoll@suse.de>
Date: Thu, 17 Dec 2020 11:14:27 +0100
Subject: [PATCH] removed clog build as included in cpuinfo

---
 tensorflow/tools/pip_package/BUILD |  1 -
 tensorflow/workspace.bzl           |  2 --
 third_party/clog/BUILD             |  1 -
 third_party/clog/BUILD.bazel       | 55 ------------------------------
 third_party/clog/workspace.bzl     | 15 --------
 third_party/cpuinfo/BUILD.bazel    | 31 ++++++++++++++++-
 6 files changed, 30 insertions(+), 75 deletions(-)
 delete mode 100644 third_party/clog/BUILD
 delete mode 100644 third_party/clog/BUILD.bazel
 delete mode 100644 third_party/clog/workspace.bzl

diff --git a/tensorflow/tools/pip_package/BUILD b/tensorflow/tools/pip_package/BUILD
index 553312fb111..3dbd2aff8d7 100644
--- a/tensorflow/tools/pip_package/BUILD
+++ b/tensorflow/tools/pip_package/BUILD
@@ -220,7 +220,6 @@ filegroup(
         "@termcolor_archive//:COPYING.txt",
         "@typing_extensions_archive//:LICENSE",
         "@zlib//:zlib.h",
-        "@clog//:LICENSE",
         "@cpuinfo//:LICENSE",
     ] + select({
         "//tensorflow:android": [],
diff --git a/tensorflow/workspace.bzl b/tensorflow/workspace.bzl
index 39e80e1d07f..dfdfa7af72d 100755
--- a/tensorflow/workspace.bzl
+++ b/tensorflow/workspace.bzl
@@ -22,7 +22,6 @@ load(
 )
 load("//third_party/FP16:workspace.bzl", FP16 = "repo")
 load("//third_party/aws:workspace.bzl", aws = "repo")
-load("//third_party/clog:workspace.bzl", clog = "repo")
 load("//third_party/cpuinfo:workspace.bzl", cpuinfo = "repo")
 load("//third_party/dlpack:workspace.bzl", dlpack = "repo")
 load("//third_party/flatbuffers:workspace.bzl", flatbuffers = "repo")
@@ -45,7 +44,6 @@ def initialize_third_party():
     """ Load third party repositories.  See above load() statements. """
     FP16()
     aws()
-    clog()
     cpuinfo()
     dlpack()
     flatbuffers()
diff --git a/third_party/clog/BUILD b/third_party/clog/BUILD
deleted file mode 100644
index 82bab3ffd96..00000000000
--- a/third_party/clog/BUILD
+++ /dev/null
@@ -1 +0,0 @@
-# This empty BUILD file is required to make Bazel treat this directory as a package.
diff --git a/third_party/clog/BUILD.bazel b/third_party/clog/BUILD.bazel
deleted file mode 100644
index e1d59304299..00000000000
--- a/third_party/clog/BUILD.bazel
+++ /dev/null
@@ -1,55 +0,0 @@
-# Description:
-#   C-style (a-la printf) logging library
-
-package(default_visibility = ["//visibility:public"])
-
-licenses(["notice"])
-
-exports_files(["LICENSE"])
-
-cc_library(
-    name = "clog",
-    srcs = [
-        "deps/clog/src/clog.c",
-    ],
-    hdrs = [
-        "deps/clog/include/clog.h",
-    ],
-    copts = select({
-        ":windows": [],
-        "//conditions:default": ["-Wno-unused-result"],
-    }),
-    defines = select({
-        # When linkstatic=False, we need default visibility
-        ":macos_x86_64": ["CLOG_VISIBILITY="],
-        "//conditions:default": [],
-    }),
-    linkopts = select({
-        ":android": ["-llog"],
-        "//conditions:default": [],
-    }),
-    linkstatic = select({
-        # https://github.com/bazelbuild/bazel/issues/11552
-        ":macos_x86_64": False,
-        "//conditions:default": True,
-    }),
-    strip_include_prefix = "deps/clog/include",
-)
-
-config_setting(
-    name = "android",
-    values = {"crosstool_top": "//external:android/crosstool"},
-)
-
-config_setting(
-    name = "windows",
-    values = {"cpu": "x64_windows"},
-)
-
-config_setting(
-    name = "macos_x86_64",
-    values = {
-        "apple_platform_type": "macos",
-        "cpu": "darwin",
-    },
-)
diff --git a/third_party/clog/workspace.bzl b/third_party/clog/workspace.bzl
deleted file mode 100644
index 05b29805328..00000000000
--- a/third_party/clog/workspace.bzl
+++ /dev/null
@@ -1,15 +0,0 @@
-"""Loads the clog library, used by cpuinfo and XNNPACK."""
-
-load("//third_party:repo.bzl", "third_party_http_archive")
-
-def repo():
-    third_party_http_archive(
-        name = "clog",
-        strip_prefix = "cpuinfo-d5e37adf1406cf899d7d9ec1d317c47506ccb970",
-        sha256 = "3f2dc1970f397a0e59db72f9fca6ff144b216895c1d606f6c94a507c1e53a025",
-        urls = [
-            "https://storage.googleapis.com/mirror.tensorflow.org/github.com/pytorch/cpuinfo/archive/d5e37adf1406cf899d7d9ec1d317c47506ccb970.tar.gz",
-            "https://github.com/pytorch/cpuinfo/archive/d5e37adf1406cf899d7d9ec1d317c47506ccb970.tar.gz",
-        ],
-        build_file = "//third_party/clog:BUILD.bazel",
-    )
diff --git a/third_party/cpuinfo/BUILD.bazel b/third_party/cpuinfo/BUILD.bazel
index 9b007cc0daa..09e0ad309e9 100644
--- a/third_party/cpuinfo/BUILD.bazel
+++ b/third_party/cpuinfo/BUILD.bazel
@@ -152,7 +152,7 @@ cc_library(
         "src/arm/midr.h",
     ],
     deps = [
-        "@clog",
+        ":cpuinfo_clog",
     ],
 )
 
@@ -177,6 +177,35 @@ cc_library(
     ],
 )
 
+cc_library(
+    name = "cpuinfo_clog",
+    srcs = [
+        "deps/clog/src/clog.c",
+    ],
+    hdrs = [
+        "deps/clog/include/clog.h",
+    ],
+    copts = select({
+        ":windows_x86_64": [],
+        "//conditions:default": ["-Wno-unused-result"],
+    }),
+    defines = select({
+        # When linkstatic=False, we need default visibility
+        ":macos_x86_64": ["CLOG_VISIBILITY="],
+        "//conditions:default": [],
+    }),
+    linkopts = select({
+        ":android_arm64": ["-llog"],
+        "//conditions:default": [],
+    }),
+    linkstatic = select({
+        # https://github.com/bazelbuild/bazel/issues/11552
+        ":macos_x86_64": False,
+        "//conditions:default": True,
+    }),
+    strip_include_prefix = "deps/clog/include",
+)
+
 ############################# Build configurations #############################
 
 config_setting(
-- 
2.26.2

