From 4cfdad9d9b8344d9f871dba7a0201d54d1565833 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jaime=20Marqui=CC=81nez=20Ferra=CC=81ndiz?=
 <jaime.marquinez.ferrandiz@fastmail.net>
Date: Fri, 25 Feb 2022 17:42:27 +0100
Subject: [PATCH] Disable the JIT tests on arm architectures
Upstream: submitted
References: gh#HaxeFoundation/hashlink#521

---
 CMakeLists.txt | 25 ++++++++++++++++---------
 1 file changed, 16 insertions(+), 9 deletions(-)

Index: hashlink-1.14/CMakeLists.txt
===================================================================
--- hashlink-1.14.orig/CMakeLists.txt
+++ hashlink-1.14/CMakeLists.txt
@@ -194,41 +194,48 @@ if(BUILD_TESTING)
         haxe
     )
 
-    #####################
-    # hello.hl
-
-    add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
-        COMMAND ${HAXE_COMPILER}
-            -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
-            -cp ${CMAKE_SOURCE_DIR}/other/tests -main HelloWorld
-    )
-    add_custom_target(hello.hl ALL
-        DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
-    )
-
-    #####################
-    # threads.hl
-
-    add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
-        COMMAND ${HAXE_COMPILER}
-            -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
-            -cp ${CMAKE_SOURCE_DIR}/other/tests -main Threads
-    )
-    add_custom_target(threads.hl ALL
-        DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
-    )
-
-    #####################
-    # uvsample.hl
-
-    add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
-        COMMAND ${HAXE_COMPILER}
-            -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
-            -cp ${CMAKE_SOURCE_DIR}/other/uvsample -main UVSample
-    )
-    add_custom_target(uvsample.hl ALL
-        DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
-    )
+    set(JIT_TEST_ENABLED TRUE)
+    if(CMAKE_SYSTEM_PROCESSOR MATCHES "arm|aarch64")
+        set(JIT_TEST_ENABLED FALSE)
+    endif()
+
+    if(JIT_TEST_ENABLED)
+        #####################
+        # hello.hl
+
+        add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
+            COMMAND ${HAXE_COMPILER}
+                -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
+                -cp ${CMAKE_SOURCE_DIR}/other/tests -main HelloWorld
+        )
+        add_custom_target(hello.hl ALL
+            DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
+        )
+
+        #####################
+        # threads.hl
+
+        add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
+            COMMAND ${HAXE_COMPILER}
+                -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
+                -cp ${CMAKE_SOURCE_DIR}/other/tests -main Threads
+        )
+        add_custom_target(threads.hl ALL
+            DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
+        )
+
+        #####################
+        # uvsample.hl
+
+        add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
+            COMMAND ${HAXE_COMPILER}
+                -hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
+                -cp ${CMAKE_SOURCE_DIR}/other/uvsample -main UVSample
+        )
+        add_custom_target(uvsample.hl ALL
+            DEPENDS ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl
+        )
+    ENDIF(JIT_TEST_ENABLED)
 
     #####################
     # hello.c
@@ -300,15 +307,17 @@ if(BUILD_TESTING)
     #####################
     # Tests
 
-    add_test(NAME hello.hl
-        COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
-    )
-    add_test(NAME threads.hl
-        COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
-    )
-    add_test(NAME uvsample.hl
-        COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl 6001
-    )
+    IF(JIT_TEST_ENABLED)
+        add_test(NAME hello.hl
+            COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/hello.hl
+        )
+        add_test(NAME threads.hl
+            COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/threads.hl
+        )
+        add_test(NAME uvsample.hl
+            COMMAND hl ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/test/uvsample.hl 6001
+        )
+    ENDIF(JIT_TEST_ENABLED)
     add_test(NAME hello
         COMMAND hello
     )
