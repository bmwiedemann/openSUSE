From 4db2b356ad7bc7d39ed4550fa55ba58fb73db7a0 Mon Sep 17 00:00:00 2001
From: Dario Faggioli <dfaggioli@suse.com>
Date: Wed, 28 Sep 2022 19:03:04 +0200
Subject: [PATCH] Do not set soname, as this is a plugin

Signed-off-by: Dario Faggioli <dfaggioli@suse.com>
---
 Makefile | 20 ++++----------------
 1 file changed, 4 insertions(+), 16 deletions(-)

diff --git a/Makefile b/Makefile
index 0460b7f..f1b26d5 100644
--- a/Makefile
+++ b/Makefile
@@ -12,13 +12,9 @@ endif
 
 OS = $(shell uname -s)
 
-KRUN_BINARY_Linux = libkrun$(VARIANT).so.$(FULL_VERSION)
-KRUN_SONAME_Linux = libkrun$(VARIANT).so.$(ABI_VERSION)
-KRUN_BASE_Linux = libkrun$(VARIANT).so
+KRUN_BINARY_Linux = libkrun$(VARIANT).so
 
 KRUN_BINARY_Darwin = libkrun.$(FULL_VERSION).dylib
-KRUN_SONAME_Darwin = libkrun.$(ABI_VERSION).dylib
-KRUN_BASE_Darwin = libkrun.dylib
 
 LIBRARY_RELEASE_Linux = target/release/$(KRUN_BINARY_Linux)
 LIBRARY_DEBUG_Linux = target/debug/$(KRUN_BINARY_Linux)
@@ -44,23 +40,16 @@ $(INIT_BINARY): init/init.c
 $(LIBRARY_RELEASE_$(OS)): $(INIT_BINARY)
 	cargo build --release $(FEATURE_FLAGS)
 ifeq ($(SEV),1)
-	mv target/release/libkrun.so target/release/$(KRUN_BASE_$(OS))
+	mv target/release/libkrun.so $(LIBRARY_RELEASE_$(OS))
 endif
 ifeq ($(OS),Linux)
-	patchelf --set-soname $(KRUN_SONAME_$(OS)) --output $(LIBRARY_RELEASE_$(OS)) target/release/$(KRUN_BASE_$(OS))
-else
-	cp target/release/$(KRUN_BASE_$(OS)) $(LIBRARY_RELEASE_$(OS))
+	strip $(LIBRARY_RELEASE_$(OS))
 endif
 
 $(LIBRARY_DEBUG_$(OS)): $(INIT_BINARY)
 	cargo build $(FEATURE_FLAGS)
 ifeq ($(SEV),1)
-	mv target/debug/libkrun.so target/debug/$(KRUN_BASE_$(OS))
-endif
-ifeq ($(OS),Linux)
-	patchelf --set-soname $(KRUN_SONAME_$(OS)) --output $(LIBRARY_DEBUG_$(OS)) target/debug/$(KRUN_BASE_$(OS))
-else
-	cp target/debug/$(KRUN_BASE_$(OS)) $(LIBRARY_DEBUG_$(OS))
+	mv target/debug/libkrun.so $(LIBRARY_DEBUG_$(OS))
 endif
 
 install:
@@ -68,7 +57,6 @@ install:
 	install -d $(DESTDIR)$(PREFIX)/include
 	install -m 644 $(LIBRARY_HEADER) $(DESTDIR)$(PREFIX)/include
 	install -m 755 $(LIBRARY_RELEASE_$(OS)) $(DESTDIR)$(PREFIX)/$(LIBDIR_$(OS))/
-	cd $(DESTDIR)$(PREFIX)/$(LIBDIR_$(OS))/ ; ln -sf $(KRUN_BINARY_$(OS)) $(KRUN_SONAME_$(OS)) ; ln -sf $(KRUN_SONAME_$(OS)) $(KRUN_BASE_$(OS))
 
 clean:
 	rm -f $(INIT_BINARY)
-- 
2.37.3

