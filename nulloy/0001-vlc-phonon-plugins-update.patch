From fc10f2d746c58e8fecb52319d1209a49e1cf8aa9 Mon Sep 17 00:00:00 2001
From: Sergey Vlasov <sergey@vlasov.me>
Date: Tue, 7 May 2019 11:39:24 +0000
Subject: [PATCH] vlc & phonon plugins update

---
 configure                                   | 19 +++++++++++--------
 src/main.cpp                                |  4 ++++
 src/plugins/phonon/containerPhonon.cpp      |  3 ---
 src/plugins/phonon/containerPhonon.h        |  1 +
 src/plugins/phonon/playbackEnginePhonon.cpp |  4 ++--
 src/plugins/phonon/playbackEnginePhonon.h   |  2 +-
 src/plugins/phonon/pluginPhonon.pro         |  2 +-
 src/plugins/vlc/containerVlc.cpp            |  3 ---
 src/plugins/vlc/containerVlc.h              |  1 +
 src/plugins/vlc/playbackEngineVlc.cpp       |  2 +-
 src/plugins/vlc/playbackEngineVlc.h         |  2 +-
 11 files changed, 23 insertions(+), 20 deletions(-)

diff --git a/configure b/configure
index a4583f4..645d280 100755
--- a/configure
+++ b/configure
@@ -117,18 +117,21 @@ echo "PKG_CONFIG = $PKG_CONFIG" >> $QMAKE_CACHE
 [[ -n "$LDFLAGS" ]]  && echo "QMAKE_LFLAGS += ${LDFLAGS}"    >> $QMAKE_CACHE
 
 pkg_check_lib() {
-    if $PKG_CONFIG --print-errors $1; then
-        echo "Found $1"
-    else
-        echo
-        exit 1
-    fi
+    for P in $@; do
+        if $PKG_CONFIG --print-errors $1; then
+            echo "Found $1"
+        else
+            echo
+            exit 1
+        fi
+        shift
+    done
 }
 [[ $BUILD_GSTREAMER == "yes" ]]           && pkg_check_lib gstreamer-1.0
 [[ $BUILD_GSTREAMER_TAGREADER == "yes" ]] && pkg_check_lib gstreamer-pbutils-1.0
-[[ $BUILD_VLC == "yes" ]]                 && pkg_check_lib libvlc
+[[ $BUILD_VLC == "yes" ]]                 && pkg_check_lib libvlc vlc-plugin
 [[ $BUILD_TAGLIB == "yes" ]]              && pkg_check_lib taglib
-[[ $BUILD_PHONON == "yes" ]]              && pkg_check_lib phonon
+[[ $BUILD_PHONON == "yes" ]]              && pkg_check_lib phonon4qt5
 
 [[ $BUILD_GSTREAMER == "yes" ]]           && echo "CONFIG += gstreamer" >> $QMAKE_CACHE
 [[ $BUILD_GSTREAMER_TAGREADER == "yes" ]] && echo "CONFIG += gstreamer-tagreader" >> $QMAKE_CACHE
diff --git a/src/main.cpp b/src/main.cpp
index 414d619..bcb13d9 100644
--- a/src/main.cpp
+++ b/src/main.cpp
@@ -60,11 +60,15 @@ static void print_try()
 
 void messageHandler(QtMsgType type, const QMessageLogContext &context, const QString &msg)
 {
+    Q_UNUSED(context);
     print_err(msg);
 
     if (logToFile) {
         QString prefix;
         switch (type) {
+            case QtInfoMsg:
+                prefix = "Info";
+                break;
             case QtDebugMsg:
                 prefix = "Debug";
                 break;
diff --git a/src/plugins/phonon/containerPhonon.cpp b/src/plugins/phonon/containerPhonon.cpp
index 7a6c387..efb65ba 100644
--- a/src/plugins/phonon/containerPhonon.cpp
+++ b/src/plugins/phonon/containerPhonon.cpp
@@ -33,6 +33,3 @@ QList<NPlugin *> NContainerPhonon::plugins() const
 {
     return m_plugins;
 }
-
-Q_EXPORT_PLUGIN2(plugin_phonon, NContainerPhonon)
-
diff --git a/src/plugins/phonon/containerPhonon.h b/src/plugins/phonon/containerPhonon.h
index bd2abfc..12416bf 100644
--- a/src/plugins/phonon/containerPhonon.h
+++ b/src/plugins/phonon/containerPhonon.h
@@ -22,6 +22,7 @@ class NContainerPhonon : public QObject, public NPluginContainer
 {
     Q_OBJECT
     Q_INTERFACES(NPluginContainer)
+    Q_PLUGIN_METADATA(IID "com.nulloy.NContainerPhonon")
 
 private:
     QList<NPlugin *> m_plugins;
diff --git a/src/plugins/phonon/playbackEnginePhonon.cpp b/src/plugins/phonon/playbackEnginePhonon.cpp
index fc4a893..55094ed 100644
--- a/src/plugins/phonon/playbackEnginePhonon.cpp
+++ b/src/plugins/phonon/playbackEnginePhonon.cpp
@@ -58,13 +58,13 @@ void NPlaybackEnginePhonon::setMedia(const QString &file)
         return;
 
     if (!QFile(file).exists()) {
-        emit message(N::MessageBox::Warning, file, "No such file or directory");
+        emit message(N::Warning, file, "No such file or directory");
         emit mediaChanged("");
         emit failed();
         return;
     }
 
-    m_mediaObject->setCurrentSource(Phonon::MediaSource(file));
+    m_mediaObject->setCurrentSource(Phonon::MediaSource(QUrl::fromLocalFile(file)));
 
     emit mediaChanged(file);
 }
diff --git a/src/plugins/phonon/playbackEnginePhonon.h b/src/plugins/phonon/playbackEnginePhonon.h
index 1cd911b..0c04951 100644
--- a/src/plugins/phonon/playbackEnginePhonon.h
+++ b/src/plugins/phonon/playbackEnginePhonon.h
@@ -65,7 +65,7 @@ private slots:
 signals:
     void positionChanged(qreal pos);
     void volumeChanged(qreal volume);
-    void message(N::MessageBox::Icon icon, const QString &title, const QString &msg);
+    void message(N::MessageIcon icon, const QString &title, const QString &msg);
     void mediaChanged(const QString &file);
     void finished();
     void failed();
diff --git a/src/plugins/phonon/pluginPhonon.pro b/src/plugins/phonon/pluginPhonon.pro
index 859c4e3..3c9fac9 100644
--- a/src/plugins/phonon/pluginPhonon.pro
+++ b/src/plugins/phonon/pluginPhonon.pro
@@ -3,7 +3,7 @@ win32:TARGET = PluginPhonon
 
 include(../plugin.pri)
 
-QT += phonon
+QT += phonon4qt5
 
 HEADERS += *.h
 SOURCES += *.cpp
diff --git a/src/plugins/vlc/containerVlc.cpp b/src/plugins/vlc/containerVlc.cpp
index a39117b..98b0ca3 100644
--- a/src/plugins/vlc/containerVlc.cpp
+++ b/src/plugins/vlc/containerVlc.cpp
@@ -33,6 +33,3 @@ QList<NPlugin *> NContainerVlc::plugins() const
 {
     return m_plugins;
 }
-
-Q_EXPORT_PLUGIN2(plugin_vlc, NContainerVlc)
-
diff --git a/src/plugins/vlc/containerVlc.h b/src/plugins/vlc/containerVlc.h
index 26955ac..f9459af 100644
--- a/src/plugins/vlc/containerVlc.h
+++ b/src/plugins/vlc/containerVlc.h
@@ -22,6 +22,7 @@ class NContainerVlc : public QObject, public NPluginContainer
 {
     Q_OBJECT
     Q_INTERFACES(NPluginContainer)
+    Q_PLUGIN_METADATA(IID "com.nulloy.NContainerVlc")
 
 private:
     QList<NPlugin *> m_plugins;
diff --git a/src/plugins/vlc/playbackEngineVlc.cpp b/src/plugins/vlc/playbackEngineVlc.cpp
index 599962a..697703b 100644
--- a/src/plugins/vlc/playbackEngineVlc.cpp
+++ b/src/plugins/vlc/playbackEngineVlc.cpp
@@ -88,7 +88,7 @@ void NPlaybackEngineVlc::setMedia(const QString &file)
         return;
 
     if (!QFile(file).exists()) {
-        emit message(N::MessageBox::Warning, file, "No such file or directory");
+        emit message(N::Warning, file, "No such file or directory");
         emit mediaChanged("");
         emit failed();
         return;
diff --git a/src/plugins/vlc/playbackEngineVlc.h b/src/plugins/vlc/playbackEngineVlc.h
index a252293..9f81e45 100644
--- a/src/plugins/vlc/playbackEngineVlc.h
+++ b/src/plugins/vlc/playbackEngineVlc.h
@@ -71,7 +71,7 @@ private slots:
 signals:
     void positionChanged(qreal pos);
     void volumeChanged(qreal volume);
-    void message(N::MessageBox::Icon icon, const QString &title, const QString &msg);
+    void message(N::MessageIcon icon, const QString &title, const QString &msg);
     void mediaChanged(const QString &file);
     void finished();
     void failed();
-- 
2.16.4

