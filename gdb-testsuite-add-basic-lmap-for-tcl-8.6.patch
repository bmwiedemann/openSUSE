From f54470964a1781c0e5a92b5ff2f1979a79b4a4b1 Mon Sep 17 00:00:00 2001
From: Tom de Vries <tdevries@suse.de>
Date: Mon, 24 Apr 2023 14:48:06 +0200
Subject: [PATCH 1/9] [gdb/testsuite] Add basic lmap for tcl < 8.6

With test-case gdb.dwarf2/dw2-abs-hi-pc.exp and tcl 8.5, I run into:
...
ERROR: tcl error sourcing gdb/testsuite/gdb.dwarf2/dw2-abs-hi-pc.exp.
ERROR: invalid command name "lmap"
    while executing
"::gdb_tcl_unknown lmap i {dw2-abs-hi-pc.c dw2-abs-hi-pc-hello.c \
  dw2-abs-hi-pc-world.c} { expr { "$srcdir/$subdir/$i" } }"
...

Fix this by adding basic lmap support for tcl version < 8.6.

Tested on x86_64-linux.
---
 gdb/testsuite/gdb.testsuite/lmap.exp | 20 ++++++++++++++++++++
 gdb/testsuite/lib/gdb.exp            | 15 +++++++++++++++
 2 files changed, 35 insertions(+)
 create mode 100644 gdb/testsuite/gdb.testsuite/lmap.exp

diff --git a/gdb/testsuite/gdb.testsuite/lmap.exp b/gdb/testsuite/gdb.testsuite/lmap.exp
new file mode 100644
index 00000000000..501e18bdd92
--- /dev/null
+++ b/gdb/testsuite/gdb.testsuite/lmap.exp
@@ -0,0 +1,20 @@
+# Copyright 2023 Free Software Foundation, Inc.
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+set one 1
+set l1 { $one 2 }
+set res1 [lmap item $l1 {expr $item + 1}]
+gdb_assert { [lindex $res1 0] == 2 }
+gdb_assert { [lindex $res1 1] == 3 }
+gdb_assert { $item == 2 }
diff --git a/gdb/testsuite/lib/gdb.exp b/gdb/testsuite/lib/gdb.exp
index b6e30204371..0b8a15f61cb 100644
--- a/gdb/testsuite/lib/gdb.exp
+++ b/gdb/testsuite/lib/gdb.exp
@@ -1524,6 +1524,21 @@ if { [tcl_version_at_least 8 5] == 0 } {
     }
 }
 
+if { [tcl_version_at_least 8 6] == 0 } {
+    # lmap was added in tcl 8.6.  Only add if missing.
+
+    # Note that we only implement the simple variant for now.
+    proc lmap { varname list body } {
+	set res {}
+	foreach val $list {
+	    uplevel 1 "set $varname $val"
+	    lappend res [uplevel 1 $body]
+	}
+
+	return $res
+    }
+}
+
 # gdb_test_no_output [-prompt PROMPT_REGEXP] [-nopass] COMMAND [MESSAGE]
 # Send a command to GDB and verify that this command generated no output.
 #

base-commit: fdf0253385db9239c44ea5a4ec879eeeae12fca1
-- 
2.35.3

