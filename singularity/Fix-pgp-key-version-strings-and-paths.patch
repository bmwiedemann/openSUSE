From: Egbert Eich <eich@suse.com>
Date: Sat Jul 20 20:18:44 2019 +0200
Subject: Fix pgp key, version strings and paths
Patch-mainline: Not yet
Git-commit: 8ac7056c81a54971a8d92ed998762c57b1d217d7
References: 

Signed-off-by: Egbert Eich <eich@suse.com>
---
 .../internal/pkg/build/sources/conveyorPacker_zypper.go        | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)
diff --git a/src/github.com/sylabs/singularity/internal/pkg/build/sources/conveyorPacker_zypper.go b/src/github.com/sylabs/singularity/internal/pkg/build/sources/conveyorPacker_zypper.go
index b8aef97..ffb085b 100644
--- a/src/github.com/sylabs/singularity/internal/pkg/build/sources/conveyorPacker_zypper.go
+++ b/src/github.com/sylabs/singularity/internal/pkg/build/sources/conveyorPacker_zypper.go
@@ -144,7 +144,7 @@ func (cp *ZypperConveyorPacker) Get(b *types.Bundle) (err error) {
 			return fmt.Errorf("Cannot convert minor version string to integer: %v", err)
 		}
 		if len(array) > 1 && tmp > 0 {
-			osservicepack = array[1]
+			osservicepack = "." + array[1]
 		}
 		if mirrorurl_ok {
 			mirrorurl = regex.ReplaceAllString(mirrorurl, osmajor + osservicepack)
@@ -173,7 +173,7 @@ func (cp *ZypperConveyorPacker) Get(b *types.Bundle) (err error) {
 			}
 			pgpfile = tmpfile.Name();
 
-			if _, err = tmpfile.WriteString(slepgp); err != nil {
+			if _, err = tmpfile.WriteString(slepgp + "\n"); err != nil {
 				return fmt.Errorf("Cannot write pgp-file: %v\n", err)
 			}
 		        if err = tmpfile.Close(); err != nil {
@@ -245,16 +245,16 @@ func (cp *ZypperConveyorPacker) Get(b *types.Bundle) (err error) {
 				rpmsys = "/usr/lib/sysimage"
 				rpmrel = "../../.."
 		}
-		if err = os.MkdirAll(cp.b.Rootfs() + rpmbase + `rpm`, 0755); err != nil {
+		if err = os.MkdirAll(cp.b.Rootfs() + rpmbase + `/rpm`, 0755); err != nil {
 			return fmt.Errorf("Cannot recreate rpm directories: %v\n", err)
 		}
 		if err = os.MkdirAll(cp.b.Rootfs() + rpmsys, 0755); err != nil {
 			return fmt.Errorf("Cannot recreate rpm directories: %v\n", err)
 		}
-		if err = os.RemoveAll(cp.b.Rootfs() + rpmsys + `rpm`); err != nil {
+		if err = os.RemoveAll(cp.b.Rootfs() + rpmsys + `/rpm`); err != nil {
 			return fmt.Errorf("Cannot remove rpm directory")
 		}
-		if err = os.Symlink(rpmrel + rpmbase, cp.b.Rootfs() + rpmsys + `rpm`); err != nil {
+		if err = os.Symlink(rpmrel + rpmbase + `/rpm`, cp.b.Rootfs() + rpmsys + `/rpm`); err != nil {
 			return fmt.Errorf("Cannot create rpm symlink")
 		}
 		cmd := exec.Command("rpmkeys", `--root`, cp.b.Rootfs(), `--import`, pgpfile)
